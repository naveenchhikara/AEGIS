---
phase: 14-verification-production-readiness
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - playwright.config.ts
  - tests/auth.setup.ts
  - tests/e2e/observation-lifecycle.spec.ts
  - .gitignore
  - package.json
autonomous: true

must_haves:
  truths:
    - "Playwright is installed and configured for Next.js dev server"
    - "Auth setup creates authenticated browser states for auditor, manager, CAE, and auditee roles"
    - "Observation lifecycle E2E tests cover the 9 test groups from Phase 6 plan 06-07"
    - "Tests can be run with a single command (pnpm test:e2e)"
  artifacts:
    - path: "playwright.config.ts"
      provides: "Playwright configuration with auth setup project and webServer"
      contains: "defineConfig"
    - path: "tests/auth.setup.ts"
      provides: "Authentication state setup for 4 roles"
      contains: "storageState"
    - path: "tests/e2e/observation-lifecycle.spec.ts"
      provides: "E2E tests for 9 observation lifecycle test groups"
      contains: "test.describe"
  key_links:
    - from: "playwright.config.ts"
      to: "tests/auth.setup.ts"
      via: "setup project testMatch"
      pattern: "setup.*testMatch"
    - from: "tests/e2e/observation-lifecycle.spec.ts"
      to: "playwright/.auth/*.json"
      via: "storageState usage"
      pattern: "storageState"
    - from: "playwright.config.ts"
      to: "pnpm dev"
      via: "webServer command"
      pattern: "webServer"
---

<objective>
Set up Playwright E2E testing infrastructure and create observation lifecycle tests covering all 9 test groups from Phase 6 plan 06-07.

Purpose: Phase 6 included a human-verify checkpoint (06-07) with 9 manual test groups that were deferred. This plan automates those tests with Playwright, creating reusable auth state management and E2E test patterns for the project.

Output: Working Playwright config, auth setup for 4 roles, and comprehensive observation lifecycle test suite.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/06-observation-lifecycle/06-07-PLAN.md
@.planning/phases/06-observation-lifecycle/06-05-SUMMARY.md
@.planning/phases/06-observation-lifecycle/06-06-SUMMARY.md
@.planning/phases/14-verification-production-readiness/14-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install and configure Playwright with auth state management</name>
  <files>playwright.config.ts, tests/auth.setup.ts, .gitignore, package.json</files>
  <action>
**Step 1: Install Playwright**

```bash
pnpm add -D @playwright/test
pnpm exec playwright install chromium
```

Only install chromium browser (not all browsers) to keep install fast. This is sufficient for E2E verification.

**Step 2: Create playwright.config.ts** in project root:

```typescript
import { defineConfig, devices } from "@playwright/test";

export default defineConfig({
  testDir: "./tests",
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: "html",

  use: {
    baseURL: "http://127.0.0.1:3000",
    trace: "on-first-retry",
  },

  projects: [
    // Auth setup runs once before all tests
    { name: "setup", testMatch: /.*\.setup\.ts/ },

    // Auditor tests (default role)
    {
      name: "auditor",
      use: {
        ...devices["Desktop Chrome"],
        storageState: "playwright/.auth/auditor.json",
      },
      dependencies: ["setup"],
    },

    // Manager tests
    {
      name: "manager",
      use: {
        ...devices["Desktop Chrome"],
        storageState: "playwright/.auth/manager.json",
      },
      dependencies: ["setup"],
    },

    // CAE tests
    {
      name: "cae",
      use: {
        ...devices["Desktop Chrome"],
        storageState: "playwright/.auth/cae.json",
      },
      dependencies: ["setup"],
    },

    // Auditee tests
    {
      name: "auditee",
      use: {
        ...devices["Desktop Chrome"],
        storageState: "playwright/.auth/auditee.json",
      },
      dependencies: ["setup"],
    },
  ],

  webServer: {
    command: "pnpm dev",
    url: "http://127.0.0.1:3000",
    reuseExistingServer: !process.env.CI,
    timeout: 120 * 1000,
  },
});
```

**Step 3: Create tests/auth.setup.ts** with 4 role authentications:

```typescript
import { test as setup, expect } from "@playwright/test";

// Demo user credentials from seed data
const users = [
  {
    role: "auditor",
    email: "rajesh@apexsahakari.in",
    file: "playwright/.auth/auditor.json",
  },
  {
    role: "manager",
    email: "priya@apexsahakari.in",
    file: "playwright/.auth/manager.json",
  },
  {
    role: "cae",
    email: "sunil@apexsahakari.in",
    file: "playwright/.auth/cae.json",
  },
  {
    role: "auditee",
    email: "vikram@apexsahakari.in",
    file: "playwright/.auth/auditee.json",
  },
];

for (const user of users) {
  setup(`authenticate as ${user.role}`, async ({ page }) => {
    await page.goto("/login");
    await page.getByLabel("Email").fill(user.email);
    await page.getByLabel("Password").fill("password");
    await page.getByRole("button", { name: /sign in/i }).click();
    await page.waitForURL("**/dashboard");
    await page.context().storageState({ path: user.file });
  });
}
```

NOTE: Adjust email addresses and password to match actual seed data. Check `prisma/seed.ts` or `src/data/demo/staff.json` for real credentials. The login selectors may need adjustment based on actual login page implementation -- check `src/app/(auth)/login/page.tsx` for exact form labels.

**Step 4: Update .gitignore** to exclude auth state and test artifacts:

Add these lines to `.gitignore`:

```
# Playwright
playwright/.auth/
playwright-report/
test-results/
blob-report/
```

**Step 5: Add test script to package.json:**

Add to scripts section:

```json
"test:e2e": "playwright test",
"test:e2e:ui": "playwright test --ui"
```

**Step 6: Create directory structure:**

```bash
mkdir -p tests/e2e
mkdir -p playwright/.auth
```

  </action>
  <verify>
- `pnpm exec playwright --version` returns a version number
- `ls playwright.config.ts` exists
- `ls tests/auth.setup.ts` exists
- `grep "playwright" .gitignore` shows auth exclusions
- `grep "test:e2e" package.json` shows script entry
  </verify>
  <done>Playwright installed and configured with auth setup for 4 roles (auditor, manager, CAE, auditee), webServer pointed at Next.js dev server, and .gitignore updated.</done>
</task>

<task type="auto">
  <name>Task 2: Create Phase 6 observation lifecycle E2E test suite</name>
  <files>tests/e2e/observation-lifecycle.spec.ts</files>
  <action>
Create comprehensive E2E tests covering all 9 test groups from Phase 6 plan 06-07. Each test group becomes a `test.describe` block.

**Before writing tests:** Read the actual implementation files to understand exact selectors:

- `src/app/(dashboard)/findings/page.tsx` — findings list page
- `src/app/(dashboard)/findings/[id]/page.tsx` — observation detail page
- `src/components/findings/` — findings components (form, table, timeline, etc.)

**Test structure:**

```typescript
import { test, expect } from "@playwright/test";

// Test Group 1: Create Observation (OBS-01)
test.describe("Create Observation", () => {
  test.use({ storageState: "playwright/.auth/auditor.json" });

  test("auditor can create observation with 5C fields", async ({ page }) => {
    await page.goto("/findings");
    // Click create button
    // Fill condition, criteria, cause, effect, recommendation
    // Select severity, branch, audit area, risk category
    // Submit
    // Verify redirect to detail page
    // Verify timeline shows creation
  });
});

// Test Group 2: State Transitions (OBS-02, OBS-03, OBS-04)
test.describe("State Transitions", () => {
  // Sub-test: Auditor submits for review
  // Sub-test: Manager approves (switches to manager auth)
  // Sub-test: Manager issues to auditee
  // Verify timeline entries for each transition
});

// Test Group 3: Auditee Response (OBS-02)
test.describe("Auditee Response", () => {
  test.use({ storageState: "playwright/.auth/auditee.json" });
  // Navigate to issued observation
  // Submit response with text
  // Verify status changed to RESPONSE
});

// Test Group 4: Severity-Based Closing (OBS-05, OBS-06)
test.describe("Severity-Based Closing", () => {
  // Test: Manager CAN close LOW/MEDIUM
  // Test: Manager CANNOT close HIGH/CRITICAL
  // Test: CAE CAN close HIGH/CRITICAL
});

// Test Group 5: Timeline Immutability (OBS-03)
test.describe("Timeline Immutability", () => {
  // Check timeline shows chronological events
  // Verify each entry has actor, timestamp, type, comment
  // Verify no edit/delete buttons
});

// Test Group 6: Tagging (OBS-08)
test.describe("Observation Tagging", () => {
  // Open observation
  // Verify tagging panel shows severity, status, branch, audit area, risk category
  // Verify RBI circulars section
});

// Test Group 7: Repeat Finding Detection (OBS-09, OBS-10, OBS-11)
test.describe("Repeat Finding Detection", () => {
  // Create observation matching existing closed observation
  // Verify repeat finding banner with similarity
  // Confirm as repeat, verify severity escalation
  // Verify timeline entries
});

// Test Group 8: Resolved During Fieldwork (OBS-07)
test.describe("Resolved During Fieldwork", () => {
  // Create DRAFT observation
  // Click "Resolve During Fieldwork"
  // Enter reason, confirm
  // Verify badge and timeline
});

// Test Group 9: Findings List Migration
test.describe("Findings List Page", () => {
  // Navigate to /findings
  // Verify summary cards show counts
  // Verify table shows observations
  // Verify filters work
  // Verify row click navigates to detail
});
```

**CRITICAL:** Adapt selectors to match actual DOM structure. Use `page.getByRole()`, `page.getByLabel()`, `page.getByText()` as primary selectors (Playwright best practice). Only use CSS selectors as fallback.

**Test data strategy:** Tests depend on seeded demo data in PostgreSQL. Do NOT create test-specific data fixtures -- use the existing seed data from `prisma/seed.ts`. If specific observation states are needed (e.g., COMPLIANCE state for closing tests), either:

1. Create the observation in a preceding test and use `test.describe.serial()` for ordering
2. Or look for existing seed data in the required state

**Handle tests that require state transitions across roles:** Use `test.describe.serial()` for test groups that need sequential execution (e.g., create as auditor -> approve as manager -> respond as auditee). For role switching within a serial block, use `test.use()` at describe level or create new browser contexts:

```typescript
test("manager approves observation", async ({ browser }) => {
  const managerCtx = await browser.newContext({
    storageState: "playwright/.auth/manager.json",
  });
  const page = await managerCtx.newPage();
  // ... test with manager role
  await managerCtx.close();
});
```

  </action>
  <verify>
- `ls tests/e2e/observation-lifecycle.spec.ts` exists
- File contains 9 test.describe blocks: `grep -c "test.describe" tests/e2e/observation-lifecycle.spec.ts` returns >= 9
- Uses storageState for role-based auth: `grep -c "storageState" tests/e2e/observation-lifecycle.spec.ts` returns >= 3
- Tests reference correct pages: `grep -c "findings" tests/e2e/observation-lifecycle.spec.ts` returns >= 5
- TypeScript compiles: `npx tsc --noEmit tests/e2e/observation-lifecycle.spec.ts` (may need tsconfig adjustment)
  </verify>
  <done>Observation lifecycle E2E test suite created with 9 test groups covering all Phase 6 manual test cases (OBS-01 through OBS-11), using Playwright storageState for multi-role authentication.</done>
</task>

</tasks>

<verification>
- Playwright installed: `pnpm exec playwright --version` outputs version
- Config valid: `playwright.config.ts` has webServer, 4 projects with auth dependencies
- Auth setup: `tests/auth.setup.ts` authenticates 4 roles
- Test suite: `tests/e2e/observation-lifecycle.spec.ts` has 9 describe blocks
- Gitignore: Auth state files excluded
- Package.json: `test:e2e` script exists
- NOTE: Tests will not pass until Docker+PostgreSQL are running and seed data is loaded. This plan creates the test infrastructure; execution is a prerequisite-dependent runtime activity.
</verification>

<success_criteria>

1. Playwright installed as dev dependency with chromium browser
2. `playwright.config.ts` configured with webServer, auth setup project, and 4 role-based test projects
3. `tests/auth.setup.ts` creates authenticated states for auditor, manager, CAE, and auditee
4. `tests/e2e/observation-lifecycle.spec.ts` covers all 9 test groups from 06-07-PLAN.md
5. `.gitignore` excludes `playwright/.auth/`, `playwright-report/`, `test-results/`
6. `pnpm test:e2e` script exists in package.json
   </success_criteria>

<output>
After completion, create `.planning/phases/14-verification-production-readiness/14-03-SUMMARY.md`
</output>
