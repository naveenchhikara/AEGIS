---
phase: 10-onboarding-compliance
plan: 06
type: execute
wave: 3
depends_on: [10-04]
files_modified:
  - src/app/(onboarding)/onboarding/_components/step-4-org-structure.tsx
  - src/app/(onboarding)/onboarding/_components/step-5-user-invites.tsx
  - src/lib/excel-parser.ts
  - src/app/api/onboarding/org-template/route.ts
autonomous: true

must_haves:
  truths:
    - "Step 4 has two paths: manual entry (default) and Excel upload (ONBD-03)"
    - "Manual entry: add departments (name, code, head), branches (name, code, city, type, manager)"
    - "Min requirements: 1 department (Audit), 1 branch (Head Office)"
    - "Excel upload: download template, upload via react-dropzone, parse with SheetJS, preview with per-row validation"
    - "Excel goes to server action via FormData (NOT presigned URL to S3)"
    - "Step 5: user invite table with name, email, role multi-select, branch assignment for AUDITEE"
    - "Step 5: auto-populate from org structure managers"
    - "Step 5: 'Skip for now' option available"
    - "Warning if no CAE or CCO assigned"
  artifacts:
    - path: src/app/(onboarding)/onboarding/_components/step-4-org-structure.tsx
      provides: Org structure form with manual entry and Excel upload
      min_lines: 120
      contains: "StepOrgStructure"
    - path: src/app/(onboarding)/onboarding/_components/step-5-user-invites.tsx
      provides: User invitation table with role/branch assignment
      min_lines: 80
      contains: "StepUserInvites"
    - path: src/lib/excel-parser.ts
      provides: SheetJS utilities for parsing uploaded Excel org structure
      min_lines: 40
      contains: "parseOrgStructureExcel"
    - path: src/app/api/onboarding/org-template/route.ts
      provides: Route handler generating downloadable org structure Excel template
      min_lines: 30
      contains: "GET"
  key_links:
    - from: step-4-org-structure.tsx
      to: src/lib/excel-parser.ts
      via: Parses uploaded Excel file
      pattern: "parseOrgStructureExcel"
    - from: step-4-org-structure.tsx
      to: /api/onboarding/org-template
      via: Download template button
      pattern: "org-template"
    - from: step-5-user-invites.tsx
      to: src/stores/onboarding-store.ts
      via: Pre-populates from org structure managers
      pattern: "orgStructure"
---

<objective>
Build wizard Steps 4-5: Org Structure (manual + Excel upload) and User Invites with role assignment.

Purpose: Step 4 collects the bank's organizational structure (departments, branches, staff) via manual forms or Excel import. Step 5 collects user invitations with role and branch assignments. Excel upload goes to server for SheetJS parsing (not S3).

Output: 2 wizard step components, 1 Excel parser utility, 1 template download route.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-onboarding-compliance/10-PLAN.md
@src/stores/onboarding-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Excel parser and template download</name>
  <files>src/lib/excel-parser.ts, src/app/api/onboarding/org-template/route.ts</files>
  <action>
**1. excel-parser.ts:**

SheetJS-based parsing utilities:

- `parseOrgStructureExcel(buffer: Buffer)`: Parses uploaded file
  - Reads 3 sheets: Departments, Branches, Staff
  - Extracts data from each sheet based on expected column headers
  - Returns `{ departments, branches, staff, errors }` with per-row validation
  - Validation: unique codes, required fields, valid email format, at least 1 HO branch
  - Error format: `{ row: number; sheet: string; field: string; message: string }`

- `validateDepartmentRow(row)`: Validates department code (2-5 uppercase), name (required), email (valid format)
- `validateBranchRow(row)`: Validates branch code (unique, alphanumeric), type (HO/Branch/Extension Counter)
- `validateStaffRow(row)`: Validates email uniqueness, role from enum

**IMPORTANT:** File goes to server action via FormData — NOT to S3. SheetJS parsing is server-side only.

**2. org-template/route.ts:**

GET route handler generating downloadable Excel template:

- Create ExcelJS workbook with 3 sheets:
  - Departments: headers + 1 example row + data validation dropdowns
  - Branches: headers + 1 example row + type dropdown (HO/Branch/Extension Counter)
  - Staff: headers + 1 example row + role dropdown
- Clear headers, example data in gray italic
- Return XLSX with Content-Disposition: attachment; filename="aegis-org-structure-template.xlsx"
  </action>
  <verify>Run `pnpm build`. Verify excel-parser handles all 3 sheets. Verify validation catches missing required fields. Verify template route returns downloadable XLSX.</verify>
  <done>Excel parser for org structure with per-row validation. Template download route with 3 sheets.</done>
  </task>

<task type="auto">
  <name>Task 2: Create Step 4 — Org Structure</name>
  <files>src/app/(onboarding)/onboarding/_components/step-4-org-structure.tsx</files>
  <action>
**step-4-org-structure.tsx — Client component:**

Two-path org structure input:

**Tab 1: Manual Entry (default):**

- Department section:
  - Add department form: name, code (2-5 uppercase), head name, head email
  - Pre-populated suggestions: "Most UCBs have: Credit, Operations, IT, Compliance, Audit, HR, Treasury"
  - Add/remove rows
  - Min 1 department required (Audit suggested as default)

- Branch section:
  - Add branch form: name, code, city, state, type (HO/Branch/Extension Counter), manager name, manager email
  - Min 1 branch required (Head Office suggested as default)
  - Validation: at least 1 branch marked as HO

**Tab 2: Excel Upload:**

- Download template button → hits `/api/onboarding/org-template`
- Drag-and-drop zone (reuse react-dropzone UI pattern from Phase 7)
- On drop: send file to server action via FormData
- Server action calls `parseOrgStructureExcel(buffer)` → returns parsed data + errors
- Preview table with validation status per row (green check / red X)
- Fix errors inline in preview table or re-upload
- "Confirm Import" button merges parsed data into Zustand store

Both tabs auto-save to Zustand store.
</action>
<verify>Run `pnpm build`. Verify manual entry has add/remove rows. Verify Excel upload shows preview with validation. Verify min 1 department + 1 branch enforced.</verify>
<done>Org structure form with manual entry and Excel upload paths, validation, and preview.</done>
</task>

<task type="auto">
  <name>Task 3: Create Step 5 — User Invites</name>
  <files>src/app/(onboarding)/onboarding/_components/step-5-user-invites.tsx</files>
  <action>
**step-5-user-invites.tsx — Client component:**

User invitation table:

1. **Table with add/remove rows:**
   - Columns: Name, Email, Role(s), Branch Assignment(s), Actions (remove)
   - Role: multi-select from Role enum (CEO, CAE, CCO, AUDIT_MANAGER, AUDITOR, AUDITEE)
   - Branch Assignment: multi-select populated from Step 4 branches (visible only when AUDITEE role selected)
   - "Add User" button adds empty row

2. **Auto-populate from org structure:**
   - If Step 4 has branch managers with emails, auto-create invite rows
   - Branch manager → AUDITEE role + assigned to their branch
   - User can modify before proceeding

3. **Validation and warnings:**
   - Valid email required for each row
   - AUDITEE must have at least 1 branch assigned
   - Warning banner if no CAE assigned: "No Chief Audit Executive invited"
   - Warning banner if no CCO assigned: "No Chief Compliance Officer invited"
   - Small bank helper: "In smaller banks, one person often holds multiple roles"

4. **Skip option:**
   - "I'll invite users later" checkbox
   - If checked: skip validation, proceed to completion
   - Note: "You can invite users from Settings after onboarding"

Auto-save to Zustand store.
</action>
<verify>Run `pnpm build`. Verify add/remove rows work. Verify AUDITEE branch assignment shows conditionally. Verify CAE/CCO warnings. Verify skip option.</verify>
<done>User invite table with role/branch assignment, auto-populate from org managers, warnings, and skip option.</done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds
2. Step 4: Manual entry allows add/remove departments and branches
3. Step 4: Min 1 department + 1 branch (with HO type) enforced
4. Step 4: Excel template downloadable with 3 sheets
5. Step 4: Upload parses file server-side and shows preview with validation
6. Step 5: User invite table with role multi-select
7. Step 5: Branch assignment visible only for AUDITEE role
8. Step 5: Auto-populate from Step 4 branch managers
9. Step 5: Warnings for missing CAE/CCO
10. Step 5: Skip option available
</verification>

<success_criteria>

- Org structure via manual entry or Excel upload (ONBD-03)
- Excel template downloadable with example data
- User invites with role and branch assignment (ONBD-04)
- AUDITEE users linked to branches
- Skip option for invitations
- All data persisted to Zustand store (ONBD-06)
  </success_criteria>

<output>
After completion, create `.planning/phases/10-onboarding-compliance/10-06-SUMMARY.md`
</output>
