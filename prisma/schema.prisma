// AEGIS Multi-Tenant Internal Audit Platform
// PostgreSQL schema with Row-Level Security support

generator client {
  provider        = "prisma-client"
  output          = "../src/generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [pgcrypto, pg_trgm]
}

// ─── Enums ───────────────────────────────────────────────────────────────────

enum Role {
  AUDITOR
  AUDIT_MANAGER
  CAE
  CCO
  CEO
  AUDITEE
  BOARD_OBSERVER
}

enum Severity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ObservationStatus {
  DRAFT
  SUBMITTED
  REVIEWED
  ISSUED
  RESPONSE
  COMPLIANCE
  CLOSED
}

enum ComplianceStatus {
  COMPLIANT
  PARTIAL
  NON_COMPLIANT
  PENDING
}

enum UcbTier {
  TIER_1
  TIER_2
  TIER_3
  TIER_4
}

enum PcaStatus {
  NONE
  PCA_1
  PCA_2
  PCA_3
}

// Indian Financial Year quarters (D16)
// Q1 = Apr-Jun, Q2 = Jul-Sep, Q3 = Oct-Dec, Q4 = Jan-Mar
enum Quarter {
  Q1_APR_JUN
  Q2_JUL_SEP
  Q3_OCT_DEC
  Q4_JAN_MAR
}

enum AuditPlanStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  ON_HOLD
  CANCELLED
}

enum EngagementStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ResponseType {
  CLARIFICATION
  COMPLIANCE_ACTION
  REQUEST_EXTENSION
}

enum UserStatus {
  INVITED
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum NotificationType {
  OBSERVATION_ASSIGNED
  RESPONSE_SUBMITTED
  DEADLINE_REMINDER_7D
  DEADLINE_REMINDER_3D
  DEADLINE_REMINDER_1D
  OVERDUE_ESCALATION
  WEEKLY_DIGEST
  BULK_DIGEST
  INVITATION
}

enum NotificationStatus {
  PENDING
  PROCESSING
  SENT
  FAILED
  SKIPPED
}

// ─── Tenant ──────────────────────────────────────────────────────────────────

model Tenant {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String   // Legal bank name (read-only after onboarding, DE11)
  shortName String
  rbiLicenseNo String @unique // RBI License Number (read-only after onboarding, DE11)
  tier      UcbTier
  state     String // State of registration (read-only after onboarding, DE11)
  city      String

  // Contact information (editable via settings page)
  address   String?
  pincode   String?
  phone     String?
  email     String?
  website   String?

  // Bank establishment date
  incorporationDate DateTime?

  // Scheduled bank status
  scheduledBankStatus Boolean @default(false)

  // NABARD registration (D17)
  nabardRegistrationNo String?

  // Multi-state license
  multiStateLicense Boolean @default(false)

  // DAKSH score fields (D21 — nullable for newly onboarded banks)
  dakshScore     Decimal?   @db.Decimal(5, 2)
  dakshScoreDate DateTime?

  // PCA status (D21 — nullable effective date)
  pcaStatus        PcaStatus @default(NONE)
  pcaEffectiveDate DateTime?

  // RBI inspection fields (D21 — nullable)
  lastRbiInspectionDate DateTime?
  rbiRiskRating         String?

  // Onboarding fields (Phase 10)
  established       DateTime?
  pan               String?
  cin               String?
  registrationNo    String?
  registeredWith    String?
  onboardingCompleted   Boolean   @default(false)
  onboardingCompletedAt DateTime?

  // Tenant-level settings (JSON blob for flexibility)
  settings Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users                  User[]
  onboardingProgress     OnboardingProgress?
  observations           Observation[]
  observationTimelines   ObservationTimeline[]
  evidence               Evidence[]
  complianceRequirements ComplianceRequirement[]
  branches               Branch[]
  auditAreas             AuditArea[]
  auditPlans             AuditPlan[]
  auditEngagements       AuditEngagement[]
  userBranchAssignments   UserBranchAssignment[]
  auditeeResponses        AuditeeResponse[]
  notificationQueues      NotificationQueue[]
  emailLogs               EmailLog[]
  notificationPreferences NotificationPreference[]
  boardReports            BoardReport[]
}

// ─── User ────────────────────────────────────────────────────────────────────

model User {
  id            String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email         String
  name          String
  emailVerified Boolean @default(false)
  image         String?

  // Multi-role support (D13): PostgreSQL array of enum
  // Permission checks MUST use roles.includes() not role === (D20)
  roles Role[]

  // tenantId is optional during signup — Better Auth creates user first,
  // then tenant assignment happens via onboarding flow
  tenantId String? @db.Uuid
  tenant   Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  status      UserStatus @default(ACTIVE)
  lastLoginAt DateTime?
  lastLoginIp String?

  // Invitation fields (Phase 10 — ONBD-04)
  invitedAt       DateTime?
  invitedBy       String?   @db.Uuid
  inviteTokenHash String?   @unique
  inviteExpiry    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Better Auth relations
  sessions Session[]
  accounts Account[]

  // App relations
  assignedObservations Observation[]         @relation("AssignedTo")
  createdObservations  Observation[]         @relation("CreatedBy")
  timelineEntries      ObservationTimeline[] @relation("TimelineCreatedBy")
  uploadedEvidence     Evidence[]            @relation("UploadedBy")
  ownedCompliance      ComplianceRequirement[] @relation("ComplianceOwner")
  branchAssignments    UserBranchAssignment[]
  auditeeResponses     AuditeeResponse[]     @relation("ResponseSubmittedBy")
  notifications        NotificationQueue[]   @relation("NotificationRecipient")
  notificationPreference NotificationPreference? @relation("NotificationPreference")
  generatedReports     BoardReport[]         @relation("ReportGeneratedBy")

  @@unique([email])
  @@index([tenantId])
}

// ─── Better Auth: Session ────────────────────────────────────────────────────

model Session {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @db.Uuid
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

// ─── Better Auth: Account ────────────────────────────────────────────────────

model Account {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                String    @db.Uuid
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  idToken               String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ─── Better Auth: Verification ───────────────────────────────────────────────

model Verification {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
}

// ─── Observation (Finding) ───────────────────────────────────────────────────

model Observation {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  title          String
  condition      String   @db.Text
  criteria       String   @db.Text
  cause          String   @db.Text
  effect         String   @db.Text
  recommendation String   @db.Text

  severity Severity
  status   ObservationStatus @default(DRAFT)

  assignedToId String? @db.Uuid
  assignedTo   User?   @relation("AssignedTo", fields: [assignedToId], references: [id])

  branchId String? @db.Uuid
  branch   Branch? @relation(fields: [branchId], references: [id])

  auditAreaId String?    @db.Uuid
  auditArea   AuditArea? @relation(fields: [auditAreaId], references: [id])

  createdById String @db.Uuid
  createdBy   User   @relation("CreatedBy", fields: [createdById], references: [id])

  dueDate          DateTime?
  responseDueDate  DateTime?
  statusUpdatedAt  DateTime?

  // Optimistic locking
  version Int @default(1)

  // Fieldwork resolution (OBS-07)
  resolvedDuringFieldwork Boolean @default(false)
  resolutionReason       String? @db.Text

  // Auditee response fields
  auditeeResponse String? @db.Text
  actionPlan      String? @db.Text

  // Risk categorization
  riskCategory String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  timeline          ObservationTimeline[]
  evidence          Evidence[]
  auditeeResponses  AuditeeResponse[]
  rbiCirculars      ObservationRbiCircular[]

  @@index([tenantId])
  @@index([severity])
  @@index([status])
  @@index([tenantId, branchId, auditAreaId, status])
}

// ─── Observation Timeline ────────────────────────────────────────────────────

model ObservationTimeline {
  id            String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  observationId String @db.Uuid
  observation   Observation @relation(fields: [observationId], references: [id], onDelete: Cascade)

  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  event    String
  oldValue String?
  newValue String?
  comment  String? @db.Text

  createdById String @db.Uuid
  createdBy   User   @relation("TimelineCreatedBy", fields: [createdById], references: [id])

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([observationId])
}

// ─── Evidence ────────────────────────────────────────────────────────────────

model ObservationRbiCircular {
  id            String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  observationId String @db.Uuid
  observation   Observation @relation(fields: [observationId], references: [id], onDelete: Cascade)
  rbiCircularId String @db.Uuid
  rbiCircular   RbiCircular @relation(fields: [rbiCircularId], references: [id], onDelete: Cascade)
  createdAt     DateTime @default(now())

  @@unique([observationId, rbiCircularId])
  @@index([observationId])
  @@index([rbiCircularId])
}

model Evidence {
  id            String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  observationId String @db.Uuid
  observation   Observation @relation(fields: [observationId], references: [id], onDelete: Cascade)

  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  filename    String
  s3Key       String
  fileSize    Int
  contentType String
  description String? @db.Text

  uploadedById String @db.Uuid
  uploadedBy   User   @relation("UploadedBy", fields: [uploadedById], references: [id])

  deletedAt DateTime?
  createdAt DateTime  @default(now())

  @@index([tenantId])
  @@index([observationId])
}

// ─── Compliance Requirement ──────────────────────────────────────────────────

model ComplianceRequirement {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  requirement String @db.Text
  category    String
  status      ComplianceStatus @default(PENDING)

  // Extended fields (Phase 10 — CMPL-01, CMPL-04)
  title            String?
  description      String?  @db.Text
  priority         String?
  frequency        String?
  evidenceRequired String[]
  isCustom         Boolean  @default(false)
  sourceItemCode   String?  // Reference to RbiChecklistItem.itemCode for traceability

  rbiCircularId String?     @db.Uuid
  rbiCircular   RbiCircular? @relation(fields: [rbiCircularId], references: [id])

  nextReviewDate      DateTime?
  notApplicableReason String?

  ownerId String? @db.Uuid
  owner   User?   @relation("ComplianceOwner", fields: [ownerId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([status])
}

// ─── RBI Circular (Global — no tenantId) ─────────────────────────────────────

model RbiCircular {
  id             String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  circularNumber String @unique
  title          String
  issuedDate     DateTime
  url            String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  complianceRequirements ComplianceRequirement[]
  observations            ObservationRbiCircular[]
}

// ─── Branch ──────────────────────────────────────────────────────────────────

model Branch {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  code  String
  name  String
  city  String
  state String
  type  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  observations     Observation[]
  auditEngagements AuditEngagement[]
  userAssignments  UserBranchAssignment[]

  @@unique([tenantId, code])
  @@index([tenantId])
}

// ─── Audit Area ──────────────────────────────────────────────────────────────

model AuditArea {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name         String
  description  String? @db.Text
  riskCategory String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  observations     Observation[]
  auditEngagements AuditEngagement[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

// ─── Audit Plan ──────────────────────────────────────────────────────────────

model AuditPlan {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  year    Int
  quarter Quarter
  status  AuditPlanStatus @default(PLANNED)

  startDate DateTime?
  endDate   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  engagements AuditEngagement[]

  @@unique([tenantId, year, quarter])
  @@index([tenantId])
}

// ─── Audit Engagement ────────────────────────────────────────────────────────

model AuditEngagement {
  id          String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  auditPlanId String @db.Uuid
  auditPlan   AuditPlan @relation(fields: [auditPlanId], references: [id], onDelete: Cascade)

  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  branchId String? @db.Uuid
  branch   Branch? @relation(fields: [branchId], references: [id])

  auditAreaId String?    @db.Uuid
  auditArea   AuditArea? @relation(fields: [auditAreaId], references: [id])

  assignedToId String? @db.Uuid

  status             EngagementStatus @default(PLANNED)
  scheduledStartDate DateTime?
  completionDate     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([auditPlanId])
}

// ─── User Branch Assignment (Phase 7 — auditee branch scoping) ──────────────

model UserBranchAssignment {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId   String @db.Uuid
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  branchId String @db.Uuid
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, branchId])
  @@index([tenantId])
  @@index([userId])
  @@index([branchId])
}

// ─── Auditee Response (Phase 7 — immutable response records) ────────────────

model AuditeeResponse {
  id            String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  observationId String @db.Uuid
  observation   Observation @relation(fields: [observationId], references: [id], onDelete: Cascade)

  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  responseType  ResponseType
  content       String @db.Text

  submittedById String @db.Uuid
  submittedBy   User   @relation("ResponseSubmittedBy", fields: [submittedById], references: [id])

  createdAt DateTime @default(now())
  // No updatedAt — responses are immutable (AUD-04)

  @@index([tenantId])
  @@index([observationId])
}

// ─── Audit Log (Enriched per Skeptic + Domain Expert) ────────────────────────

model AuditLog {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sequenceNumber BigInt   @default(autoincrement())

  tenantId  String @db.Uuid
  tableName String
  recordId  String
  operation String

  // Business-level action type (DE5): e.g., "observation.approved"
  actionType String?

  // Data snapshots
  oldData Json?
  newData Json?

  // Actor info
  userId        String?
  justification String? // Required for sensitive ops (DE6)

  // RBI cyber security framework fields
  ipAddress String?
  sessionId String?

  // Retention: computed as createdAt + 10 years (D14, PMLA)
  retentionExpiresAt DateTime?

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([tableName, recordId])
  @@index([actionType])
  @@index([createdAt])
}

// ─── Notification Queue ──────────────────────────────────────────────────────

model NotificationQueue {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  recipientId String @db.Uuid
  recipient   User   @relation("NotificationRecipient", fields: [recipientId], references: [id])

  type   NotificationType
  status NotificationStatus @default(PENDING)

  // Batching support (NOTF-06)
  batchKey  String?
  sendAfter DateTime @default(now())

  // Payload: template variables as JSON
  payload Json

  // Processing metadata
  retryCount  Int       @default(0)
  lastError   String?
  processedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([status, sendAfter])
  @@index([batchKey, status])
}

// ─── Email Log (audit trail for sent emails) ─────────────────────────────────

model EmailLog {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  recipientEmail String
  recipientName  String?
  subject        String
  templateName   String

  // SES response
  sesMessageId String?
  status       String // 'sent', 'bounced', 'complained', 'failed'

  // Reference back to notification(s) that triggered this email
  notificationIds String[]

  sentAt DateTime @default(now())

  @@index([tenantId])
  @@index([recipientEmail])
  @@index([sentAt])
}

// ─── User Notification Preferences ───────────────────────────────────────────

model NotificationPreference {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId   String @db.Uuid @unique
  user     User   @relation("NotificationPreference", fields: [userId], references: [id], onDelete: Cascade)
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  emailEnabled     Boolean @default(true)
  digestPreference String  @default("immediate") // 'immediate' | 'daily' | 'weekly'

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

// ─── Generated Board Report (audit trail) ────────────────────────────────────

model BoardReport {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Report metadata
  year    Int
  quarter Quarter
  title   String

  // CAE executive commentary (RPT-03)
  executiveCommentary String? @db.Text

  // Storage
  s3Key    String?
  fileSize Int?

  // Generation context
  generatedById String   @db.Uuid
  generatedBy   User     @relation("ReportGeneratedBy", fields: [generatedById], references: [id])
  generatedAt   DateTime @default(now())

  // Snapshot of key metrics at generation time
  metricsSnapshot Json?

  @@index([tenantId])
  @@index([tenantId, year, quarter])
}

// ─── RBI Master Direction (Global — no tenantId) ──────────────────────────

model RbiMasterDirection {
  id          String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shortId     String  @unique // e.g., "MD-CAP", "MD-IRAC"
  title       String
  description String? @db.Text
  rbiRef      String? // Official RBI reference number
  category    String  // e.g., "Capital Adequacy", "Asset Classification"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  checklistItems RbiChecklistItem[]
}

// ─── RBI Checklist Item (Global — no tenantId) ────────────────────────────

model RbiChecklistItem {
  id                 String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  masterDirectionId  String @db.Uuid
  masterDirection    RbiMasterDirection @relation(fields: [masterDirectionId], references: [id], onDelete: Cascade)

  itemCode          String   @unique // e.g., "MD-CAP-001"
  title             String
  description       String   @db.Text
  category          String
  tierApplicability UcbTier[] // PostgreSQL array — which UCB tiers this applies to
  tierEnhancements  Json?     // Tier-specific enhanced requirements
  frequency         String    // e.g., "quarterly", "annual", "continuous"
  evidenceRequired  String[]  // Types of evidence needed
  priority          String    // e.g., "critical", "high", "medium", "low"
  rbiCircularRef    String?   // Reference circular number
  rbiCircularUrl    String?   // Link to circular on RBI website

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([masterDirectionId])
}

// ─── Onboarding Progress (Tenant-scoped, one-to-one) ─────────────────────

model OnboardingProgress {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId String @unique @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  currentStep    Int    @default(1)
  completedSteps Int[]  @default([])
  stepData       Json?  // Per-step form data for save-and-return
  status         String @default("in_progress") // "in_progress" | "completed" | "expired"
  expiresAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

// ─── Failed Login Attempt Tracking (Phase 11 — account lockout) ─────────────

model FailedLoginAttempt {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email       String    // Track by email, not userId (pre-auth, user may not exist)
  ipAddress   String
  attemptedAt DateTime  @default(now())
  lockedUntil DateTime? // NULL = not locked; non-NULL = account locked until this time

  @@index([email, attemptedAt])
  @@index([email, lockedUntil])
}
