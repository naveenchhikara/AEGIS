---
phase: 08-notifications-reports
plan: 06
type: execute
wave: 3
depends_on: [08-03, 08-04, 08-05]
files_modified:
  - src/app/(dashboard)/settings/notifications/page.tsx
  - src/app/(dashboard)/reports/page.tsx
  - src/components/reports/report-generator.tsx
  - src/app/(dashboard)/findings/page.tsx
  - src/app/(dashboard)/compliance/page.tsx
  - src/app/(dashboard)/audit-plans/page.tsx
autonomous: true

must_haves:
  truths:
    - "Notification preferences page lets users toggle email notifications and digest preference"
    - "CAE/CCO cannot disable weekly digest (regulatory requirement)"
    - "Reports page has board report generation UI with quarter selector and commentary editor"
    - "Export XLSX buttons added to findings, compliance, and audit plans pages"
    - "Notification triggers integrated into observation lifecycle (ISSUED → NOTF-01, response → NOTF-02)"
    - "Unsubscribe link in email footer points to /settings/notifications"
  artifacts:
    - path: src/app/(dashboard)/settings/notifications/page.tsx
      provides: Notification preferences page with email toggle and digest preference
      min_lines: 40
      contains: "NotificationPreferences"
    - path: src/components/reports/report-generator.tsx
      provides: Board report generation UI with quarter selector, commentary editor, generate button
      min_lines: 60
      contains: "ReportGenerator"
    - path: src/app/(dashboard)/findings/page.tsx
      provides: Updated findings page with export XLSX button
      contains: "Export"
  key_links:
    - from: settings/notifications/page.tsx
      to: src/data-access/notifications.ts
      via: Get and update notification preferences
      pattern: "updateNotificationPreferences"
    - from: report-generator.tsx
      to: /api/reports/board-report
      via: POST to generate PDF, GET to download
      pattern: "board-report"
    - from: findings/page.tsx
      to: /api/exports/findings
      via: Download link for XLSX export
      pattern: "exports/findings"
---

<objective>
Wire up all notification, report, and export features into the existing UI: notification preferences settings, board report generation page, and export buttons on data pages.

Purpose: This integration plan connects the backend systems (notifications, PDF, Excel) to user-facing interfaces. Users can manage notification preferences, CAE can generate board reports, and all users can export data relevant to their role.

Output: Updated settings, reports, findings, compliance, and audit plans pages with notification triggers integrated.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-notifications-reports/08-PLAN.md
@.planning/phases/08-notifications-reports/08-03-PLAN.md
@.planning/phases/08-notifications-reports/08-04-PLAN.md
@.planning/phases/08-notifications-reports/08-05-PLAN.md
@src/app/(dashboard)/reports/page.tsx
@src/app/(dashboard)/findings/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notification preferences page</name>
  <files>src/app/(dashboard)/settings/notifications/page.tsx</files>
  <action>
**settings/notifications/page.tsx:**

Server component + client component for preferences:

- Fetch current preferences via DAL
- Display:
  - Toggle: "Email notifications" (on/off)
  - Select: "Notification delivery" → Immediate / Daily digest / Weekly digest
  - If user is CAE or CCO: show "Weekly Audit Digest" as always-on (grayed out toggle with note "Required for regulatory compliance")
- Save button calls `updateNotificationPreferences` server action
- Success toast on save
- Note: This is the target of the "Manage preferences" link in email footers
- Route guard: any authenticated user can access
  </action>
  <verify>Run `pnpm build`. Verify page has email toggle and digest preference selector. Verify CAE/CCO weekly digest cannot be disabled.</verify>
  <done>Notification preferences page with email toggle, digest preference, and regulatory lockout for CAE/CCO weekly digest.</done>
  </task>

<task type="auto">
  <name>Task 2: Create board report generation UI</name>
  <files>src/app/(dashboard)/reports/page.tsx, src/components/reports/report-generator.tsx</files>
  <action>
**1. report-generator.tsx** — Client component:

- Quarter selector: Q1, Q2, Q3, Q4 (Indian fiscal year: Q1=Apr-Jun, Q2=Jul-Sep, Q3=Oct-Dec, Q4=Jan-Mar)
- Year selector: current FY and previous FY
- Executive commentary text area (optional, RPT-03)
- "Generate Report" button:
  - POST to `/api/reports/board-report` with { year, quarter, executiveCommentary }
  - Show loading spinner during generation
  - On success: auto-download PDF, show success toast
  - On error: show error toast
- Previously generated reports list:
  - Table: period, generated by, generated at, download button
  - Download button generates presigned URL and opens in new tab

**2. reports/page.tsx** — Update:

- Add route guard: CAE role required for generation, CAE/CCO/CEO for viewing
- Add ReportGenerator component
- Keep existing report content as a preview/dashboard section
  </action>
  <verify>Run `pnpm build`. Verify report-generator has quarter/year selectors and commentary editor. Verify CAE role check. Verify download functionality.</verify>
  <done>Board report generation UI with quarter selector, executive commentary, generation button, and download history.</done>
  </task>

<task type="auto">
  <name>Task 3: Add export buttons and notification triggers</name>
  <files>src/app/(dashboard)/findings/page.tsx, src/app/(dashboard)/compliance/page.tsx, src/app/(dashboard)/audit-plans/page.tsx</files>
  <action>
**1. Add export buttons to data pages:**

- findings/page.tsx: Add "Export to Excel" button → downloads from `/api/exports/findings`
  - Pass current filters as query params (severity, status, branch)
  - Button uses `<a href="..." download>` pattern or window.open()
  - Show only if user has export permission

- compliance/page.tsx: Add "Export to Excel" button → `/api/exports/compliance`
  - Show only for CAE/CCO/CEO roles

- audit-plans/page.tsx: Add "Export to Excel" button → `/api/exports/audit-plans`
  - Show based on role (all for CAE/CCO/CEO, filtered for others)

**2. Integrate notification triggers** (in existing Phase 6/7 server actions):

Note: These changes go into existing action files, adding queueNotification calls:

- `src/actions/observations.ts` (Phase 6): After `transitionObservation` to ISSUED status → `queueNotification(OBSERVATION_ASSIGNED, assignedToId, payload)`
- `src/actions/auditee.ts` (Phase 7): After `submitAuditeeResponse` → `queueNotification(RESPONSE_SUBMITTED, createdById, payload)`

These are lightweight additions (1-3 lines per trigger) that queue notifications without blocking the main action.
</action>
<verify>Run `pnpm build`. Verify export buttons exist on all 3 pages. Verify notification triggers added to observation transition and auditee response actions.</verify>
<done>Export buttons on findings, compliance, audit plans pages. Notification triggers integrated into observation lifecycle and auditee response.</done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds
2. Notification preferences page toggles email and digest preference
3. CAE/CCO weekly digest locked on (regulatory)
4. Board report generator has quarter/year selector and commentary
5. Previously generated reports listed with download
6. Export XLSX buttons on findings, compliance, audit plans pages
7. Export buttons respect role permissions (visibility)
8. Notification queued when observation issued (NOTF-01 trigger)
9. Notification queued when auditee responds (NOTF-02 trigger)
</verification>

<success_criteria>

- Notification preferences manageable by all users
- CAE/CCO weekly digest cannot be disabled (regulatory)
- Board report generation with quarter/year/commentary (RPT-01, RPT-03)
- Export buttons on data pages with role-based visibility
- Notification triggers integrated into Phase 6/7 workflows
- End-to-end: create observation → issue → auditee receives email
  </success_criteria>

<output>
After completion, create `.planning/phases/08-notifications-reports/08-06-SUMMARY.md`
</output>
