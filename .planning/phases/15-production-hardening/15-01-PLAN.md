---
phase: 15-production-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/env.ts
  - next.config.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Application fails fast on startup when required environment variables are missing or malformed"
    - "All env vars are type-safe with IDE autocomplete via env.DATABASE_URL etc."
    - "Client-side code cannot access server-only variables"
    - "Build succeeds with SKIP_ENV_VALIDATION=1 for Docker builds without secrets"
  artifacts:
    - path: "src/env.ts"
      provides: "Centralized Zod schema for all environment variables"
      contains: "createEnv"
    - path: "next.config.ts"
      provides: "Build-time env validation trigger"
      contains: 'import "./src/env"'
  key_links:
    - from: "next.config.ts"
      to: "src/env.ts"
      via: "import side-effect"
      pattern: "import.*src/env"
---

<objective>
Add centralized environment variable validation using @t3-oss/env-nextjs with Zod schemas for all 14 required env vars documented in .env.example. Validation runs at build time (via next.config.ts import) and fails fast with descriptive errors on misconfiguration.

Purpose: Prevent silent runtime failures from missing or malformed environment variables — the #1 cause of deployment issues.
Output: `src/env.ts` with typed env object, build-time validation wired in `next.config.ts`.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-production-hardening/15-RESEARCH.md
@.env.example
@next.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install T3 Env and create centralized env validation schema</name>
  <files>
    package.json
    src/env.ts
  </files>
  <action>
    1. Install @t3-oss/env-nextjs:
       `pnpm add @t3-oss/env-nextjs`
       (Zod 4.3.6 already installed — T3 Env uses Standard Schema interface which Zod v4 supports)

    2. Create `src/env.ts` with createEnv() covering all 14 env vars from .env.example:

       Server vars (no prefix):
       - DATABASE_URL: z.string().url() — Prisma connection string
       - POSTGRES_USER: z.string().min(1)
       - POSTGRES_PASSWORD: z.string().min(1) — alphanumeric only per CLAUDE.md
       - POSTGRES_DB: z.string().min(1)
       - POSTGRES_PORT: z.coerce.number().int().positive()
       - BETTER_AUTH_SECRET: z.string().min(32) — must be strong
       - BETTER_AUTH_URL: z.string().url()
       - AWS_REGION: z.string().min(1) — don't regex-lock to ap-south-1 (flexibility for dev/test)
       - AWS_ACCESS_KEY_ID: z.string().min(1)
       - AWS_SECRET_ACCESS_KEY: z.string().min(1)
       - S3_BUCKET_NAME: z.string().min(1)
       - AWS_SES_REGION: z.string().min(1)
       - SES_FROM_EMAIL: z.string().email()
       - NODE_ENV: z.enum(["development", "test", "production"]).default("development")

       Client vars (NEXT_PUBLIC_ prefix):
       - NEXT_PUBLIC_APP_URL: z.string().url()

       Include `runtimeEnv` mapping for every key (required by Next.js bundler).
       Include `skipValidation: !!process.env.SKIP_ENV_VALIDATION` for Docker builds.
       Include `emptyStringAsUndefined: true` to catch empty strings.

    3. Export as `export const env = createEnv({...})` for type-safe usage.

    IMPORTANT: Zod v4 uses the same API as v3 for basic types (z.string(), z.number(), z.enum()).
    The createEnv function uses Standard Schema interface, which Zod v4 implements natively.

  </action>
  <verify>
    - `pnpm tsc --noEmit` passes (no type errors in env.ts)
    - `src/env.ts` exists and exports `env` with createEnv
    - All 15 vars (14 server + 1 client) have Zod schemas and runtimeEnv entries
  </verify>
  <done>
    src/env.ts exists with Zod schemas for all 15 environment variables, type-safe export, and skipValidation support for Docker builds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire env validation into Next.js build and add SKIP_ENV_VALIDATION to .env.example</name>
  <files>
    next.config.ts
    .env.example
  </files>
  <action>
    1. Add `import "./src/env";` as the FIRST import in `next.config.ts` (before next-intl plugin).
       This triggers Zod validation at build time — any missing/invalid var causes build failure with descriptive error.

    2. Add `SKIP_ENV_VALIDATION=` entry to `.env.example` with comment:
       ```
       # Set to "1" to skip env validation (e.g., Docker build without secrets)
       SKIP_ENV_VALIDATION=
       ```

    3. Verify the existing next.config.ts structure is preserved (standalone output, serverExternalPackages, experimental settings, next-intl plugin).

  </action>
  <verify>
    - `pnpm build` succeeds when .env has valid values (or SKIP_ENV_VALIDATION=1)
    - `grep 'import.*src/env' next.config.ts` returns a match
    - `.env.example` contains SKIP_ENV_VALIDATION entry
  </verify>
  <done>
    Build-time environment validation is active. Missing or malformed env vars cause a clear build error. Docker builds can skip validation with SKIP_ENV_VALIDATION=1.
  </done>
</task>

</tasks>

<verification>
1. `pnpm tsc --noEmit` — no type errors
2. `pnpm build` with valid .env — succeeds
3. Temporarily remove DATABASE_URL from .env, run `pnpm build` — fails with Zod validation error mentioning DATABASE_URL
4. Set SKIP_ENV_VALIDATION=1, run `pnpm build` — succeeds even with missing vars
</verification>

<success_criteria>

- src/env.ts exists with Zod schemas for all 15 env vars
- next.config.ts imports src/env for build-time validation
- Build fails with clear error when required env var is missing
- Build succeeds with SKIP_ENV_VALIDATION=1
- No type errors in codebase
  </success_criteria>

<output>
After completion, create `.planning/phases/15-production-hardening/15-01-SUMMARY.md`
</output>
