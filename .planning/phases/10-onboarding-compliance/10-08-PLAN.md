---
phase: 10-onboarding-compliance
plan: 08
type: execute
wave: 5
depends_on: [10-07]
files_modified:
  - src/app/(dashboard)/settings/compliance/page.tsx
  - src/app/(dashboard)/settings/compliance/_components/add-custom-requirement.tsx
  - src/app/(dashboard)/settings/compliance/_components/master-direction-browser.tsx
  - src/actions/compliance-management.ts
  - src/data-access/compliance-management.ts
autonomous: true

must_haves:
  truths:
    - "Custom compliance requirement addition from Settings → Compliance (CMPL-04)"
    - "Custom requirement form: requirement text, category (existing + custom), priority, frequency, optional RBI circular autocomplete"
    - "isCustom flag set to true for admin-added requirements"
    - "Mark as Not Applicable from compliance registry with justification (min 20 chars) (CMPL-03)"
    - "Revert N/A to active status action available"
    - "Audit trail for both N/A marking and custom requirement addition"
    - "Master Direction browser shows available templates for reference"
    - "Admin/CCO role required for all actions"
  artifacts:
    - path: src/app/(dashboard)/settings/compliance/page.tsx
      provides: Compliance management settings page
      min_lines: 30
      contains: "ComplianceSettings"
    - path: src/app/(dashboard)/settings/compliance/_components/add-custom-requirement.tsx
      provides: Form for adding custom compliance requirements
      min_lines: 50
      contains: "AddCustomRequirement"
    - path: src/actions/compliance-management.ts
      provides: Server actions for custom requirements and N/A marking
      min_lines: 50
      contains: "addCustomRequirement"
    - path: src/data-access/compliance-management.ts
      provides: DAL for compliance management operations
      min_lines: 40
      contains: "createCustomRequirement"
  key_links:
    - from: compliance-management.ts (actions)
      to: src/data-access/compliance-management.ts
      via: DAL for database operations
      pattern: "createCustomRequirement"
    - from: add-custom-requirement.tsx
      to: src/actions/compliance-management.ts
      via: Server action for form submission
      pattern: "addCustomRequirement"
---

<objective>
Implement post-onboarding compliance management: custom requirement addition and N/A marking from the compliance registry.

Purpose: After onboarding seeds the compliance registry, admins and CCO need to maintain it: adding bank-specific custom requirements and marking items as not applicable with justification. This completes the compliance lifecycle for ongoing registry management.

Output: 1 settings page, 2 UI components, 1 server action module, 1 DAL module.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-onboarding-compliance/10-PLAN.md
@src/app/(dashboard)/compliance/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create compliance management DAL and server actions</name>
  <files>src/data-access/compliance-management.ts, src/actions/compliance-management.ts</files>
  <action>
**1. compliance-management.ts (DAL):**

- `createCustomRequirement(tenantId, data)`: Creates ComplianceRequirement with isCustom = true
- `markNotApplicable(tenantId, requirementId, reason)`: Updates ComplianceRequirement with notApplicableReason, creates audit log
- `revertNotApplicable(tenantId, requirementId)`: Clears notApplicableReason, creates audit log
- `getMasterDirections()`: Lists global RbiMasterDirection with checklist item counts
- `getRbiCircularsForAutocomplete(query)`: Searches global RbiCircular table for autocomplete

**2. compliance-management.ts (server actions):**

- `addCustomRequirement(data)`:
  - Verify Admin/CCO role
  - Validate: requirement text (required), category, priority, frequency
  - Optional: RBI circular reference (link to existing RbiCircular)
  - Create via DAL with isCustom = true, status = PENDING
  - Create audit log entry
  - Return new requirement ID

- `markNotApplicable(requirementId, reason)`:
  - Verify Admin/CCO role
  - Validate: reason min 20 characters
  - Update via DAL
  - Create audit log entry with justification

- `revertNotApplicable(requirementId)`:
  - Verify Admin/CCO role
  - Update via DAL (clear reason, set status back to PENDING)
  - Create audit log entry

- `getMasterDirections()`:
  - Any authenticated user can view
  - Returns list with counts per direction
    </action>
    <verify>Run `pnpm build`. Verify role checks (Admin/CCO). Verify N/A reason min 20 chars. Verify audit log entries for all mutations.</verify>
    <done>Compliance management DAL and server actions for custom requirements and N/A marking.</done>
    </task>

<task type="auto">
  <name>Task 2: Create compliance settings page and components</name>
  <files>src/app/(dashboard)/settings/compliance/page.tsx, src/app/(dashboard)/settings/compliance/_components/add-custom-requirement.tsx, src/app/(dashboard)/settings/compliance/_components/master-direction-browser.tsx</files>
  <action>
**1. settings/compliance/page.tsx:**

Server component:

- requirePermission for Admin/CCO role
- Fetch existing custom requirements and Master Direction list
- Render tabs: "Custom Requirements", "Master Direction Browser"

**2. add-custom-requirement.tsx — Client component:**

Form for adding custom requirements:

- Requirement text (textarea, required)
- Category: select from existing categories + "Add custom category" option
- Priority: select (critical, high, medium, low)
- Frequency: select (Continuous, Quarterly, Annual, One-time)
- RBI Circular Reference: autocomplete input searching global RbiCircular table
- Assigned owner: select from tenant users
- Submit button → calls addCustomRequirement server action
- Success toast + reset form

**3. master-direction-browser.tsx — Client component:**

Reference browser for RBI Master Directions:

- Accordion list of 10 Master Directions
- Each shows: title, description, checklist item count
- Expand to see individual items with tier applicability badges
- Read-only reference — no editing from this view
- Helps admin understand what templates are available
  </action>
  <verify>Run `pnpm build`. Verify settings page has role guard. Verify custom requirement form has all fields. Verify Master Direction browser shows 10 directions.</verify>
  <done>Compliance settings page with custom requirement form and Master Direction browser.</done>
  </task>

</tasks>

<verification>
1. `pnpm build` succeeds
2. Custom requirement form creates with isCustom = true (CMPL-04)
3. N/A marking requires justification min 20 chars (CMPL-03)
4. Revert N/A restores requirement to active status
5. Audit trail for all compliance management actions
6. Admin/CCO role required for all mutations
7. Master Direction browser shows available templates
8. RBI circular autocomplete works for custom requirements
</verification>

<success_criteria>

- Custom compliance requirements addable from Settings (CMPL-04)
- N/A marking with justification from compliance registry (CMPL-03)
- Revert N/A to active available
- Audit trail for all actions
- Master Direction browser for reference
- Admin/CCO role enforcement
  </success_criteria>

<output>
After completion, create `.planning/phases/10-onboarding-compliance/10-08-SUMMARY.md`
</output>
