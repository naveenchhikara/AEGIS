---
phase: 07-auditee-portal-evidence
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/s3.ts
autonomous: true

must_haves:
  truths:
    - "S3Client singleton configured for ap-south-1 (Mumbai) region"
    - "generateUploadUrl() creates presigned PUT URL with 5-minute expiry"
    - "generateDownloadUrl() creates presigned GET URL with 5-minute expiry"
    - "verifyUpload() confirms file exists in S3 via HeadObject"
    - "validateFileType() uses file-type package for magic byte validation (not extension check)"
    - "S3 key format is /{tenantId}/evidence/{observationId}/{uuid}.{ext}"
    - "Allowed file types: PDF, JPEG, PNG, DOCX, XLSX only"
    - "File size limit: 10MB"
  artifacts:
    - path: src/lib/s3.ts
      provides: S3 utility module with presigned URL generation, file type validation, upload verification
      min_lines: 80
      contains: "generateUploadUrl"
  key_links:
    - from: s3.ts
      to: "@aws-sdk/client-s3"
      via: S3Client, PutObjectCommand, GetObjectCommand, HeadObjectCommand
      pattern: "S3Client"
    - from: s3.ts
      to: "@aws-sdk/s3-request-presigner"
      via: getSignedUrl for presigned URLs
      pattern: "getSignedUrl"
    - from: s3.ts
      to: "file-type"
      via: fileTypeFromBuffer for magic byte validation
      pattern: "fileTypeFromBuffer"
---

<objective>
Create the S3 utility module for evidence file upload and download with presigned URLs, file type validation via magic bytes, and tenant-scoped key generation.

Purpose: All evidence file operations go through this utility module. It handles presigned URL generation (browser uploads directly to S3), file type validation (magic bytes, not extensions), and upload verification (HeadObject). This is a foundational module used by the auditee server actions in Plan 07-03.

Output: `src/lib/s3.ts` with S3Client singleton and all evidence utility functions.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-auditee-portal-evidence/07-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create S3 utility module</name>
  <files>src/lib/s3.ts</files>
  <action>
Create `src/lib/s3.ts` with the following:

**1. S3Client singleton:**

```typescript
import "server-only";
import {
  S3Client,
  PutObjectCommand,
  GetObjectCommand,
  HeadObjectCommand,
} from "@aws-sdk/client-s3";
import { getSignedUrl } from "@aws-sdk/s3-request-presigner";
import { fileTypeFromBuffer } from "file-type";
```

- Singleton S3Client configured for `ap-south-1` (Mumbai)
- Bucket name from `process.env.S3_EVIDENCE_BUCKET` (default: `aegis-evidence-dev`)

**2. ALLOWED_FILE_TYPES constant:**

```typescript
const ALLOWED_FILE_TYPES = new Map([
  ["application/pdf", "pdf"],
  ["image/jpeg", "jpg"],
  ["image/png", "png"],
  [
    "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
    "docx",
  ],
  ["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", "xlsx"],
]);
```

Max file size: `10 * 1024 * 1024` (10MB)

**3. validateFileType(fileHeader: string):**

- Accepts base64-encoded first 4KB of file (sent from client)
- Decodes to Buffer, runs `fileTypeFromBuffer()`
- Returns `{ valid: true, mimeType, extension }` or `{ valid: false, error: string }`
- Rejects any MIME type not in ALLOWED_FILE_TYPES

**4. generateS3Key(tenantId, observationId, extension):**

- Format: `{tenantId}/evidence/{observationId}/{uuid}.{extension}`
- Uses `crypto.randomUUID()` for unique filename

**5. generateUploadUrl(s3Key, contentType, fileSize):**

- Creates PutObjectCommand with key, content type, content length, SSE-S3 encryption
- Returns presigned PUT URL with 300-second (5 min) expiry
- Includes `ContentType` and `ContentLength` conditions

**6. generateDownloadUrl(s3Key):**

- Creates GetObjectCommand
- Returns presigned GET URL with 300-second expiry

**7. verifyUpload(s3Key):**

- HeadObjectCommand to verify file exists
- Returns `{ exists: true, contentLength, contentType }` or `{ exists: false }`
- Catches NotFound errors gracefully

**Security notes:**

- `import "server-only"` prevents client bundle inclusion
- Never expose raw S3 credentials to client
- All functions are async and handle AWS SDK errors with meaningful messages
  </action>
  <verify>Run `pnpm build` to confirm TypeScript compilation. Verify file imports `server-only`. Verify all 5 exported functions exist (validateFileType, generateS3Key, generateUploadUrl, generateDownloadUrl, verifyUpload).</verify>
  <done>S3 utility module created with presigned URL generation, magic byte file type validation, tenant-scoped key generation, and upload verification.</done>
  </task>

</tasks>

<verification>
1. `pnpm build` succeeds
2. `src/lib/s3.ts` imports `server-only`
3. ALLOWED_FILE_TYPES includes PDF, JPEG, PNG, DOCX, XLSX only
4. File size limit is 10MB
5. Presigned URL expiry is 5 minutes (300 seconds)
6. S3 key format is `{tenantId}/evidence/{observationId}/{uuid}.{ext}`
7. `verifyUpload` handles NotFound errors without throwing
</verification>

<success_criteria>

- S3Client singleton avoids creating new client per request
- File type validation uses magic bytes (file-type package), not file extension
- Presigned URLs have 5-minute expiry for security
- S3 keys include tenantId prefix for tenant isolation
- SSE-S3 encryption specified in PutObjectCommand
- Module is server-only (cannot be imported in client components)
  </success_criteria>

<output>
After completion, create `.planning/phases/07-auditee-portal-evidence/07-02-SUMMARY.md`
</output>
