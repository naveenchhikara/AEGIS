# Plan 04-05: AWS Infrastructure Setup

**Wave:** 5 of 7
**Autonomous:** false (human verification checkpoint)
**Depends on:** 04-04 (responsive polish complete)
**Blocked by:** None

## Overview

Provision and configure AWS Lightsail instance in Mumbai region with PM2 process management and Nginx reverse proxy. This wave sets up the server infrastructure before deploying the application.

## Tasks

### Task 1: Provision AWS Lightsail instance
1. Log into AWS Console (ap-south-1 region)
2. Navigate to Lightsail → Create instance
3. Configuration:
   - **Region**: Mumbai (ap-south-1)
   - **Instance image**: Ubuntu 22.04 LTS
   - **Instance plan**: $5/month (512 MB RAM, 1 vCPU, 20 GB SSD) OR $10/month (1 GB RAM, 1 vCPU, 40 GB SSD) for better performance
   - **Instance name**: aegis-production
   - **Create static IP**: Attach to instance (aegis-production-ip)
4. Wait for instance provisioning (~2-5 minutes)
5. Download SSH key (.pem file) to local machine
6. Connect via SSH: `ssh -i aegis-key.pem ubuntu@<public-ip>`

### Task 2: Install Node.js and PM2 on server
1. Update system packages:
   ```bash
   sudo apt update
   sudo apt upgrade -y
   ```
2. Install Node.js 20 LTS:
   ```bash
   curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
   sudo apt install -y nodejs
   ```
3. Verify installation:
   ```bash
   node --version  # Should show v20.x.x
   npm --version
   ```
4. Install PM2 globally:
   ```bash
   sudo npm install -g pm2
   ```
5. Verify: `pm2 --version`

### Task 3: Install and configure Nginx
1. Install Nginx:
   ```bash
   sudo apt install -y nginx
   ```
2. Start and enable Nginx:
   ```bash
   sudo systemctl start nginx
   sudo systemctl enable nginx
   ```
3. Verify: Visit instance public IP in browser → should see Nginx welcome page
4. Create Nginx server block:
   ```bash
   sudo nano /etc/nginx/sites-available/aegis
   ```
5. Add configuration:
   ```nginx
   server {
       listen 80;
       server_name aegis.yourdomain.com www.aegis.yourdomain.com;

       location / {
           proxy_pass http://localhost:3000;
           proxy_http_version 1.1;
           proxy_set_header Upgrade $http_upgrade;
           proxy_set_header Connection 'upgrade';
           proxy_set_header Host $host;
           proxy_cache_bypass $http_upgrade;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
       }
   }
   ```
6. Enable site:
   ```bash
   sudo ln -s /etc/nginx/sites-available/aegis /etc/nginx/sites-enabled/
   sudo nginx -t
   sudo systemctl reload nginx
   ```

### Task 4: Create PM2 ecosystem configuration
1. Create `ecosystem.config.js` in project root locally:
   ```javascript
   module.exports = {
     apps: [{
       name: 'aegis',
       script: 'node_modules/next/dist/bin/next',
       args: 'start -p 3000',
       cwd: '/var/www/aegis',
       instances: 1,
       exec_mode: 'fork',
       env: {
         NODE_ENV: 'production',
         PORT: 3000
       },
       error_file: '/var/log/pm2/aegis-error.log',
       out_file: '/var/log/pm2/aegis-out.log',
       log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
       autorestart: true,
       max_memory_restart: '500M'
     }]
   };
   ```
2. Create log directory on server:
   ```bash
   sudo mkdir -p /var/log/pm2
   sudo chown ubuntu:ubuntu /var/log/pm2
   ```

### Task 5: Set up deployment directory and permissions
1. Create app directory on server:
   ```bash
   sudo mkdir -p /var/www/aegis
   sudo chown ubuntu:ubuntu /var/www/aegis
   ```
2. Verify permissions: `ls -la /var/www/`

### Task 6: Configure firewall (UFW)
1. Allow OpenSSH:
   ```bash
   sudo ufw allow OpenSSH
   ```
2. Allow Nginx Full:
   ```bash
   sudo ufw allow 'Nginx Full'
   ```
3. Enable firewall:
   ```bash
   sudo ufw enable
   ```
4. Check status: `sudo ufw status`

### Task 7: Human verification checkpoint - infrastructure ready
1. **Verify AWS Lightsail**: Instance running in Mumbai region, static IP attached
2. **Verify SSH access**: Can connect with downloaded key
3. **Verify Node.js**: `node --version` shows v20.x.x
4. **Verify PM2**: `pm2 --version` shows installed
5. **Verify Nginx**: Welcome page loads at public IP
6. **Verify Nginx config**: `sudo nginx -t` shows "test is successful"
7. **Verify firewall**: `sudo ufw status` shows correct rules
8. **Verify directory**: `/var/www/aegis` exists with correct ownership

## Must Haves

- AWS Lightsail instance running in ap-south-1 (Mumbai)
- Static IP attached to instance
- Node.js 20 LTS installed
- PM2 installed globally
- Nginx installed and serving welcome page
- Nginx reverse proxy configured for port 3000
- Firewall configured to allow HTTP, HTTPS, SSH
- Deployment directory `/var/www/aegis` created

## Artifacts Created

| Item | Purpose |
|------|---------|
| AWS Lightsail instance | Production server in Mumbai |
| Static IP (aegis-production-ip) | Fixed IP for DNS configuration |
| `/etc/nginx/sites-available/aegis` | Nginx reverse proxy configuration |
| `ecosystem.config.js` | PM2 process configuration |
| `/var/www/aegis` | Application deployment directory |
| `/var/log/pm2` | PM2 log directory |
| UFW firewall rules | Security configuration |

## Key Links

- Nginx config → proxies to `localhost:3000`
- PM2 ecosystem → manages Next.js process
- Static IP → points to custom domain in Wave 6

---

*Wave 5 creates AWS infrastructure. Wave 6 handles SSL and domain configuration.*
