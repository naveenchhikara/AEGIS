---
phase: 04-polish-deploy
plan: 06
type: execute
wave: 2
depends_on: ["04-05"]
files_modified:
  - deploy/nginx-aegis.conf
autonomous: false

must_haves:
  truths:
    - "Server setup script has been executed on the Lightsail instance"
    - "Node.js, pnpm, PM2, Nginx are installed on the server"
    - "Git repo cloned to /home/ubuntu/aegis on the server"
    - "SSL certificate is configured (if domain available) or HTTP access works via static IP"
  artifacts:
    - path: "deploy/nginx-aegis.conf"
      provides: "Nginx config updated with domain name and SSL (if applicable)"
      contains: "server_name"
  key_links:
    - from: "Nginx on server"
      to: "PM2/Next.js on port 3000"
      via: "reverse proxy"
      pattern: "proxy_pass.*localhost:3000"
    - from: "Certbot"
      to: "Nginx SSL config"
      via: "auto-generated SSL directives"
      pattern: "ssl_certificate"
---

<objective>
Run the server setup script on the Lightsail instance, clone the repo, and configure SSL if a domain is available. If no domain, configure HTTP-only access via static IP.

Purpose: Get the server fully configured and ready for application deployment.
Output: Server with Node.js, PM2, Nginx running, repo cloned, SSL configured (or HTTP fallback ready).
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-polish-deploy/04-RESEARCH.md
@.planning/phases/04-polish-deploy/04-05-SUMMARY.md
@deploy/setup.sh
@deploy/deploy.sh
@deploy/ecosystem.config.js
@deploy/nginx-aegis.conf
</context>

<tasks>

<task type="auto">
  <name>Task 1: Execute server setup and clone repository</name>
  <files>
    deploy/nginx-aegis.conf
  </files>
  <action>
    Using the static IP and SSH key from plan 04-05, execute the following via SSH:

    1. **Copy deploy files to server:**
       ```bash
       scp -i ~/.ssh/aegis-lightsail.pem -r deploy/ ubuntu@STATIC_IP:/home/ubuntu/deploy-temp/
       ```

    2. **SSH into the server and run setup:**
       ```bash
       ssh -i ~/.ssh/aegis-lightsail.pem ubuntu@STATIC_IP
       ```
       On the server:
       ```bash
       # Run setup script
       chmod +x /home/ubuntu/deploy-temp/setup.sh
       bash /home/ubuntu/deploy-temp/setup.sh
       ```
       Watch for the PM2 startup command output and execute it.

    3. **Clone the repository:**
       ```bash
       # On the server
       cd /home/ubuntu
       git clone <REPO_URL> aegis
       # OR if private repo, set up SSH key or use HTTPS with token
       ```
       If the repo is not on GitHub yet, push it first from local:
       ```bash
       # Local machine
       git remote add origin <REPO_URL>  # if not already set
       git push -u origin main
       ```

    4. **Copy deploy config into the repo on server:**
       ```bash
       cp /home/ubuntu/deploy-temp/* /home/ubuntu/aegis/deploy/
       ```

    5. **Update Nginx config with server_name:**
       - If a domain is available: update `server_name _;` to `server_name yourdomain.com www.yourdomain.com;`
       - If no domain: leave as `server_name _;` (responds to any hostname, including static IP)
       - Reload: `sudo nginx -t && sudo systemctl reload nginx`

    6. **Verify services are running:**
       ```bash
       node --version    # Should be 20.x
       pnpm --version    # Should be installed
       pm2 --version     # Should be installed
       nginx -t          # Should be ok
       sudo systemctl status nginx  # Should be active
       ```

    NOTE: If SSH access fails or the server is not yet provisioned, this task will pause and create a checkpoint for the user. The static IP and SSH key info should come from the 04-05 SUMMARY.
  </action>
  <verify>
    - SSH into server works
    - `node --version` returns 20.x
    - `pnpm --version` returns a version
    - `pm2 --version` returns a version
    - `nginx -t` returns "syntax is ok"
    - Git repo cloned to /home/ubuntu/aegis
    - `ls /home/ubuntu/aegis/package.json` exists
  </verify>
  <done>Server has Node.js 20, pnpm, PM2, Nginx installed; repo cloned to /home/ubuntu/aegis; Nginx configured and running</done>
</task>

<task type="checkpoint:decision" gate="blocking">
  <name>Task 2: SSL and domain configuration</name>
  <decision>Configure SSL certificate and custom domain, or use HTTP-only access via static IP?</decision>
  <context>
    SSL requires a domain name pointed to the static IP. If no domain is registered, the demo can run on HTTP via the static IP address. Let's Encrypt (Certbot) provides free SSL but requires a valid domain.
  </context>
  <options>
    <option id="option-a">
      <name>Configure SSL with custom domain</name>
      <pros>Professional demo URL, secure connection, browser shows padlock</pros>
      <cons>Requires registered domain, DNS propagation delay (up to 48h)</cons>
    </option>
    <option id="option-b">
      <name>HTTP-only via static IP (configure SSL later)</name>
      <pros>Immediate access, no domain needed, can add SSL later</pros>
      <cons>No HTTPS, browser shows "not secure", less professional for demo</cons>
    </option>
  </options>
  <resume-signal>Select: option-a (provide domain name) or option-b (proceed with IP only)</resume-signal>
</task>

</tasks>

<verification>
1. Server is accessible via SSH
2. All required software installed (Node.js, pnpm, PM2, Nginx)
3. Repository cloned to correct directory
4. Nginx is running and proxying to port 3000
5. SSL configured (if domain available) or HTTP access works via IP
</verification>

<success_criteria>
- Server fully configured with all required software
- Repository cloned and accessible
- Nginx running as reverse proxy
- SSL decision made and implemented (or deferred)
</success_criteria>

<output>
After completion, create `.planning/phases/04-polish-deploy/04-06-SUMMARY.md`
</output>
