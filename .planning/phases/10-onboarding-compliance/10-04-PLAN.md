---
phase: 10-onboarding-compliance
plan: 04
type: execute
wave: 2
depends_on: [10-03]
files_modified:
  - src/app/(onboarding)/onboarding/layout.tsx
  - src/app/(onboarding)/onboarding/page.tsx
  - src/app/(onboarding)/onboarding/_components/onboarding-wizard.tsx
  - src/app/(onboarding)/onboarding/_components/step-indicator.tsx
  - src/app/(onboarding)/onboarding/_components/step-navigation.tsx
autonomous: true

must_haves:
  truths:
    - "(onboarding) route group with minimal layout (no sidebar, no dashboard chrome)"
    - "Onboarding page checks auth: only admin/setup role can access"
    - "Already-onboarded tenant redirected to dashboard with message"
    - "Wizard orchestrator manages 5 steps via Zustand store state (not URL routing)"
    - "Step indicator shows progress (1/5, 2/5, etc.) with completed/current/upcoming states"
    - "Step navigation has Back, Next, Save & Exit buttons"
    - "Next button validates current step via Zod before advancing"
    - "Save & Exit saves to server and redirects to dashboard"
    - "Resume detection: shows 'Resume onboarding?' prompt for incomplete wizards"
  artifacts:
    - path: src/app/(onboarding)/onboarding/layout.tsx
      provides: Minimal layout without sidebar for dedicated onboarding flow
      min_lines: 15
      contains: "layout"
    - path: src/app/(onboarding)/onboarding/page.tsx
      provides: Wizard container with auth check and resume detection
      min_lines: 30
      contains: "OnboardingWizard"
    - path: src/app/(onboarding)/onboarding/_components/onboarding-wizard.tsx
      provides: Main wizard orchestrator rendering current step
      min_lines: 50
      contains: "OnboardingWizard"
    - path: src/app/(onboarding)/onboarding/_components/step-indicator.tsx
      provides: Visual step progress indicator (1-5)
      min_lines: 25
      contains: "StepIndicator"
    - path: src/app/(onboarding)/onboarding/_components/step-navigation.tsx
      provides: Back/Next/Save & Exit navigation buttons
      min_lines: 25
      contains: "StepNavigation"
  key_links:
    - from: page.tsx
      to: src/lib/guards.ts
      via: Auth check for admin role
      pattern: "requirePermission"
    - from: onboarding-wizard.tsx
      to: src/stores/onboarding-store.ts
      via: Reads currentStep to determine which step component to render
      pattern: "useOnboardingStore"
    - from: step-navigation.tsx
      to: src/lib/onboarding-validation.ts
      via: Validates current step before advancing
      pattern: "validate"
---

<objective>
Create the onboarding wizard layout, page, and navigation infrastructure: route group, auth guard, step orchestrator, progress indicator, and navigation controls.

Purpose: This plan creates the skeleton that all 5 wizard steps plug into. The (onboarding) route group provides a clean, sidebar-free layout. The wizard orchestrator manages step transitions via Zustand state. Resume detection enables save-and-return.

Output: 1 layout, 1 page, 3 wizard components.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-onboarding-compliance/10-PLAN.md
@src/stores/onboarding-store.ts
@src/lib/onboarding-validation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create onboarding route group and page</name>
  <files>src/app/(onboarding)/onboarding/layout.tsx, src/app/(onboarding)/onboarding/page.tsx</files>
  <action>
**1. layout.tsx:**

Minimal layout without sidebar:

- No AppSidebar, no TopBar
- Centered max-width container
- AEGIS logo/text header at top
- White background, clean design
- Responsive (works on iPad for Tier III/IV UCB staff)

**2. page.tsx:**

Server component with guards:

- Check authentication via session
- Check user has admin/setup permission → 403 if not
- Check tenant.onboardingCompleted → redirect to /dashboard with "Onboarding already completed" if true
- If not yet onboarded: render `<OnboardingWizard />`
- Pass session data as props to wizard
  </action>
  <verify>Run `pnpm build`. Verify layout has no sidebar. Verify page checks auth and onboarding status. Verify redirect for already-onboarded tenants.</verify>
  <done>Onboarding route group with minimal layout and auth-guarded page.</done>
  </task>

<task type="auto">
  <name>Task 2: Create wizard orchestrator, step indicator, and navigation</name>
  <files>src/app/(onboarding)/onboarding/_components/onboarding-wizard.tsx, src/app/(onboarding)/onboarding/_components/step-indicator.tsx, src/app/(onboarding)/onboarding/_components/step-navigation.tsx</files>
  <action>
**1. onboarding-wizard.tsx — Client component:**

Main wizard orchestrator:

- Reads `currentStep` from Zustand store
- Renders appropriate step component based on currentStep (1-5)
- Step component registry: maps step number to component
- On mount: check if expired (30 days) → clear and restart if so
- Resume detection: if store has data and currentStep > 1, show "Resume onboarding?" dialog
- Shows welcome screen before Step 1 with: "Typical onboarding takes 15-20 minutes"
- Step 5 has "Complete Onboarding" button instead of "Next"

**2. step-indicator.tsx:**

Visual progress indicator:

- 5 steps displayed as numbered circles connected by lines
- States: completed (green check), current (blue filled), upcoming (gray outline)
- Step labels: "Bank Info", "Tier", "RBI Directions", "Organization", "Users"
- Responsive: horizontal on desktop, compact on mobile

**3. step-navigation.tsx:**

Navigation controls:

- "Back" button: disabled on Step 1, goes to previous step
- "Next" button: validates current step via Zod schema, advances if valid, shows errors if invalid
- "Save & Exit" button: saves current state to server (via server action), redirects to /dashboard
- On Step 5: "Next" replaced with "Complete Onboarding" (triggers completion flow)
- Props: `currentStep`, `onNext()`, `onBack()`, `onSaveAndExit()`, `isValidating`, `isSubmitting`
  </action>
  <verify>Run `pnpm build`. Verify wizard renders correct step component. Verify step indicator shows 5 steps with correct states. Verify navigation validates before advancing.</verify>
  <done>Wizard orchestrator with step routing, resume detection, progress indicator, and validated navigation.</done>
  </task>

</tasks>

<verification>
1. `pnpm build` succeeds
2. (onboarding) route group has no sidebar layout
3. Page redirects already-onboarded tenants to dashboard
4. Wizard reads currentStep from Zustand store
5. Step indicator shows completed/current/upcoming states
6. Next button validates current step before advancing
7. Save & Exit persists to server and redirects
8. Resume detection prompts for incomplete wizards
9. Welcome screen shown on first visit
</verification>

<success_criteria>

- 5-step wizard navigation works (ONBD-01)
- Save and return later supported (ONBD-06)
- Auth guard prevents non-admin access
- Already-onboarded tenants cannot re-enter wizard
- Progress indicator shows step completion status
- Validation prevents proceeding with invalid data
  </success_criteria>

<output>
After completion, create `.planning/phases/10-onboarding-compliance/10-04-SUMMARY.md`
</output>
