---
phase: 10-onboarding-compliance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - prisma/migrations/YYYYMMDD_onboarding_models.sql
autonomous: true

must_haves:
  truths:
    - "RbiMasterDirection model exists (global, not tenant-scoped) with shortId, title, category"
    - "RbiChecklistItem model exists (global) with tierApplicability array, frequency, evidenceRequired, priority"
    - "OnboardingProgress model exists (tenant-scoped) with currentStep, completedSteps, stepData JSON, status, expiresAt"
    - "UserStatus enum replaces string status: INVITED, ACTIVE, INACTIVE, SUSPENDED"
    - "User model has invitation fields: invitedAt, invitedBy, inviteTokenHash, inviteExpiry"
    - "Tenant model has onboarding fields: established, pan, cin, registrationNo, registeredWith, onboardingCompleted, onboardingCompletedAt"
    - "ComplianceRequirement model has new fields: title, description, priority, frequency, evidenceRequired, isCustom, sourceItemCode"
    - "RLS policies on OnboardingProgress (tenant-scoped), no RLS on global RbiMasterDirection/RbiChecklistItem"
  artifacts:
    - path: prisma/schema.prisma
      provides: RbiMasterDirection, RbiChecklistItem, OnboardingProgress models + User/Tenant/ComplianceRequirement extensions
      contains: "model RbiMasterDirection"
    - path: prisma/migrations/YYYYMMDD_onboarding_models.sql
      provides: Migration SQL with RLS policies and indexes
      min_lines: 30
      contains: "RbiMasterDirection"
  key_links:
    - from: RbiChecklistItem
      to: RbiMasterDirection
      via: masterDirectionId FK
      pattern: "masterDirectionId"
    - from: OnboardingProgress
      to: Tenant
      via: tenantId FK (one-to-one)
      pattern: "tenantId"
    - from: ComplianceRequirement
      to: RbiChecklistItem
      via: sourceItemCode string reference (not FK â€” for traceability)
      pattern: "sourceItemCode"
---

<objective>
Add database schema for onboarding wizard, RBI Master Direction templates, and compliance seeding support.

Purpose: This plan adds the schema foundation for onboarding: global RBI checklist templates (not tenant-scoped), onboarding progress tracking, and extensions to existing User/Tenant/ComplianceRequirement models. The UserStatus enum replaces the string-based status field.

Output: Updated Prisma schema with 3 new models, 1 new enum, and field additions to 3 existing models.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-onboarding-compliance/10-PLAN.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add new models and enum to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
**1. UserStatus enum:**

```prisma
enum UserStatus {
  INVITED
  ACTIVE
  INACTIVE
  SUSPENDED
}
```

**2. RbiMasterDirection model (global, no tenantId):**

- id: UUID
- shortId: String @unique ("MD-CAP", "MD-IRAC", etc.)
- title: String
- description: String? @db.Text
- rbiRef: String?
- category: String
- Relation: checklistItems RbiChecklistItem[]
- createdAt, updatedAt

**3. RbiChecklistItem model (global, no tenantId):**

- id: UUID
- masterDirectionId: UUID FK
- itemCode: String @unique ("MD-CAP-001")
- title: String
- description: String @db.Text
- category: String
- tierApplicability: UcbTier[] (PostgreSQL array)
- tierEnhancements: Json?
- frequency: String
- evidenceRequired: String[]
- priority: String
- rbiCircularRef: String?
- rbiCircularUrl: String?
- Index on masterDirectionId
- createdAt, updatedAt

**4. OnboardingProgress model (tenant-scoped):**

- id: UUID
- tenantId: UUID @unique (one-to-one with Tenant)
- currentStep: Int @default(1)
- completedSteps: Int[] @default([])
- stepData: Json?
- status: String @default("in_progress")
- expiresAt: DateTime?
- Index on tenantId
- createdAt, updatedAt
  </action>
  <verify>Run `pnpm build`. Verify 3 new models and 1 new enum in schema. Verify RbiMasterDirection and RbiChecklistItem have no tenantId (global). Verify OnboardingProgress has tenantId.</verify>
  <done>Three new models (RbiMasterDirection, RbiChecklistItem, OnboardingProgress) and UserStatus enum added to Prisma schema.</done>
  </task>

<task type="auto">
  <name>Task 2: Extend existing models and create migration</name>
  <files>prisma/schema.prisma, prisma/migrations/YYYYMMDD_onboarding_models.sql</files>
  <action>
**1. User model additions:**

- Change `status` field to use `UserStatus` enum: `status UserStatus @default(ACTIVE)`
- Add: `invitedAt DateTime?`
- Add: `invitedBy String? @db.Uuid`
- Add: `inviteTokenHash String? @unique`
- Add: `inviteExpiry DateTime?`
- Add relation: `branchAssignments UserBranchAssignment[]` (if not already from Phase 7)

**2. Tenant model additions:**

- Add: `established DateTime?`
- Add: `pan String?`
- Add: `cin String?`
- Add: `registrationNo String?`
- Add: `registeredWith String?`
- Add: `onboardingCompleted Boolean @default(false)`
- Add: `onboardingCompletedAt DateTime?`
- Add relation: `onboardingProgress OnboardingProgress?`

**3. ComplianceRequirement model additions:**

- Add: `title String?`
- Add: `description String? @db.Text`
- Add: `priority String?`
- Add: `frequency String?`
- Add: `evidenceRequired String[]`
- Add: `isCustom Boolean @default(false)`
- Add: `sourceItemCode String?`

**4. Migration SQL:**

- Generate Prisma migration
- Add RLS policy on OnboardingProgress (tenant-scoped)
- No RLS on RbiMasterDirection/RbiChecklistItem (global, shared data)
- Add audit trigger on OnboardingProgress
- Index on User.inviteTokenHash for fast lookup
  </action>
  <verify>Run `pnpm build`. Verify User has UserStatus enum and invite fields. Verify Tenant has onboarding fields. Verify ComplianceRequirement has new fields. Verify RLS policy on OnboardingProgress only.</verify>
  <done>Existing models extended with onboarding fields. Migration SQL with RLS policies and indexes.</done>
  </task>

</tasks>

<verification>
1. `pnpm build` succeeds
2. RbiMasterDirection and RbiChecklistItem models exist (global, no tenantId)
3. OnboardingProgress model exists with tenant scope
4. UserStatus enum has 4 values (INVITED, ACTIVE, INACTIVE, SUSPENDED)
5. User model has invitation fields (inviteTokenHash, inviteExpiry)
6. Tenant model has onboarding tracking fields
7. ComplianceRequirement has sourceItemCode for template traceability
8. RLS policy on OnboardingProgress, not on global tables
</verification>

<success_criteria>

- Schema supports onboarding wizard data persistence
- Global RBI checklist templates available for compliance seeding (CMPL-01)
- User invitation flow supported by schema (ONBD-04)
- Onboarding progress tracking for save-and-return (ONBD-06)
- ComplianceRequirement extended for seeded vs custom distinction (CMPL-04)
  </success_criteria>

<output>
After completion, create `.planning/phases/10-onboarding-compliance/10-01-SUMMARY.md`
</output>
