---
phase: 07-auditee-portal-evidence
plan: 08
type: execute
wave: 4
depends_on: [07-06, 07-07]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Auditee sees only observations assigned to their branch/department (AUD-01)"
    - "Auditee can submit clarification/response with text explanation (AUD-02)"
    - "Auditee can upload evidence files via drag-and-drop with progress indicator (AUD-03, EVID-01)"
    - "Files are stored in AWS S3 Mumbai with tenant-scoped paths and encryption (EVID-02)"
    - "Auditee responses and evidence uploads are timestamped and immutable (AUD-04)"
    - "Auditee sees deadline countdown for each pending item and overdue items are visually highlighted (AUD-06, AUD-07)"
    - "Evidence appears in observation timeline with timestamp and uploader (EVID-04)"
  artifacts: []
  key_links: []
---

<objective>
Verify the complete auditee portal and evidence system works end-to-end: branch-scoped access, response submission, evidence upload, deadline tracking, and immutability.

Purpose: All plans have been implemented individually. This checkpoint verifies the integrated workflow works correctly and matches the 7 success criteria from the phase definition.

Output: Verified working auditee portal or list of issues to fix.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-auditee-portal-evidence/07-06-SUMMARY.md
@.planning/phases/07-auditee-portal-evidence/07-07-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete auditee portal with branch-scoped observation access, response submission with immutability, evidence upload via S3 presigned URLs, deadline countdown, and observation timeline integration.</what-built>
  <how-to-verify>
**Prerequisites:** Docker must be running with PostgreSQL. Run `pnpm db:seed` to populate demo data (including UserBranchAssignment records). Start dev server with `pnpm dev`. Ensure S3 bucket exists (or use LocalStack for local testing).

**Test 1: Branch-Scoped Access (AUD-01)**

1. Log in as Auditee for Branch A (e.g., Vikram Kulkarni, Main Branch)
2. Navigate to /auditee
3. Verify only observations for Main Branch are shown
4. Try navigating directly to an observation URL for a different branch
5. Verify 404 page is shown (not leaking observation existence)
6. Log in as AUDITOR role → verify /auditee is not accessible (403 redirect)

**Test 2: Summary Cards & Overdue Banner (AUD-06, AUD-07)**

1. On /auditee page, verify 4 summary cards: pending response, awaiting review, overdue, total
2. If overdue observations exist, verify red overdue banner appears at top
3. Verify deadline badges show correct colors:
   - > 7 days: normal muted text
   - 3-7 days: amber
   - <24 hours: red with animation
   - Overdue: red background

**Test 3: Submit Response (AUD-02, AUD-04)**

1. Open an ISSUED observation
2. Select response type: "Clarification"
3. Enter response text (>10 chars)
4. Click Submit → verify confirmation dialog warns about immutability
5. Confirm submission
6. Verify:
   - AuditeeResponse created (no edit/delete buttons visible)
   - Timeline shows "auditee_response" entry with actor name and timestamp
   - If first response on ISSUED observation, status transitions to RESPONSE

**Test 4: Upload Evidence (AUD-03, EVID-01, EVID-03)**

1. On an active observation, find the evidence upload section
2. Drag a PDF file (< 10MB) onto the drop zone
3. Verify progress bar appears and fills to 100%
4. Verify file appears in evidence list with filename, size, timestamp, uploader
5. Try uploading a .exe or .bat file → verify rejection error
6. Try uploading a file > 10MB → verify size rejection
7. Verify evidence count shows "X of 20"

**Test 5: S3 Storage Verification (EVID-02)**

1. After uploading evidence, verify in AWS console (or LocalStack):
   - File exists at `{tenantId}/evidence/{observationId}/{uuid}.ext`
   - File has SSE-S3 encryption
   - Bucket is in ap-south-1 (Mumbai)

**Test 6: Evidence Download (EVID-05)**

1. In the evidence list, click download button
2. Verify file downloads successfully
3. Verify correct file content matches what was uploaded

**Test 7: Immutability (AUD-04, AUD-05)**

1. Submit a response → verify no edit or delete buttons appear
2. Upload evidence → verify no delete button on evidence
3. Verify all responses shown in chronological order with timestamps
4. Check AuditLog for entries corresponding to response and evidence actions

**Test 8: Evidence in Timeline (EVID-04)**

1. Open observation with uploaded evidence
2. Scroll to timeline section
3. Verify "Evidence uploaded: filename.pdf by User Name" entry with timestamp
4. Verify "Auditee response" entry for submitted responses
5. Verify timeline is in chronological order

**Test 9: Response Types (AUD-05)**

1. Submit a "Compliance Action" response → verify action plan text area appears
2. Submit an "Extension Request" response → verify it creates timeline entry
3. Verify all response types are captured correctly
   </how-to-verify>
   <resume-signal>Type "approved" to mark Phase 7 complete, or describe any issues found.</resume-signal>
   </task>

</tasks>

<verification>
All 9 test groups pass manually in the browser.
</verification>

<success_criteria>
Phase 7 success criteria verified:

1. Auditee sees only observations assigned to their branch/department (AUD-01)
2. Auditee can submit clarification/response with text explanation (AUD-02)
3. Auditee can upload evidence files (PDF, JPEG, PNG, XLSX, DOCX) via drag-and-drop with progress indicator (AUD-03, EVID-01)
4. Files are stored in AWS S3 Mumbai with tenant-scoped paths and encryption (EVID-02)
5. Auditee responses and evidence uploads are timestamped and immutable (AUD-04)
6. Auditee sees deadline countdown for each pending item and overdue items are visually highlighted (AUD-06, AUD-07)
7. Evidence appears in observation timeline with timestamp and uploader (EVID-04)
   </success_criteria>

<output>
After completion, create `.planning/phases/07-auditee-portal-evidence/07-08-SUMMARY.md`
</output>
