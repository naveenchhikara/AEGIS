---
phase: 13-onboarding-persistence
plan: 02
type: execute
wave: 1
depends_on:
  - "13-01"
files_modified:
  - src/lib/excel-templates/org-structure-template.ts
  - src/lib/excel-parsers/org-structure-parser.ts
  - src/actions/onboarding-excel-upload.ts
  - src/app/(onboarding)/onboarding/_components/excel-upload-zone.tsx
  - src/app/(onboarding)/onboarding/_components/step-4-org-structure.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can click 'Download Template' and receive a .xlsx file with Branches and Departments worksheets, styled headers, data validation dropdowns, and example rows"
    - "Admin can drag-and-drop or browse-select a filled .xlsx file and see parsed branches/departments populate the existing org structure form"
    - "Invalid files (wrong extension, wrong MIME type, corrupted, missing worksheets, bad data) show clear error messages without crashing"
    - "Uploaded data replaces current org structure entries in the Zustand store and auto-saves via existing debounce"
  artifacts:
    - path: "src/lib/excel-templates/org-structure-template.ts"
      provides: "Excel template generation function returning Buffer"
      exports: ["generateOrgStructureTemplate"]
    - path: "src/lib/excel-parsers/org-structure-parser.ts"
      provides: "Excel parsing with multi-layer validation"
      exports: ["parseOrgStructureExcel"]
    - path: "src/actions/onboarding-excel-upload.ts"
      provides: "Server action accepting FormData, validating, and returning parsed data"
      exports: ["uploadOrgStructureExcel", "downloadOrgStructureTemplate"]
    - path: "src/app/(onboarding)/onboarding/_components/excel-upload-zone.tsx"
      provides: "Dropzone UI component for file upload with status feedback"
      contains: "useDropzone"
    - path: "src/app/(onboarding)/onboarding/_components/step-4-org-structure.tsx"
      provides: "Updated Step 4 with Excel upload tab alongside manual entry"
      contains: "ExcelUploadZone"
  key_links:
    - from: "src/actions/onboarding-excel-upload.ts"
      to: "src/lib/excel-parsers/org-structure-parser.ts"
      via: "import parseOrgStructureExcel"
      pattern: "parseOrgStructureExcel"
    - from: "src/actions/onboarding-excel-upload.ts"
      to: "src/lib/excel-templates/org-structure-template.ts"
      via: "import generateOrgStructureTemplate"
      pattern: "generateOrgStructureTemplate"
    - from: "src/app/(onboarding)/onboarding/_components/excel-upload-zone.tsx"
      to: "src/actions/onboarding-excel-upload.ts"
      via: "server action call for upload and download"
      pattern: "uploadOrgStructureExcel|downloadOrgStructureTemplate"
    - from: "src/app/(onboarding)/onboarding/_components/step-4-org-structure.tsx"
      to: "src/app/(onboarding)/onboarding/_components/excel-upload-zone.tsx"
      via: "renders ExcelUploadZone with onImport callback"
      pattern: "ExcelUploadZone"
---

<objective>
Add Excel template download and upload for onboarding org structure (Step 4), giving admins an alternative to manual row-by-row entry.

Purpose: UCB admins often already have branch/department data in spreadsheets. Providing an Excel template for bulk import closes ONBD-03 (partial -> satisfied) and dramatically reduces data entry time for banks with 10+ branches.

Output: Download template button + drag-and-drop upload zone in Step 4 org structure, backed by server-side Excel generation and parsing with multi-layer security validation.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/13-onboarding-persistence/13-RESEARCH.md
@.planning/phases/13-onboarding-persistence/13-01-SUMMARY.md
@src/types/onboarding.ts
@src/stores/onboarding-store.ts
@src/app/(onboarding)/onboarding/_components/step-4-org-structure.tsx
@next.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Excel template generator and parser modules</name>
  <files>
    src/lib/excel-templates/org-structure-template.ts
    src/lib/excel-parsers/org-structure-parser.ts
  </files>
  <action>
**src/lib/excel-templates/org-structure-template.ts:**

Create an async function `generateOrgStructureTemplate()` that returns a `Buffer` containing a .xlsx file with two worksheets:

1. **"Branches" worksheet:**
   - Columns: Branch Name* | Branch Code* | City* | State* | Type\* | Manager Name | Manager Email
   - Column widths: 30, 15, 20, 20, 20, 25, 30
   - Header row (row 1): bold font, light gray fill (`FFE0E0E0`), border on bottom
   - Data validation on Type column (column 5) for rows 2-100: dropdown list with values `"HO,Branch,Extension Counter"` (matches `BRANCH_TYPES` in step-4-org-structure.tsx)
   - Data validation on State column (column 4) for rows 2-100: dropdown list with all Indian states (same list as `INDIAN_STATES` in step-4-org-structure.tsx — hardcode the full list of 31 states/UTs)
   - Example row (row 2): `Head Office | HO | Mumbai | Maharashtra | HO | Rajesh Kumar | rajesh@bank.com` — styled with italic font + light blue fill (`FFE8F0FE`) to distinguish from real data
   - Second example row (row 3): `Andheri Branch | BR001 | Mumbai | Maharashtra | Branch | Priya Sharma | priya@bank.com`
   - Add a note in cell A1 comment or a "Instructions" row above the header explaining: "Fill in your branch data starting from row 4. Delete example rows 2-3 before uploading."

2. **"Departments" worksheet:**
   - Columns: Department Name* | Department Code* | Head of Department | Head Email
   - Column widths: 30, 15, 25, 30
   - Same header styling as Branches (bold, gray fill, bottom border)
   - Example row: `Audit | AUD | | ` (matches DEFAULT_DEPARTMENT in step-4)
   - Second example row: `Credit | CRD | | `

Use `import ExcelJS from "exceljs"` (already in serverExternalPackages). Generate workbook buffer via `await workbook.xlsx.writeBuffer()` and return as `Buffer`.

**src/lib/excel-parsers/org-structure-parser.ts:**

Create an async function `parseOrgStructureExcel(buffer: Buffer)` that returns:

```typescript
type ParseResult =
  | {
      success: true;
      data: { branches: BranchEntry[]; departments: DepartmentEntry[] };
      warnings: string[];
    }
  | {
      success: false;
      error: string;
    };
```

Import types `BranchEntry` and `DepartmentEntry` from `@/types/onboarding`.

Implementation:

1. Load workbook from buffer via `new ExcelJS.Workbook()` + `await workbook.xlsx.load(buffer)`.
2. Get "Branches" worksheet — if missing, return error "Missing 'Branches' worksheet. Please use the provided template."
3. Get "Departments" worksheet — if missing, return error "Missing 'Departments' worksheet. Please use the provided template."
4. Parse Branches worksheet:
   - Skip row 1 (header). For each subsequent row:
   - Read cells: name (col 1), code (col 2), city (col 3), state (col 4), type (col 5), managerName (col 6), managerEmail (col 7)
   - Use `.toString().trim()` on each cell value, handle null/undefined as empty string
   - Skip completely empty rows (all fields empty)
   - Validate required fields (name, code, city, state, type) — collect warnings for rows with missing required fields but don't reject the whole file
   - Normalize type: accept "HO", "Head Office", "Branch", "Extension Counter", "EC" — map "Head Office" to "HO", "EC" to "Extension Counter"
   - Validate type is one of the three allowed values after normalization — add warning if unknown type
   - Collect into `BranchEntry[]`
5. Parse Departments worksheet:
   - Skip row 1 (header). For each subsequent row:
   - Read cells: name (col 1), code (col 2), headName (col 3), headEmail (col 4)
   - Same empty row skipping and trimming
   - Validate required: name, code — add warning for missing
   - Uppercase the code value
   - Collect into `DepartmentEntry[]`
6. If both arrays are empty, return error "No data found in the uploaded file. Please check that you filled in the template."
7. Return `{ success: true, data: { branches, departments }, warnings }`.

Keep warnings array as `string[]` like: `"Row 5 in Branches: missing required field 'City'"`, `"Row 3 in Branches: unknown type 'Regional' — defaulting to 'Branch'"`.
</action>
<verify>
Run `pnpm tsc --noEmit` — should pass with 0 errors. Verify exports: `grep -n "export" src/lib/excel-templates/org-structure-template.ts src/lib/excel-parsers/org-structure-parser.ts`. Verify the parser imports BranchEntry/DepartmentEntry from types: `grep "BranchEntry\|DepartmentEntry" src/lib/excel-parsers/org-structure-parser.ts`.
</verify>
<done>
Two pure utility modules exist: template generator returns styled .xlsx Buffer with two worksheets + data validation + example rows; parser reads .xlsx Buffer and returns typed BranchEntry[] + DepartmentEntry[] with row-level warnings. Both compile cleanly.
</done>
</task>

<task type="auto">
  <name>Task 2: Create server actions and upload UI, integrate into Step 4</name>
  <files>
    src/actions/onboarding-excel-upload.ts
    src/app/(onboarding)/onboarding/_components/excel-upload-zone.tsx
    src/app/(onboarding)/onboarding/_components/step-4-org-structure.tsx
  </files>
  <action>
**src/actions/onboarding-excel-upload.ts:**

Create two server actions (`"use server"` at top):

1. `downloadOrgStructureTemplate()`:
   - Call `generateOrgStructureTemplate()` from `@/lib/excel-templates/org-structure-template.ts`
   - Convert Buffer to base64 string: `buffer.toString("base64")`
   - Return `{ success: true, data: base64String, filename: "aegis-org-structure-template.xlsx" }`
   - No auth check needed — template is generic, no tenant data

2. `uploadOrgStructureExcel(formData: FormData)`:
   - Extract file: `formData.get("file") as File`
   - If no file: return `{ success: false, error: "No file provided" }`
   - **Layer 1 — Extension:** Check `file.name.endsWith(".xlsx")`. If not: return error "Only .xlsx files are supported. Please save your file as Excel Workbook (.xlsx)."
   - **Layer 2 — Size:** Check `file.size <= 2 * 1024 * 1024` (2MB limit for Excel). If over: return error "File too large. Maximum size is 2MB."
   - **Layer 3 — MIME type:** Check `file.type` is `"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"` or empty string (some browsers don't set MIME for drag-drop). If wrong MIME and not empty: return error.
   - **Layer 4 — Magic bytes:** `const arrayBuffer = await file.arrayBuffer(); const buffer = Buffer.from(arrayBuffer);`. Import `fileTypeFromBuffer` from `file-type`. Check result MIME equals xlsx MIME. If not: return error "File content does not match .xlsx format. The file may be corrupted or a different format renamed to .xlsx."
   - **Layer 5 — Parse:** Call `parseOrgStructureExcel(buffer)` from `@/lib/excel-parsers/org-structure-parser.ts`. Return the parse result directly (it already has success/error shape).
   - Return type: `{ success: true; data: { branches: BranchEntry[]; departments: DepartmentEntry[] }; warnings: string[] } | { success: false; error: string }`

**src/app/(onboarding)/onboarding/\_components/excel-upload-zone.tsx:**

Create a `"use client"` component `ExcelUploadZone` with props:

```typescript
interface ExcelUploadZoneProps {
  onImport: (data: {
    branches: BranchEntry[];
    departments: DepartmentEntry[];
  }) => void;
}
```

Implementation:

1. Use `useDropzone` from `react-dropzone` with config: `accept: { "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet": [".xlsx"] }`, `maxFiles: 1`, `multiple: false`.
2. State: `status: "idle" | "uploading" | "success" | "error"`, `errorMessage: string | null`, `warnings: string[]`, `importedCounts: { branches: number; departments: number } | null`.
3. `onDrop` handler:
   - Set status "uploading"
   - Create `FormData`, append file as "file"
   - Call `uploadOrgStructureExcel(formData)` (imported from server action)
   - If success: set status "success", set warnings, set importedCounts, call `onImport(result.data)` after a 500ms delay (so user sees the success state)
   - If error: set status "error", set errorMessage
4. **Download template button:** On click, call `downloadOrgStructureTemplate()` server action. Decode base64 to Blob, create object URL, trigger download via hidden `<a>` element with `download` attribute set to the filename. Import `Download` icon from `@/lib/icons`.
5. **UI layout (inside a Card or bordered div):**
   - Top section: "Download Template" button (outline variant, Download icon) + brief instruction text "Download the Excel template, fill in your branches and departments, then upload below."
   - Dropzone area: dashed border div with `getRootProps()`/`getInputProps()`. Shows:
     - idle: Upload icon + "Drag & drop .xlsx file here, or click to browse" + "Maximum 2MB" subtext
     - uploading: Loader2 spinner + "Processing..."
     - success: CheckCircle icon (green) + "Imported {N} branches and {M} departments" + warnings list if any (yellow Alert)
     - error: XCircle icon (red) + error message + "Try again" link that resets to idle
   - Import icons from `@/lib/icons`: `Upload, Download, Loader2, CheckCircle, XCircle, AlertTriangle, FileSpreadsheet`

Use Tailwind for styling. Match the existing step-4 aesthetic (Card borders, muted text, same spacing). Use `cn()` from `@/lib/utils`.

**src/app/(onboarding)/onboarding/\_components/step-4-org-structure.tsx:**

Modify the existing component to add an Excel upload option:

1. Add a new top-level tab structure ABOVE the existing Departments/Branches tabs. Use a two-option segmented control or simple Tabs with values "manual" and "excel":
   - "Manual Entry" tab: contains the existing Departments/Branches tabbed UI (everything currently inside `<CardContent>`)
   - "Excel Upload" tab: contains `<ExcelUploadZone onImport={handleExcelImport} />`

2. Add `handleExcelImport` function:
   ```typescript
   const handleExcelImport = (data: {
     branches: BranchEntry[];
     departments: DepartmentEntry[];
   }) => {
     if (data.departments.length > 0) {
       setDepartments(data.departments);
     }
     if (data.branches.length > 0) {
       setBranches(data.branches);
     }
     // Switch to manual entry tab so user can review/edit imported data
     setEntryMethod("manual");
   };
   ```
3. Add state for the entry method toggle: `const [entryMethod, setEntryMethod] = useState<"manual" | "excel">("manual");`
4. Wrap the existing tabs content in conditional rendering based on `entryMethod`.
5. Import `ExcelUploadZone` and `FileSpreadsheet` icon.
6. The outer Card header should add a small "or upload Excel" hint text next to "Organization Structure" title.
   </action>
   <verify>
   Run `pnpm tsc --noEmit` — 0 errors. Run `pnpm build` — should succeed. Verify server action exists: `grep -n "uploadOrgStructureExcel\|downloadOrgStructureTemplate" src/actions/onboarding-excel-upload.ts`. Verify upload zone renders dropzone: `grep -n "useDropzone\|getRootProps" src/app/(onboarding)/onboarding/_components/excel-upload-zone.tsx`. Verify Step 4 integrates upload: `grep -n "ExcelUploadZone\|handleExcelImport\|entryMethod" src/app/(onboarding)/onboarding/_components/step-4-org-structure.tsx`.
   </verify>
   <done>
   Complete Excel upload flow works end-to-end: admin downloads template via server action, fills it in Excel, uploads via drag-and-drop or file picker, server validates (extension + size + MIME + magic bytes + parse), returns parsed BranchEntry[] + DepartmentEntry[] to client, which populates the existing Zustand org structure state. Step 4 has a "Manual Entry" / "Excel Upload" toggle. After successful import, view switches to manual entry so admin can review and edit. Build passes cleanly.
   </done>
   </task>

</tasks>

<verification>
1. `pnpm tsc --noEmit` passes with 0 errors
2. `pnpm build` completes successfully
3. Template generator creates valid .xlsx: `grep -n "generateOrgStructureTemplate" src/lib/excel-templates/org-structure-template.ts`
4. Parser handles both worksheets: `grep -n "Branches\|Departments" src/lib/excel-parsers/org-structure-parser.ts`
5. Server actions have multi-layer validation: `grep -n "Extension\|MIME\|magic\|fileTypeFromBuffer" src/actions/onboarding-excel-upload.ts`
6. Upload zone uses react-dropzone: `grep -n "useDropzone" src/app/(onboarding)/onboarding/_components/excel-upload-zone.tsx`
7. Step 4 has both manual and excel entry methods: `grep -n "entryMethod\|ExcelUploadZone" src/app/(onboarding)/onboarding/_components/step-4-org-structure.tsx`
</verification>

<success_criteria>

- Admin can download a styled .xlsx template with Branches + Departments worksheets, data validation dropdowns for Type and State, and example rows
- Admin can upload a filled .xlsx file via drag-and-drop or file picker in Step 4
- Multi-layer validation catches invalid files with clear error messages
- Parsed data populates the existing manual entry form (branches + departments) via Zustand store
- View switches to manual entry after import so admin can review/edit
- Warnings shown for rows with missing optional fields without blocking import
- TypeScript compiles cleanly, production build passes
  </success_criteria>

<output>
After completion, create `.planning/phases/13-onboarding-persistence/13-02-SUMMARY.md`
</output>
