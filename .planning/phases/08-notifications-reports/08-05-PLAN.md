---
phase: 08-notifications-reports
plan: 05
type: execute
wave: 2
depends_on: [08-01]
files_modified:
  - src/lib/excel-export.ts
  - src/app/api/exports/findings/route.ts
  - src/app/api/exports/compliance/route.ts
  - src/app/api/exports/audit-plans/route.ts
  - src/data-access/exports.ts
autonomous: true

must_haves:
  truths:
    - "Findings exported as formatted XLSX with severity color-coding (EXP-01)"
    - "Compliance requirements exported as formatted XLSX (EXP-02)"
    - "Audit plans exported as formatted XLSX (EXP-03)"
    - "All exports respect role permissions — users see only data they're authorized to view (EXP-04)"
    - "Every XLSX has bank name header, date, confidentiality notice in rows 1-3 (EXP-05)"
    - "Column headers have dark background, white text, auto-filter enabled"
    - "Alternating row colors for readability"
    - "Date formatting uses Indian locale (DD/MM/YYYY)"
  artifacts:
    - path: src/lib/excel-export.ts
      provides: Shared ExcelJS utilities for workbook creation with bank header and formatting
      min_lines: 60
      contains: "createWorkbook"
    - path: src/app/api/exports/findings/route.ts
      provides: Findings XLSX export endpoint with role filtering
      min_lines: 40
      contains: "GET"
    - path: src/app/api/exports/compliance/route.ts
      provides: Compliance XLSX export endpoint
      min_lines: 30
      contains: "GET"
    - path: src/app/api/exports/audit-plans/route.ts
      provides: Audit plans XLSX export endpoint with role filtering
      min_lines: 30
      contains: "GET"
    - path: src/data-access/exports.ts
      provides: DAL for export data queries with role-based filtering
      min_lines: 50
      contains: "getExportFindings"
  key_links:
    - from: All route.ts files
      to: src/lib/excel-export.ts
      via: Shared workbook creation and formatting utilities
      pattern: "createWorkbook"
    - from: All route.ts files
      to: src/data-access/exports.ts
      via: Role-filtered data queries
      pattern: "getExport"
---

<objective>
Implement XLSX export for findings, compliance, and audit plans with role-based filtering and professional formatting using ExcelJS.

Purpose: Users need to export data for offline analysis, board presentations, and regulatory filings. All exports include bank branding, confidentiality notices, severity color-coding, and respect role permissions so users only see data they're authorized to access.

Output: 1 shared Excel utility, 3 API route handlers, 1 export DAL.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-notifications-reports/08-PLAN.md
@src/lib/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared Excel utilities and export DAL</name>
  <files>src/lib/excel-export.ts, src/data-access/exports.ts</files>
  <action>
**1. excel-export.ts:**

Shared ExcelJS utilities:

- `createWorkbook(bankName, exportType, date)`: Creates workbook with sheet containing:
  - Row 1: Bank name (bold, 14pt, merged across all columns)
  - Row 2: Export type and date (e.g., "Findings Export — 09 Feb 2026")
  - Row 3: "CONFIDENTIAL — For Internal Use Only" (red, italic)
  - Row 4: Empty spacer
  - Returns `{ workbook, sheet, dataStartRow: 5 }`

- `addHeaders(sheet, columns, startRow)`: Adds header row with:
  - Bold text, dark background (#1F2937), white text
  - Auto-filter enabled on all columns
  - Returns next row number

- `addDataRows(sheet, data, startRow)`: Adds data with alternating row colors (white/#F9FAFB)

- `autoFitColumns(sheet)`: Auto-size columns based on content width

- `applySeverityColor(cell, severity)`: Colors cell background based on severity:
  - CRITICAL: red (#FEE2E2)
  - HIGH: orange (#FED7AA)
  - MEDIUM: yellow (#FEF3C7)
  - LOW: green (#D1FAE5)

- `formatDateIndian(date)`: Format as DD/MM/YYYY

- `toBuffer(workbook)`: Returns workbook as Buffer for Response

**2. exports.ts (DAL):**

- `getExportFindings(session, filters?)`: Query observations with role filtering:
  - CEO/CAE/CCO: All observations
  - AUDIT_MANAGER: Observations in their assigned engagements
  - AUDITOR: Only own observations
  - AUDITEE: Only assigned to self
  - Returns: id, title, severity, status, branch, category, dueDate, assignedTo, createdAt, responseStatus

- `getExportCompliance(session)`: Query compliance requirements (CAE/CCO/CEO only)

- `getExportAuditPlans(session)`: Query audit plans with role filtering:
  - CEO/CAE/CCO: All plans
  - AUDIT_MANAGER: Plans they manage
  - AUDITOR: Assigned engagements only

All functions use `prismaForTenant()` and belt-and-suspenders WHERE tenantId.
</action>
<verify>Run `pnpm build`. Verify createWorkbook adds bank name, date, confidentiality. Verify export DAL enforces role-based filtering for each export type.</verify>
<done>Shared Excel utilities with professional formatting. Export DAL with role-based data filtering for 3 export types.</done>
</task>

<task type="auto">
  <name>Task 2: Create export API route handlers</name>
  <files>src/app/api/exports/findings/route.ts, src/app/api/exports/compliance/route.ts, src/app/api/exports/audit-plans/route.ts</files>
  <action>
**1. findings/route.ts (GET):**

- Verify authenticated session
- Parse query params: severity?, status?, branch?, dateRange?
- Fetch data via `getExportFindings(session, filters)`
- Create workbook with columns: ID, Title, Severity, Status, Branch, Risk Category, Due Date, Assigned To, Created Date, Response Status
- Apply severity color to severity column
- Format dates as DD/MM/YYYY
- Return XLSX with `Content-Disposition: attachment; filename="findings-export-{date}.xlsx"`

**2. compliance/route.ts (GET):**

- Verify CAE/CCO/CEO role
- Fetch data via `getExportCompliance(session)`
- Create workbook with columns: ID, Requirement, Category, Status, RBI Circular Ref, Owner, Next Review Date, Notes
- Apply status color-coding (Compliant=green, Non-Compliant=red, Partial=amber, Pending=gray)
- Return XLSX with appropriate filename

**3. audit-plans/route.ts (GET):**

- Verify authenticated session (role filtering in DAL)
- Fetch data via `getExportAuditPlans(session)`
- Create workbook with columns: Plan Year/Quarter, Branch, Audit Area, Status, Assigned To, Start Date, End Date, Findings Count
- Return XLSX with appropriate filename

**All routes:** Use `export const dynamic = 'force-dynamic'`. Return `Response` with content type `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`.
</action>
<verify>Run `pnpm build`. Verify all 3 routes return XLSX binary. Verify Content-Disposition headers. Verify role checks in each route.</verify>
<done>Three export routes: findings (EXP-01), compliance (EXP-02), audit plans (EXP-03). All with role filtering (EXP-04) and professional formatting (EXP-05).</done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds
2. Findings export has severity color-coding (EXP-01)
3. Compliance export available to CAE/CCO/CEO only (EXP-02, EXP-04)
4. Audit plans export has role-based filtering (EXP-03, EXP-04)
5. All exports have bank name, date, confidentiality in rows 1-3 (EXP-05)
6. Column headers have auto-filter and dark background
7. Dates formatted as DD/MM/YYYY (Indian locale)
8. Alternating row colors for readability
</verification>

<success_criteria>

- Findings exported as formatted XLSX (EXP-01)
- Compliance exported as formatted XLSX (EXP-02)
- Audit plans exported as formatted XLSX (EXP-03)
- Exports respect role permissions (EXP-04)
- Every XLSX has bank name, date, confidentiality header (EXP-05)
- Professional formatting with severity colors and auto-width
  </success_criteria>

<output>
After completion, create `.planning/phases/08-notifications-reports/08-05-SUMMARY.md`
</output>
