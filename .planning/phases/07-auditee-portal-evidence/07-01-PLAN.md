---
phase: 07-auditee-portal-evidence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - prisma/migrations/add_auditee_portal_schema.sql
autonomous: true

must_haves:
  truths:
    - "UserBranchAssignment model exists linking auditee users to branches (many-to-many)"
    - "AuditeeResponse model exists with ResponseType enum (CLARIFICATION, COMPLIANCE_ACTION, REQUEST_EXTENSION)"
    - "AuditeeResponse has createdAt but no updatedAt — responses are immutable (AUD-04)"
    - "Evidence model has description field for optional upload notes"
    - "Observation model has responseDueDate field for auditee response deadline"
    - "RLS policies exist for UserBranchAssignment and AuditeeResponse tables"
  artifacts:
    - path: prisma/schema.prisma
      provides: UserBranchAssignment, AuditeeResponse models with ResponseType enum, Evidence description field, Observation responseDueDate
      contains: "model UserBranchAssignment"
    - path: prisma/migrations/add_auditee_portal_schema.sql
      provides: RLS policies for new tables, grants for aegis_app role
      min_lines: 20
  key_links:
    - from: UserBranchAssignment
      to: User and Branch
      via: Many-to-many join table with tenantId
      pattern: "UserBranchAssignment"
    - from: AuditeeResponse
      to: Observation
      via: Foreign key with cascade delete
      pattern: "AuditeeResponse"
---

<objective>
Add database models required for the auditee portal: UserBranchAssignment (branch-scoped access), AuditeeResponse (immutable response records), Evidence description field, and Observation responseDueDate.

Purpose: The auditee portal needs to scope observations by branch assignment and store formal responses as immutable records. UserBranchAssignment is created here but populated during onboarding (Phase 10). AuditeeResponse captures typed responses (clarification, compliance action, extension request) that cannot be edited after submission.

Output: Updated Prisma schema with new models, migration SQL with RLS policies.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-auditee-portal-evidence/07-PLAN.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add auditee portal models to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add the following to the existing Prisma schema:

**1. ResponseType enum:**

```prisma
enum ResponseType {
  CLARIFICATION
  COMPLIANCE_ACTION
  REQUEST_EXTENSION
}
```

**2. UserBranchAssignment model** (cross-phase: created here, populated by Phase 10 onboarding):

```prisma
model UserBranchAssignment {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId   String @db.Uuid
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  branchId String @db.Uuid
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, branchId])
  @@index([tenantId])
  @@index([userId])
  @@index([branchId])
}
```

**3. AuditeeResponse model** (immutable — no updatedAt):

```prisma
model AuditeeResponse {
  id            String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  observationId String @db.Uuid
  observation   Observation @relation(fields: [observationId], references: [id], onDelete: Cascade)
  tenantId      String @db.Uuid
  tenant        Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  responseType  ResponseType
  content       String @db.Text
  submittedById String @db.Uuid
  submittedBy   User @relation("ResponseSubmittedBy", fields: [submittedById], references: [id])
  createdAt     DateTime @default(now())

  @@index([tenantId])
  @@index([observationId])
}
```

**4. Evidence model additions:**

- Add `description String? @db.Text` field for optional upload notes

**5. Observation model additions:**

- Add `responseDueDate DateTime?` field — deadline for auditee response (set by Audit Manager at ISSUED transition)
- Add `auditeeResponses AuditeeResponse[]` relation

**6. Add relations on User, Tenant, Branch:**

- User: `branchAssignments UserBranchAssignment[]`, `auditeeResponses AuditeeResponse[] @relation("ResponseSubmittedBy")`
- Tenant: `userBranchAssignments UserBranchAssignment[]`, `auditeeResponses AuditeeResponse[]`
- Branch: `userAssignments UserBranchAssignment[]`

Do NOT rename or move existing fields. Only ADD new fields, models, and relations.
</action>
<verify>Run `pnpm prisma validate` to confirm schema is valid. Run `pnpm prisma generate` to confirm client generates without errors.</verify>
<done>Prisma schema has UserBranchAssignment, AuditeeResponse models, ResponseType enum, Evidence.description, Observation.responseDueDate. All relations wired correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Create migration SQL for RLS policies and indexes</name>
  <files>prisma/migrations/add_auditee_portal_schema.sql</files>
  <action>
Create a SQL migration file for database objects not managed by Prisma migrate:

```sql
-- RLS policy for UserBranchAssignment
ALTER TABLE "UserBranchAssignment" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "UserBranchAssignment" FORCE ROW LEVEL SECURITY;

CREATE POLICY tenant_isolation_user_branch ON "UserBranchAssignment"
USING ("tenantId" = current_setting('app.current_tenant_id', TRUE)::uuid);

GRANT SELECT, INSERT, UPDATE, DELETE ON "UserBranchAssignment" TO aegis_app;

-- RLS policy for AuditeeResponse
ALTER TABLE "AuditeeResponse" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "AuditeeResponse" FORCE ROW LEVEL SECURITY;

CREATE POLICY tenant_isolation_auditee_response ON "AuditeeResponse"
USING ("tenantId" = current_setting('app.current_tenant_id', TRUE)::uuid);

GRANT SELECT, INSERT ON "AuditeeResponse" TO aegis_app;
-- NOTE: No UPDATE or DELETE grants — AuditeeResponse is immutable (AUD-04)

-- Index for auditee observation queries (branch-scoped)
CREATE INDEX IF NOT EXISTS idx_observation_branch_status
ON "Observation" ("tenantId", "branchId", status);

-- Index for user branch lookups
CREATE INDEX IF NOT EXISTS idx_user_branch_assignment_user
ON "UserBranchAssignment" ("userId", "tenantId");
```

</action>
<verify>SQL file exists with valid syntax. Review manually for correctness.</verify>
<done>Migration SQL has RLS policies for UserBranchAssignment and AuditeeResponse, immutability enforcement (INSERT-only grants for AuditeeResponse), and performance indexes.</done>
</task>

</tasks>

<verification>
1. `pnpm prisma validate` passes
2. `pnpm prisma generate` succeeds
3. Schema has UserBranchAssignment with unique [userId, branchId] constraint
4. Schema has AuditeeResponse with ResponseType enum, no updatedAt field
5. Evidence model has description field
6. Observation model has responseDueDate field
7. RLS migration SQL has INSERT-only grants for AuditeeResponse (immutability)
</verification>

<success_criteria>

- UserBranchAssignment model ready for Phase 10 to populate during onboarding
- AuditeeResponse model enforces immutability (no updatedAt, INSERT-only DB grants)
- ResponseType enum supports CLARIFICATION, COMPLIANCE_ACTION, REQUEST_EXTENSION
- Evidence.description allows optional upload notes
- Observation.responseDueDate supports auditee deadline tracking
- RLS policies isolate all new tables by tenant
  </success_criteria>

<output>
After completion, create `.planning/phases/07-auditee-portal-evidence/07-01-SUMMARY.md`
</output>
