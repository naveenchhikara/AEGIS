---
phase: 09-dashboards
plan: 05
type: execute
wave: 3
depends_on: [09-03, 09-04]
files_modified:
  - src/app/(dashboard)/dashboard/page.tsx
  - src/components/dashboard/dashboard-composer.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard page is server component: reads session roles, gets widget config, pre-fetches data"
    - "DashboardComposer is client component: renders responsive grid, sets up React Query polling per widget"
    - "Multi-role users see union of widget sets, deduplicated by ID, ordered by WIDGET_PRIORITY"
    - "Responsive grid: 1 col mobile, 2 col tablet, 3 col desktop"
    - "React Query polls each widget at its configured interval (30s-5min)"
    - "Skeleton loading states during poll refresh (not full page re-render)"
    - "Empty state for new tenants with onboarding guidance"
    - "FY quarter selector filters date-based widgets"
    - "Old JSON-based dashboard widget imports removed"
  artifacts:
    - path: src/app/(dashboard)/dashboard/page.tsx
      provides: Server component with role detection, widget config, and SSR data pre-fetch
      min_lines: 30
      contains: "getDashboardConfig"
    - path: src/components/dashboard/dashboard-composer.tsx
      provides: Client component composing responsive widget grid with React Query polling
      min_lines: 80
      contains: "DashboardComposer"
  key_links:
    - from: page.tsx
      to: src/lib/dashboard-config.ts
      via: getDashboardConfig(roles) determines widget set
      pattern: "getDashboardConfig"
    - from: page.tsx
      to: src/data-access/dashboard.ts
      via: getDashboardData pre-fetches SSR data
      pattern: "getDashboardData"
    - from: dashboard-composer.tsx
      to: All widget components
      via: Dynamic widget rendering based on config
      pattern: "widgets/"
---

<objective>
Rewrite the dashboard page and create the DashboardComposer that renders role-based widget grids with SSR pre-fetch and React Query polling.

Purpose: This plan ties everything together — the dashboard page reads session roles, determines which widgets to show, pre-fetches data for fast SSR, then the client-side composer sets up polling for real-time updates. Multi-role users get merged widget sets. Old JSON-based imports are removed.

Output: 1 rewritten dashboard page, 1 dashboard composer component.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-dashboards/09-PLAN.md
@src/app/(dashboard)/dashboard/page.tsx
@src/lib/dashboard-config.ts
@src/data-access/dashboard.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite dashboard page as server component</name>
  <files>src/app/(dashboard)/dashboard/page.tsx</files>
  <action>
**Rewrite dashboard page.tsx:**

Server component that:

1. Calls `requireAnyPermission(['dashboard:auditor', 'dashboard:manager', 'dashboard:cae', 'dashboard:cco', 'dashboard:ceo'])`
2. Gets user roles from session
3. Calls `getDashboardConfig(roles)` to get ordered widget configuration
4. Calls `getDashboardData(session, widgetConfig)` to pre-fetch initial data for SSR
5. Renders `<DashboardComposer widgetConfig={widgetConfig} initialData={initialData} roles={roles} />`

Handle edge cases:

- New tenant with no data: show welcome message + "Complete onboarding" guidance
- Multi-role user: widget config already handles merging + dedup
- Remove ALL old JSON-based dashboard widget imports (demo data references)
  </action>
  <verify>Run `pnpm build`. Verify page uses requireAnyPermission. Verify getDashboardConfig called with session roles. Verify no JSON demo data imports remain.</verify>
  <done>Dashboard page rewritten as server component with role detection, widget config, and SSR data pre-fetch.</done>
  </task>

<task type="auto">
  <name>Task 2: Create DashboardComposer client component</name>
  <files>src/components/dashboard/dashboard-composer.tsx</files>
  <action>
**DashboardComposer — client component ("use client"):**

**Props:**

- `widgetConfig: WidgetConfig[]` — ordered widget array
- `initialData: Record<string, unknown>` — SSR pre-fetched data keyed by dataKey
- `roles: string[]` — user's roles (for display header)

**Implementation:**

1. **Widget registry:** Map widget ID to React component:

   ```typescript
   const WIDGET_REGISTRY: Record<string, React.ComponentType<any>> = {
     "health-score": HealthScoreGauge,
     "compliance-posture": ComplianceStatusChart,
     // ... all 20 widgets
   };
   ```

2. **React Query polling per widget:**
   - Each widget wrapped in a `DashboardWidget` component
   - Uses `useQuery` with widget's `dataKey` as query key
   - `initialData` from SSR (no loading flash on first render)
   - `refetchInterval` from widget config (30s-5min)
   - `staleTime: 30_000` (30s)

3. **Responsive grid layout:**
   - CSS Grid: `grid-cols-1 md:grid-cols-2 lg:grid-cols-3`
   - Widget size maps to grid span: `full` = 3 cols, `half` = 1.5 rounded, `third` = 1 col
   - Use `col-span-full`, `md:col-span-1`, `lg:col-span-2` patterns

4. **FY quarter selector:**
   - Render FiscalYearSelector at top
   - On change: update query params for date-based widgets, trigger refetch

5. **Loading states:**
   - During React Query refetch: show subtle loading indicator (not skeleton replacement)
   - On initial SSR data: no loading state needed (data pre-fetched)
   - If widget data fails: show error card with retry button

6. **Dashboard header:**
   - Title: Role-based greeting (e.g., "Audit Dashboard", "Executive Dashboard")
   - Subtitle with current date and FY quarter
     </action>
     <verify>Run `pnpm build`. Verify DashboardComposer renders responsive grid. Verify React Query polling configured per widget. Verify SSR initial data prevents loading flash. Verify FY selector triggers refetch.</verify>
     <done>DashboardComposer with responsive grid, React Query polling, SSR hydration, FY filtering, and role-based header.</done>
     </task>

<task type="auto">
  <name>Task 3: Integration verification and cleanup</name>
  <files>src/app/(dashboard)/dashboard/page.tsx</files>
  <action>
**Verify all 5 role dashboards render correctly:**

1. Confirm Auditor dashboard shows: my-observations, engagement-progress, pending-responses, status-distribution, quick-actions
2. Confirm Manager dashboard shows: team-workload, finding-aging, audit-plan-progress, pending-reviews, severity-trend, overdue-count
3. Confirm CAE dashboard shows: health-score, audit-coverage, compliance-posture, high-critical-trend, board-readiness, branch-heatmap, daksh-score, key-metrics
4. Confirm CCO dashboard shows: compliance-registry-status, regulatory-calendar, compliance-tasks, non-compliant-items, compliance-trend, rbi-circular-impact
5. Confirm CEO dashboard shows: health-score, risk-indicators, daksh-score, executive-kpis, severity-distribution, audit-coverage, compliance-summary, pca-status, key-trends

**Multi-role test:** CAE+CCO user should see union of both widget sets, deduplicated, health-score first.

**Cleanup:**

- Remove any remaining demo data JSON imports from dashboard components
- Remove unused old dashboard widget components that were replaced
- Verify no TypeScript errors
  </action>
  <verify>Run `pnpm build`. Verify all 5 role dashboards have correct widget sets. Verify multi-role dedup works. Verify no demo data imports remain. Verify clean build with no TS errors.</verify>
  <done>All 5 role dashboards verified. Multi-role dedup tested. Old JSON imports cleaned up.</done>
  </task>

</tasks>

<verification>
1. `pnpm build` succeeds with no TypeScript errors
2. Dashboard page is server component with requireAnyPermission guard
3. DashboardComposer renders responsive grid (1/2/3 columns)
4. React Query polls each widget at configured interval
5. SSR initial data prevents loading flash on first render
6. FY quarter selector filters date-based widgets
7. All 5 role dashboards show correct widget sets (DASH-01 through DASH-05)
8. Multi-role user (CAE+CCO) sees merged, deduplicated widgets
9. Empty state shown for new tenants with onboarding guidance
10. No demo data JSON imports remain in dashboard components
</verification>

<success_criteria>

- Auditor sees personal assignments dashboard (DASH-01)
- Audit Manager sees team workload dashboard (DASH-02)
- CAE sees institutional risk dashboard (DASH-03)
- CCO sees compliance focus dashboard (DASH-04)
- CEO sees executive summary dashboard (DASH-05)
- Real-time aggregation via PostgreSQL views + React Query polling (DASH-06)
- Multi-role users see union of applicable dashboards
- Responsive grid layout (mobile/tablet/desktop)
  </success_criteria>

<output>
After completion, create `.planning/phases/09-dashboards/09-05-SUMMARY.md`
</output>
