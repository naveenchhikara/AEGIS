---
phase: 15-production-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/logger.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Server-side code can import a structured logger from @/lib/logger"
    - "Production logs are JSON format suitable for CloudWatch/log aggregation"
    - "Development logs are human-readable with colors via pino-pretty"
    - "Sensitive fields (password, token, authorization, cookie) are automatically redacted"
    - "Child loggers can be created with request context (userId, tenantId, requestId)"
  artifacts:
    - path: "src/lib/logger.ts"
      provides: "Pino logger singleton with redaction and dev/prod formatting"
      exports: ["logger"]
      contains: "pino"
  key_links:
    - from: "src/lib/logger.ts"
      to: "pino"
      via: "import"
      pattern: "import pino from"
---

<objective>
Integrate pino structured logging framework with a singleton logger, sensitive data redaction, and dev/prod formatting modes. Create the foundation that API routes and server actions can use via child loggers with request context.

Purpose: Enable production debugging with structured, queryable JSON logs. Replace ad-hoc console.log with consistent, redacted, context-rich logging.
Output: `src/lib/logger.ts` singleton logger ready for use across the application.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-production-hardening/15-RESEARCH.md
@src/lib/utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install pino and create structured logger singleton</name>
  <files>
    package.json
    src/lib/logger.ts
  </files>
  <action>
    1. Install pino and dev dependency pino-pretty:
       `pnpm add pino`
       `pnpm add -D pino-pretty`
       (pino-http NOT needed yet — add when HTTP middleware is warranted. Start with child loggers.)

    2. Create `src/lib/logger.ts` with pino singleton:

       Configuration:
       - level: "debug" in development, "info" in production (use process.env.NODE_ENV directly — do NOT import from env.ts to avoid circular dependency since logger may be used before env validation)
       - transport: pino-pretty in development only (colorize, translateTime SYS:standard, ignore pid/hostname)
       - transport: undefined in production (raw JSON to stdout — captured by Docker/CloudWatch)
       - base metadata: `{ service: "aegis" }` — identifies logs from this app
       - formatters.level: return `{ severity: label.toUpperCase() }` — standard severity format for CloudWatch Logs Insights
       - timestamp: pino.stdTimeFunctions.isoTime — ISO 8601 timestamps

       Redaction config:
       ```
       redact: {
         paths: [
           "password", "*.password",
           "token", "*.token",
           "authorization", "*.authorization",
           "req.headers.authorization",
           "cookie", "*.cookie",
           "req.headers.cookie",
           "secret", "*.secret",
           "apiKey", "*.apiKey",
         ],
         censor: "[REDACTED]",
       }
       ```

    3. Export the logger:
       ```typescript
       export { logger };
       ```

    4. Add a convenience function for creating request-scoped child loggers:
       ```typescript
       export function createRequestLogger(context: {
         userId?: string;
         tenantId?: string;
         requestId?: string;
         path?: string;
         method?: string;
       }) {
         return logger.child(context);
       }
       ```
       This pattern is lighter than pino-http middleware and compatible with Next.js App Router (no middleware needed).

    IMPORTANT: Do NOT use AsyncLocalStorage — it doesn't work in Edge runtime (Next.js middleware).
    Use explicit child logger creation in each API route/server action instead.

  </action>
  <verify>
    - `pnpm tsc --noEmit` passes (no type errors)
    - `src/lib/logger.ts` exists and exports `logger` and `createRequestLogger`
    - `grep -c "redact" src/lib/logger.ts` returns at least 1 (redaction configured)
    - `grep "pino-pretty" src/lib/logger.ts` confirms dev transport
  </verify>
  <done>
    src/lib/logger.ts exists with pino singleton, dev/prod formatting, sensitive field redaction, and createRequestLogger helper for request-scoped child loggers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add logger to health check API route as usage example</name>
  <files>
    src/app/api/health/route.ts
  </files>
  <action>
    1. Read the existing health check route at `src/app/api/health/route.ts`.

    2. Add structured logging to demonstrate the pattern:
       - Import `{ logger }` from `@/lib/logger`
       - Log health check requests: `logger.info({ status: "ok" }, "health check")`
       - Log errors if any check fails: `logger.error({ error }, "health check failed")`

    3. Keep the health check functionality exactly as-is — only add logging calls.
       This serves as a reference pattern for other developers/Claude sessions adding logging to API routes.

    NOTE: Do NOT add logging to every API route in this plan. The logger is now available for incremental adoption. Future plans or sessions can add `createRequestLogger()` calls to server actions and API routes as needed.

  </action>
  <verify>
    - `pnpm tsc --noEmit` passes
    - `grep "logger" src/app/api/health/route.ts` returns matches
    - Health endpoint still returns expected response
  </verify>
  <done>
    Health check API route uses structured pino logging as a reference pattern. Logger is available at @/lib/logger for incremental adoption across the codebase.
  </done>
</task>

</tasks>

<verification>
1. `pnpm tsc --noEmit` — no type errors
2. `pnpm build` — succeeds (pino is server-side only, no client bundle impact)
3. `grep "pino" src/lib/logger.ts` — confirms pino import
4. `grep "REDACTED" src/lib/logger.ts` — confirms redaction censor string
5. `grep "logger" src/app/api/health/route.ts` — confirms logger usage in health route
</verification>

<success_criteria>

- src/lib/logger.ts exists with pino singleton, redaction, and dev/prod modes
- createRequestLogger helper exported for request-scoped child loggers
- Health check route demonstrates logger usage pattern
- No type errors, build succeeds
- pino-pretty is a devDependency only
  </success_criteria>

<output>
After completion, create `.planning/phases/15-production-hardening/15-02-SUMMARY.md`
</output>
