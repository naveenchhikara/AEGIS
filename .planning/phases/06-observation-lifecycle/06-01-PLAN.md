---
phase: 06-observation-lifecycle
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - prisma/migrations/YYYYMMDD_observation_lifecycle/migration.sql
  - src/lib/constants.ts
autonomous: true

must_haves:
  truths:
    - Observation model has version column for optimistic locking
    - Observation model has resolvedDuringFieldwork boolean and resolutionReason field (OBS-07)
    - Observation model has riskCategory field for tagging (OBS-08)
    - ObservationRbiCircular junction table exists for many-to-many RBI circular tagging (OBS-08)
    - pg_trgm extension enabled in PostgreSQL for repeat finding detection (OBS-09)
    - Composite index on (tenantId, branchId, auditAreaId, status) exists for repeat finding queries
    - Trigram GIN index on Observation title exists
    - OBSERVATION_STATUS_COLORS constant exists with colors for all 7 states
  artifacts:
    - path: prisma/schema.prisma
      provides: Updated Observation model with version, resolvedDuringFieldwork, riskCategory, and ObservationRbiCircular junction table
      contains: "model ObservationRbiCircular"
    - path: prisma/migrations/YYYYMMDD_observation_lifecycle/migration.sql
      provides: Migration SQL with pg_trgm extension, composite index, trigram index, and timeline index
      min_lines: 30
    - path: src/lib/constants.ts
      provides: OBSERVATION_STATUS_COLORS mapping for all 7 lifecycle states
      contains: "OBSERVATION_STATUS_COLORS"
  key_links:
    - from: Observation model
      to: RbiCircular model
      via: ObservationRbiCircular junction table
      pattern: "ObservationRbiCircular"
    - from: Observation model
      to: Optimistic locking
      via: version column incremented on every update
      pattern: "version.*Int.*default\\(1\\)"
---

<objective>
Extend the Prisma schema with fields and indexes required for the observation lifecycle, and add supporting constants for the 7-state workflow.

Purpose: The existing Observation model from Phase 5 has the core fields but lacks: optimistic locking (version column), "resolved during fieldwork" flag (OBS-07), risk category tagging (OBS-08), RBI circular many-to-many link (OBS-08), and the PostgreSQL indexes needed for repeat finding detection (OBS-09). This plan adds all schema-level requirements so server actions can be built on top.

Output: Updated Prisma schema, migration SQL with pg_trgm and indexes, updated constants file.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-foundation-and-migration/05-02-SUMMARY.md
@.planning/phases/06-observation-lifecycle/06-RESEARCH.md
@prisma/schema.prisma
@src/lib/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Prisma schema for observation lifecycle</name>
  <files>prisma/schema.prisma</files>
  <action>
Add the following fields and models to the existing Prisma schema:

**1. Observation model — add fields:**

- `version Int @default(1)` — optimistic locking counter, incremented on every update
- `resolvedDuringFieldwork Boolean @default(false)` — OBS-07 flag for observations dropped during fieldwork
- `resolutionReason String? @db.Text` — OBS-07 rationale text when resolved during fieldwork
- `riskCategory String?` — OBS-08 risk category tag (e.g., "credit-risk", "market-risk", "operational-risk")
- `auditeeResponse String? @db.Text` — Auditee's response text when in RESPONSE state
- `actionPlan String? @db.Text` — Auditee's action plan when responding

**2. Add ObservationRbiCircular junction table (OBS-08):**

```prisma
model ObservationRbiCircular {
  id            String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  observationId String @db.Uuid
  observation   Observation @relation(fields: [observationId], references: [id], onDelete: Cascade)
  rbiCircularId String @db.Uuid
  rbiCircular   RbiCircular @relation(fields: [rbiCircularId], references: [id], onDelete: Cascade)
  createdAt     DateTime @default(now())

  @@unique([observationId, rbiCircularId])
  @@index([observationId])
  @@index([rbiCircularId])
}
```

**3. Add relations:**

- Add `rbiCirculars ObservationRbiCircular[]` relation to Observation model
- Add `observations ObservationRbiCircular[]` relation to RbiCircular model

**4. Add `pg_trgm` to datasource extensions:**
Update `extensions = [pgcrypto]` to `extensions = [pgcrypto, pg_trgm]`

**5. Add composite index to Observation model:**

- `@@index([tenantId, branchId, auditAreaId, status])` for repeat finding detection queries

Do NOT rename or move existing fields. Only ADD new fields and models. Preserve all existing indexes and relations.
</action>
<verify>Run `pnpm prisma validate` to confirm schema is valid. Run `pnpm prisma generate` to confirm client generates without errors.</verify>
<done>Prisma schema has version, resolvedDuringFieldwork, resolutionReason, riskCategory, auditeeResponse, actionPlan fields on Observation; ObservationRbiCircular junction table exists; pg_trgm in extensions; composite index for repeat detection.</done>
</task>

<task type="auto">
  <name>Task 2: Create migration SQL for indexes and extensions</name>
  <files>prisma/migrations/add_observation_lifecycle_indexes.sql</files>
  <action>
Create a SQL migration file that applies additional database objects not managed by Prisma's migrate:

```sql
-- Enable pg_trgm extension for repeat finding detection
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- Composite index for repeat finding detection (OBS-09)
-- Filters to CLOSED observations in same branch + audit area
CREATE INDEX IF NOT EXISTS idx_observation_repeat_detection
ON "Observation" ("tenantId", "branchId", "auditAreaId", status)
WHERE status = 'CLOSED';

-- Trigram GIN index for title similarity matching (OBS-09)
CREATE INDEX IF NOT EXISTS idx_observation_title_trgm
ON "Observation" USING gin (title gin_trgm_ops);

-- Optimized index for timeline queries (ordered by creation time)
CREATE INDEX IF NOT EXISTS idx_timeline_observation_ordered
ON "ObservationTimeline" ("observationId", "createdAt");

-- Index for observation version lookups (optimistic locking)
CREATE INDEX IF NOT EXISTS idx_observation_version
ON "Observation" (id, version);

-- RLS policy for ObservationRbiCircular (new junction table)
ALTER TABLE "ObservationRbiCircular" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "ObservationRbiCircular" FORCE ROW LEVEL SECURITY;

CREATE POLICY tenant_isolation_obs_rbi ON "ObservationRbiCircular"
USING (
  "observationId" IN (
    SELECT id FROM "Observation"
    WHERE "tenantId" = current_setting('app.current_tenant_id', TRUE)::uuid
  )
);

-- Grant permissions to aegis_app role
GRANT SELECT, INSERT, UPDATE, DELETE ON "ObservationRbiCircular" TO aegis_app;
```

Note: The junction table inherits tenant isolation indirectly through the Observation foreign key, since ObservationRbiCircular doesn't have its own tenantId column. The RLS policy checks via a subquery.
</action>
<verify>SQL file exists and has valid syntax (review manually — will be applied when PostgreSQL is running via `psql < migration.sql`).</verify>
<done>Migration SQL file contains: pg_trgm extension, composite index for repeat detection, trigram GIN index on title, timeline ordering index, version lookup index, RLS policy for junction table.</done>
</task>

<task type="auto">
  <name>Task 3: Add observation status colors and lifecycle constants</name>
  <files>src/lib/constants.ts</files>
  <action>
Add the following constants to `src/lib/constants.ts`:

**1. OBSERVATION_STATUS_COLORS** — mapping for all 7 lifecycle states (distinct from existing FINDING_STATUS_COLORS which only has 5 states with different names):

```typescript
export const OBSERVATION_STATUS_COLORS: Record<string, string> = {
  DRAFT: "border-gray-300 bg-gray-50 text-gray-700",
  SUBMITTED: "border-blue-300 bg-blue-50 text-blue-700",
  REVIEWED: "border-purple-300 bg-purple-50 text-purple-700",
  ISSUED: "border-orange-300 bg-orange-50 text-orange-700",
  RESPONSE: "border-yellow-300 bg-yellow-50 text-yellow-700",
  COMPLIANCE: "border-teal-300 bg-teal-50 text-teal-700",
  CLOSED: "border-green-300 bg-green-50 text-green-700",
};
```

**2. OBSERVATION_STATUS_ORDER** — sort order for states (used in table sorting):

```typescript
export const OBSERVATION_STATUS_ORDER: Record<string, number> = {
  DRAFT: 0,
  SUBMITTED: 1,
  REVIEWED: 2,
  ISSUED: 3,
  RESPONSE: 4,
  COMPLIANCE: 5,
  CLOSED: 6,
};
```

**3. RISK_CATEGORIES** — list of risk categories for tagging (OBS-08):

```typescript
export const RISK_CATEGORIES = [
  { id: "credit-risk", label: "Credit Risk" },
  { id: "market-risk", label: "Market Risk" },
  { id: "operational-risk", label: "Operational Risk" },
  { id: "liquidity-risk", label: "Liquidity Risk" },
  { id: "compliance-risk", label: "Compliance Risk" },
  { id: "it-risk", label: "IT & Cyber Risk" },
  { id: "governance-risk", label: "Governance Risk" },
  { id: "aml-cft", label: "AML/CFT" },
] as const;
```

Do NOT modify existing SEVERITY_COLORS or FINDING_STATUS_COLORS — they are still used by the v1.0 prototype pages.
</action>
<verify>Run `pnpm build` to confirm TypeScript compilation succeeds with new constants. Verify no import errors.</verify>
<done>OBSERVATION_STATUS_COLORS, OBSERVATION_STATUS_ORDER, and RISK_CATEGORIES constants exported from constants.ts.</done>
</task>

</tasks>

<verification>
1. `pnpm prisma validate` passes
2. `pnpm prisma generate` succeeds
3. `pnpm build` compiles without TypeScript errors
4. Schema has ObservationRbiCircular model with unique constraint on [observationId, rbiCircularId]
5. Observation model has version, resolvedDuringFieldwork, resolutionReason, riskCategory fields
6. Migration SQL includes pg_trgm, composite index, trigram index
</verification>

<success_criteria>

- Prisma schema extended with all fields needed for OBS-01 through OBS-11
- Migration SQL ready to apply (pg_trgm, indexes, RLS for junction table)
- Constants for all 7 observation states, risk categories
- Build passes with no errors
  </success_criteria>

<output>
After completion, create `.planning/phases/06-observation-lifecycle/06-01-SUMMARY.md`
</output>
