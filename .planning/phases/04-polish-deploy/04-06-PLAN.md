# Plan 04-06: SSL Certificate and Domain Configuration

**Wave:** 6 of 7
**Autonomous:** false (human verification checkpoint)
**Depends on:** 04-05 (infrastructure ready)
**Blocked by:** Domain purchased and DNS configured

## Overview

Configure SSL certificate using Let's Encrypt with Certbot, set up custom domain with DNS, and verify HTTPS access. This wave makes the production site accessible via secure HTTPS connection.

## Tasks

### Task 1: Purchase and configure domain (PREREQUISITE)
1. Purchase domain from registrar (GoDaddy, Namecheap, etc.)
   - Suggested: aegis-audit.com or aegisucb.com
2. Configure DNS records:
   - **A record**: `aegis` → points to Lightsail static IP
   - **CNAME**: `www` → points to `aegis`
3. Wait for DNS propagation (can take 24-48 hours, usually < 1 hour)
4. Verify DNS: `dig aegis.yourdomain.com` should return static IP

### Task 2: Install Certbot for Let's Encrypt SSL
1. Install Certbot and Nginx plugin:
   ```bash
   sudo apt install -y certbot python3-certbot-nginx
   ```
2. Verify installation: `certbot --version`

### Task 3: Obtain SSL certificate
1. Run Certbot:
   ```bash
   sudo certbot --nginx -d aegis.yourdomain.com -d www.aegis.yourdomain.com
   ```
2. Follow prompts:
   - Enter email address for expiry notifications
   - Agree to Terms of Service
   - Choose whether to redirect HTTP to HTTPS (select "Redirect" option)
3. Certbot will:
   - Validate domain ownership
   - Generate SSL certificate
   - Update Nginx configuration automatically
   - Set up auto-renewal via systemd timer

### Task 4: Verify SSL certificate
1. Check Nginx configuration updated:
   ```bash
   sudo cat /etc/nginx/sites-available/aegis
   ```
   Should see `listen 443 ssl` and certificate paths
2. Verify certificate files exist:
   ```bash
   sudo ls -la /etc/letsencrypt/live/aegis.yourdomain.com/
   ```
   Should see: `fullchain.pem`, `privkey.pem`, `chain.pem`
3. Test SSL configuration:
   ```bash
   sudo nginx -t
   sudo systemctl reload nginx
   ```
4. Verify auto-renewal:
   ```bash
   sudo certbot renew --dry-run
   ```
   Should show "simulating renewal" with no errors

### Task 5: Test HTTPS access (before app deployment)
1. Visit `https://aegis.yourdomain.com` in browser
2. Should see Nginx welcome page (or 502 Bad Gateway if app not yet deployed)
3. Verify:
   - No browser security warnings
   - SSL certificate is valid
   - Lock icon appears in address bar
   - HTTP redirects to HTTPS

### Task 6: Update security headers in Nginx
1. Edit Nginx configuration:
   ```bash
   sudo nano /etc/nginx/sites-available/aegis
   ```
2. Add security headers in SSL server block:
   ```nginx
   add_header X-Frame-Options "SAMEORIGIN" always;
   add_header X-Content-Type-Options "nosniff" always;
   add_header X-XSS-Protection "1; mode=block" always;
   add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
   ```
3. Test and reload:
   ```bash
   sudo nginx -t
   sudo systemctl reload nginx
   ```

### Task 7: Human verification checkpoint - SSL working
1. **Verify DNS**: Domain resolves to correct IP (`dig` command)
2. **Verify certificate**: Valid certificate issued for domain
3. **Verify HTTPS**: Site loads via HTTPS without warnings
4. **Verify redirect**: HTTP automatically redirects to HTTPS
5. **Verify auto-renewal**: Dry-run shows renewal will work
6. **Verify security headers**: Headers present in browser dev tools
7. **Browser test**: Access site in Chrome, Firefox, Safari - all show valid SSL

## Must Haves

- Domain purchased and DNS A record points to Lightsail IP
- SSL certificate issued by Let's Encrypt
- HTTPS access works without browser warnings
- HTTP automatically redirects to HTTPS
- Auto-renewal configured via Certbot
- Security headers configured
- Certificate valid for both root domain and www subdomain

## Artifacts Created

| Item | Purpose |
|------|---------|
| Domain DNS records | A record pointing to Lightsail IP |
| `/etc/letsencrypt/live/aegis.yourdomain.com/` | SSL certificate files |
| Updated `/etc/nginx/sites-available/aegis` | HTTPS configuration with certificates |
| `/etc/letsencrypt/renewal/aegis.yourdomain.com.conf` | Auto-renewal configuration |
| Certbot systemd timer | Automatic certificate renewal |

## Key Links

- DNS A record → points to Lightsail static IP
- Certbot → generates SSL certificates
- Nginx config → references certificate paths for HTTPS
- systemd timer → auto-renews certificates before expiry

---

*Wave 6 configures SSL. Wave 7 deploys the application and prepares demo scripts.*
