---
phase: 07-auditee-portal-evidence
plan: 05
type: execute
wave: 2
depends_on: [07-02, 07-03]
files_modified:
  - src/components/auditee/evidence-uploader.tsx
  - src/components/auditee/response-form.tsx
  - src/components/auditee/evidence-list.tsx
  - src/components/auditee/evidence-timeline-entry.tsx
autonomous: true

must_haves:
  truths:
    - "Evidence uploader supports drag-and-drop with react-dropzone (EVID-01)"
    - "Upload progress bar shown per file via XMLHttpRequest onprogress"
    - "Max 3 concurrent uploads queued"
    - "File type and size validated on drop before server call (EVID-03)"
    - "Response form has type selector (clarification, compliance action, extension request) (AUD-02, AUD-05)"
    - "Confirmation dialog warns responses are immutable before submission (AUD-04)"
    - "Evidence list shows uploaded files with download links, timestamp, uploader name (EVID-04)"
    - "Evidence timeline entry renders in observation timeline (EVID-04)"
  artifacts:
    - path: src/components/auditee/evidence-uploader.tsx
      provides: Drag-and-drop file upload with progress bars and retry
      min_lines: 100
      contains: "EvidenceUploader"
    - path: src/components/auditee/response-form.tsx
      provides: Auditee response submission form with type selector and immutability warning
      min_lines: 80
      contains: "ResponseForm"
    - path: src/components/auditee/evidence-list.tsx
      provides: List of uploaded evidence files with download buttons
      min_lines: 40
      contains: "EvidenceList"
    - path: src/components/auditee/evidence-timeline-entry.tsx
      provides: Evidence upload entry for observation timeline
      min_lines: 20
      contains: "EvidenceTimelineEntry"
  key_links:
    - from: evidence-uploader.tsx
      to: requestEvidenceUpload action
      via: Gets presigned URL for each file
      pattern: "requestEvidenceUpload"
    - from: evidence-uploader.tsx
      to: confirmEvidenceUpload action
      via: Confirms upload after S3 PUT completes
      pattern: "confirmEvidenceUpload"
    - from: response-form.tsx
      to: submitAuditeeResponse action
      via: Submits response with type and content
      pattern: "submitAuditeeResponse"
    - from: evidence-list.tsx
      to: getEvidenceDownloadUrl action
      via: Gets presigned download URL on click
      pattern: "getEvidenceDownloadUrl"
---

<objective>
Create the evidence upload and response submission components: drag-and-drop uploader with progress, response form with type selector, evidence list with download, and evidence timeline entry.

Purpose: These components handle the auditee's primary interactions — responding to observations and uploading supporting evidence. The evidence uploader uses a presigned URL flow (browser → S3 direct) with progress tracking. The response form enforces immutability with a confirmation dialog.

Output: Four auditee interaction components in `src/components/auditee/`.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-auditee-portal-evidence/07-PLAN.md
@.planning/phases/07-auditee-portal-evidence/07-02-PLAN.md
@.planning/phases/07-auditee-portal-evidence/07-03-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create evidence uploader component</name>
  <files>src/components/auditee/evidence-uploader.tsx</files>
  <action>
**evidence-uploader.tsx** — Client component ('use client'):

Props: `observationId: string`, `onUploadComplete?: () => void`

**Drop zone (react-dropzone):**

- Accept: PDF, JPEG, PNG, DOCX, XLSX (by MIME type)
- Max file size: 10MB (client-side check)
- Visual feedback: border color change on drag-over, file icon
- Reject feedback: immediate error toast for wrong type or size

**Upload queue:**

- State: array of `{ file, status, progress, error, s3Key }`
- Max 3 concurrent uploads
- New files added to queue, processed FIFO

**Per-file upload flow:**

1. Read first 4KB of file as ArrayBuffer → convert to base64 string
2. Call `requestEvidenceUpload` server action with base64 header + metadata
3. If validation fails → show error on file card, offer "Remove" button
4. If presigned URL returned → upload via `XMLHttpRequest`:
   - `xhr.upload.onprogress` → update progress bar (0-100%)
   - `xhr.onload` (status 200) → call `confirmEvidenceUpload`
   - `xhr.onerror` → retry with exponential backoff (1s, 2s, 4s; max 3 attempts)
5. On confirm success → mark complete with checkmark
6. On confirm failure → show error with retry button

**Visual per file:**

- File icon (based on extension), filename, file size
- Progress bar (blue, animated)
- Status: uploading (spinner), complete (green check), failed (red X with retry)
- Remove button (only before upload starts)

**Important:** Use XMLHttpRequest (not fetch) because fetch does not support upload progress events.
</action>
<verify>Run `pnpm build` to confirm TypeScript compilation. Verify react-dropzone is used for drag-and-drop. Verify XMLHttpRequest is used for upload progress. Verify retry logic with 3 max attempts.</verify>
<done>Evidence uploader handles drag-and-drop, per-file progress bars via XMLHttpRequest, concurrent upload queue (max 3), and retry with exponential backoff.</done>
</task>

<task type="auto">
  <name>Task 2: Create response form and evidence list components</name>
  <files>src/components/auditee/response-form.tsx, src/components/auditee/evidence-list.tsx, src/components/auditee/evidence-timeline-entry.tsx</files>
  <action>
**1. response-form.tsx** — Client component:

Props: `observationId: string`, `observationStatus: string`, `onResponseSubmitted?: () => void`

Layout:

- Response type selector (radio or select): Clarification, Compliance Action, Extension Request
- Text area for response content (required, min 10 chars)
- If type is COMPLIANCE_ACTION, show additional "Action Plan" text area
- Evidence uploader integrated below (optional evidence attachment)
- Submit button with loading state
- **Confirmation dialog before submission:**
  - AlertDialog with warning: "Responses cannot be edited or deleted after submission. Please review carefully."
  - "Submit Response" (destructive) and "Cancel" buttons
- Only shown when observation is in ISSUED or RESPONSE status
- Uses react-hook-form + Zod for validation
- Calls `submitAuditeeResponse` server action

**2. evidence-list.tsx** — Client component:

Props: `evidence: Evidence[]` (array of evidence records)

Layout:

- List/grid of uploaded evidence files
- Per file: file icon, filename, file size (formatted), upload date, uploader name
- Download button → calls `getEvidenceDownloadUrl` → opens presigned URL in new tab
- Empty state: "No evidence uploaded yet"
- No delete button (evidence is immutable)

**3. evidence-timeline-entry.tsx** — Server or client component:

Props: `entry: { event, filename?, uploaderName, createdAt }`

- Renders "Evidence uploaded: {filename} by {uploaderName}" with file icon
- Shows formatted timestamp
- Used inside StatusTimeline component for evidence_uploaded events
  </action>
  <verify>Run `pnpm build` to confirm TypeScript compilation. Verify response form has immutability warning dialog. Verify evidence list has download button. Verify no delete functionality exists.</verify>
  <done>Response form captures typed responses with immutability warning. Evidence list displays uploaded files with download. Evidence timeline entry integrates into observation timeline.</done>
  </task>

</tasks>

<verification>
1. `pnpm build` succeeds
2. Evidence uploader uses react-dropzone for drag-and-drop
3. Upload progress uses XMLHttpRequest (not fetch)
4. Max 3 concurrent uploads enforced
5. Response form has immutability warning dialog (AUD-04)
6. Response type selector has 3 options (AUD-02, AUD-05)
7. Evidence list has download but no delete functionality
8. Evidence timeline entry renders evidence_uploaded events
</verification>

<success_criteria>

- Drag-and-drop with visual feedback (EVID-01)
- Upload progress bars per file (EVID-01)
- Client-side + server-side file type validation (EVID-03)
- Retry with exponential backoff (3 attempts)
- Response immutability enforced with confirmation dialog (AUD-04)
- Response types: clarification, compliance action, extension request (AUD-02, AUD-05)
- Evidence list with download links (EVID-04)
- Evidence in timeline with timestamp and uploader (EVID-04)
  </success_criteria>

<output>
After completion, create `.planning/phases/07-auditee-portal-evidence/07-05-SUMMARY.md`
</output>
