---
phase: 10-onboarding-compliance
plan: 03
type: execute
wave: 2
depends_on: [10-01]
files_modified:
  - src/stores/onboarding-store.ts
  - src/lib/onboarding-validation.ts
  - src/types/onboarding.ts
autonomous: true

must_haves:
  truths:
    - "Zustand store with localStorage persistence middleware for wizard state"
    - "5 Zod validation schemas (one per wizard step) with zodResolver integration"
    - "Store tracks currentStep, completedSteps, and per-step data objects"
    - "Auto-save to localStorage on every field change (debounced 500ms)"
    - "Store expiry: 30 days of inactivity clears draft"
    - "TypeScript interfaces for all onboarding data structures"
    - "Store has reset() method to clear after successful completion"
  artifacts:
    - path: src/stores/onboarding-store.ts
      provides: Zustand store with localStorage middleware for wizard progress persistence
      min_lines: 60
      contains: "useOnboardingStore"
    - path: src/lib/onboarding-validation.ts
      provides: 5 Zod schemas for per-step validation
      min_lines: 80
      contains: "bankRegistrationSchema"
    - path: src/types/onboarding.ts
      provides: TypeScript interfaces for all onboarding data
      min_lines: 40
      contains: "OnboardingState"
  key_links:
    - from: onboarding-store.ts
      to: src/types/onboarding.ts
      via: Store state typed with OnboardingState interface
      pattern: "OnboardingState"
    - from: onboarding-validation.ts
      to: src/types/onboarding.ts
      via: Zod schemas infer to TypeScript types
      pattern: "z.infer"
---

<objective>
Create the Zustand store with localStorage persistence, Zod validation schemas for all 5 wizard steps, and TypeScript types for onboarding data.

Purpose: The store persists wizard progress across browser sessions (ONBD-06). Zod schemas validate each step independently, enabling per-step validation before proceeding. Auto-save to localStorage ensures no data loss.

Output: 1 Zustand store, 1 validation module with 5 schemas, 1 types file.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-onboarding-compliance/10-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TypeScript types and Zod validation schemas</name>
  <files>src/types/onboarding.ts, src/lib/onboarding-validation.ts</files>
  <action>
**1. onboarding.ts (types):**

```typescript
interface BankRegistrationData {
  bankName: string;
  shortName: string;
  rbiLicenseNumber: string;
  state: string;
  city: string;
  registrationNo: string;
  registeredWith: string;
  ucbType: "SCHEDULED" | "NON_SCHEDULED";
  scheduledDate?: string;
  establishedDate: string;
  pan: string;
  cin?: string;
}

interface TierSelectionData {
  tier: UcbTier;
  depositAmount?: number;
  nabardRegistration?: string;
  multiStateLicense: boolean;
  lastDakshScore?: number;
  pcaStatus: string;
  lastRbiInspectionDate?: string;
}

interface SelectedDirectionData {
  masterDirectionId: string;
  selected: boolean;
  items: Array<{
    itemCode: string;
    selected: boolean;
    notApplicable: boolean;
    notApplicableReason?: string;
  }>;
}

interface OrgStructureData {
  departments: Array<{
    name: string;
    code: string;
    headName: string;
    headEmail: string;
  }>;
  branches: Array<{
    name: string;
    code: string;
    city: string;
    state: string;
    type: string;
    managerName: string;
    managerEmail: string;
  }>;
}

interface UserInviteData {
  name: string;
  email: string;
  roles: string[];
  branchAssignments: string[]; // branch codes for AUDITEE
}

interface OnboardingState {
  currentStep: number;
  completedSteps: number[];
  bankRegistration: BankRegistrationData | null;
  tierSelection: TierSelectionData | null;
  selectedDirections: SelectedDirectionData[];
  notApplicableItems: Array<{ itemCode: string; reason: string }>;
  orgStructure: OrgStructureData | null;
  userInvites: UserInviteData[];
  startedAt: string;
  lastSavedAt: string;
  onboardingId?: string;
}
```

**2. onboarding-validation.ts (5 Zod schemas):**

- `bankRegistrationSchema`: Validates all Step 1 fields. RBI License pattern: `UCB-[A-Z]{2,3}-YYYY-NNNN`. PAN pattern: `[A-Z]{5}[0-9]{4}[A-Z]`. Conditional: scheduledDate required when ucbType = SCHEDULED.
- `tierSelectionSchema`: Validates Step 2. UcbTier enum value. depositAmount optional positive number. pcaStatus from enum.
- `rbiDirectionsSchema`: Validates Step 3. At least 1 direction selected. N/A items require reason (min 20 chars).
- `orgStructureSchema`: Validates Step 4. Min 1 department (Audit). Min 1 branch (Head Office). Unique department codes. Unique branch codes. No duplicate emails.
- `userInvitesSchema`: Validates Step 5. Array of invites with valid email. Roles from enum. AUDITEE role requires branchAssignments. Warn if no CAE/CCO assigned. Can be empty (skip option).

Each schema exports both the Zod schema and the inferred TypeScript type.
</action>
<verify>Run `pnpm build`. Verify all 5 schemas compile. Verify conditional validation (scheduledDate, N/A reason, AUDITEE branches). Verify type exports.</verify>
<done>TypeScript interfaces and 5 Zod validation schemas for all wizard steps.</done>
</task>

<task type="auto">
  <name>Task 2: Create Zustand store with localStorage persistence</name>
  <files>src/stores/onboarding-store.ts</files>
  <action>
**onboarding-store.ts:**

Zustand store with `persist` middleware:

```typescript
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

export const useOnboardingStore = create<OnboardingState & OnboardingActions>()(
  persist(
    (set, get) => ({
      // Initial state
      currentStep: 1,
      completedSteps: [],
      bankRegistration: null,
      tierSelection: null,
      selectedDirections: [],
      notApplicableItems: [],
      orgStructure: null,
      userInvites: [],
      startedAt: new Date().toISOString(),
      lastSavedAt: new Date().toISOString(),

      // Actions
      setStep: (step) => set({ currentStep: step, lastSavedAt: new Date().toISOString() }),
      markStepComplete: (step) => set(state => ({
        completedSteps: [...new Set([...state.completedSteps, step])],
        lastSavedAt: new Date().toISOString()
      })),
      setBankRegistration: (data) => set({ bankRegistration: data, lastSavedAt: ... }),
      setTierSelection: (data) => set({ tierSelection: data, lastSavedAt: ... }),
      setSelectedDirections: (data) => set({ selectedDirections: data, lastSavedAt: ... }),
      setOrgStructure: (data) => set({ orgStructure: data, lastSavedAt: ... }),
      setUserInvites: (data) => set({ userInvites: data, lastSavedAt: ... }),
      setOnboardingId: (id) => set({ onboardingId: id }),
      reset: () => set({ /* reset all to initial */ }),
      isExpired: () => {
        const lastSaved = new Date(get().lastSavedAt);
        const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
        return lastSaved < thirtyDaysAgo;
      },
    }),
    {
      name: 'aegis-onboarding',
      partialize: (state) => ({
        // Exclude functions from persistence
        currentStep: state.currentStep,
        completedSteps: state.completedSteps,
        bankRegistration: state.bankRegistration,
        tierSelection: state.tierSelection,
        selectedDirections: state.selectedDirections,
        notApplicableItems: state.notApplicableItems,
        orgStructure: state.orgStructure,
        userInvites: state.userInvites,
        startedAt: state.startedAt,
        lastSavedAt: state.lastSavedAt,
        onboardingId: state.onboardingId,
      }),
    }
  )
);
```

Features:

- localStorage key: `aegis-onboarding`
- `lastSavedAt` updated on every action (tracks activity)
- `isExpired()` checks 30-day inactivity
- `reset()` clears all data (called after successful completion)
- `partialize` excludes functions from localStorage serialization
  </action>
  <verify>Run `pnpm build`. Verify Zustand store compiles. Verify persist middleware configured. Verify reset clears all state. Verify isExpired checks 30-day window.</verify>
  <done>Zustand store with localStorage persistence, auto-save, 30-day expiry, and reset capability.</done>
  </task>

</tasks>

<verification>
1. `pnpm build` succeeds
2. All 5 Zod schemas validate their respective steps
3. Zustand store persists to localStorage under 'aegis-onboarding' key
4. Store tracks currentStep, completedSteps, and per-step data
5. isExpired() returns true after 30 days of inactivity
6. reset() clears all wizard state
7. Type safety maintained throughout (OnboardingState interface)
</verification>

<success_criteria>

- Wizard state persists across browser sessions via localStorage (ONBD-06)
- Per-step validation prevents proceeding with invalid data
- 30-day expiry cleans up abandoned wizards
- Type-safe onboarding data structures
- Zustand + React Hook Form + Zod stack ready for wizard UI
  </success_criteria>

<output>
After completion, create `.planning/phases/10-onboarding-compliance/10-03-SUMMARY.md`
</output>
