---
phase: 08-notifications-reports
plan: 03
type: execute
wave: 2
depends_on: [08-01, 08-02]
files_modified:
  - src/jobs/notification-processor.ts
  - src/jobs/notification-batcher.ts
  - src/jobs/deadline-reminder.ts
  - src/jobs/overdue-escalation.ts
  - src/jobs/weekly-digest.ts
  - src/jobs/index.ts
  - src/lib/notification-service.ts
autonomous: true

must_haves:
  truths:
    - "Notification processor dequeues pending notifications, renders email, sends via SES (NOTF-01, NOTF-02)"
    - "Notification batcher groups by batchKey and creates digest emails (NOTF-06)"
    - "Deadline reminder cron checks 7d, 3d, 1d before due and queues reminders (NOTF-03)"
    - "Overdue escalation cron sends to auditee + observation creator + Audit Manager (NOTF-04)"
    - "Weekly digest cron aggregates per-tenant stats for CAE/CCO every Monday (NOTF-05)"
    - "Duplicate prevention: same reminder not sent twice for same observation+deadline"
    - "Failed notifications retry up to 3 times with exponential backoff"
    - "Cross-tenant processing iterates tenants with scoped context (RLS compatible)"
  artifacts:
    - path: src/jobs/notification-processor.ts
      provides: Dequeues and processes pending notifications via SES
      min_lines: 60
      contains: "processNotifications"
    - path: src/jobs/deadline-reminder.ts
      provides: Cron job checking upcoming deadlines and queuing reminders
      min_lines: 40
      contains: "processDeadlineReminders"
    - path: src/jobs/weekly-digest.ts
      provides: Cron job aggregating weekly stats per tenant for CAE/CCO
      min_lines: 50
      contains: "processWeeklyDigest"
    - path: src/jobs/index.ts
      provides: Job registration and cron schedules for pg-boss
      min_lines: 30
      contains: "registerJobs"
    - path: src/lib/notification-service.ts
      provides: Application-level helper to queue notifications from server actions
      min_lines: 30
      contains: "queueNotification"
  key_links:
    - from: notification-processor.ts
      to: src/emails/render.ts
      via: Renders email templates to HTML
      pattern: "renderEmail"
    - from: notification-processor.ts
      to: src/lib/ses-client.ts
      via: Sends rendered email via SES
      pattern: "sendEmail"
    - from: notification-service.ts
      to: src/data-access/notifications.ts
      via: Creates NotificationQueue records
      pattern: "createNotification"
    - from: deadline-reminder.ts
      to: prismaForTenant
      via: Iterates tenants with scoped context
      pattern: "prismaForTenant"
---

<objective>
Implement all notification triggers, cron jobs, and the batch processing pipeline: deadline reminders, overdue escalation, weekly digest, and the core notification processor.

Purpose: This plan connects the notification infrastructure (08-01) and email templates (08-02) into a working pipeline. Application events queue notifications, pg-boss cron jobs check deadlines, and the processor sends emails via SES with batching support.

Output: 5 job handlers, 1 job registration module, 1 notification service helper.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-notifications-reports/08-PLAN.md
@.planning/phases/08-notifications-reports/08-01-PLAN.md
@.planning/phases/08-notifications-reports/08-02-PLAN.md
@src/lib/job-queue.ts
@src/lib/ses-client.ts
@src/data-access/notifications.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notification service and processor</name>
  <files>src/lib/notification-service.ts, src/jobs/notification-processor.ts, src/jobs/notification-batcher.ts</files>
  <action>
**1. notification-service.ts:**

Application-level helper called from server actions:

```typescript
export async function queueNotification(
  tenantId: string,
  recipientId: string,
  type: NotificationType,
  payload: Record<string, unknown>,
  batchKey?: string,
): Promise<void>;
```

- Checks user's NotificationPreference — skip if emailEnabled is false
- If batchKey provided, sets sendAfter = now + 5 minutes
- Creates NotificationQueue record via DAL
- Called from Phase 6/7 server actions (e.g., after observation issued, response submitted)

**2. notification-processor.ts:**

pg-boss job handler that runs every minute:

- Query pending notifications where sendAfter <= now
- Group by batchKey (null batchKey = individual)
- For batched groups (count > 1): delegate to batcher
- For individual notifications: render appropriate template based on type, send via SES
- Template selection: map NotificationType to email template component
- On success: mark as SENT, create EmailLog
- On failure: mark as FAILED, retry logic (3 attempts, exponential backoff 5min/15min/45min)

**3. notification-batcher.ts:**

Handles groups of notifications with same batchKey:

- Receives array of NotificationQueue records
- Renders bulk-digest-email with all observations
- Sends single email via SES
- Marks all records as SENT
- Creates single EmailLog with all notification IDs
  </action>
  <verify>Run `pnpm build`. Verify notification-service.ts checks preferences before queueing. Verify processor handles both individual and batched notifications. Verify retry logic with 3 max attempts.</verify>
  <done>Notification service queues notifications with preference checking. Processor handles individual and batched emails with retry logic.</done>
  </task>

<task type="auto">
  <name>Task 2: Create cron jobs and job registration</name>
  <files>src/jobs/deadline-reminder.ts, src/jobs/overdue-escalation.ts, src/jobs/weekly-digest.ts, src/jobs/index.ts</files>
  <action>
**1. deadline-reminder.ts:**

Daily cron (midnight IST):

- Iterate all active tenants (using base prisma for tenant list)
- For each tenant, use `prismaForTenant(tenantId)`:
  - Find observations with dueDate in 7d, 3d, 1d from now
  - For each: check EmailLog to avoid duplicate reminders
  - If not already sent: queue DEADLINE_REMINDER_7D/3D/1D notification
- Skip observations in CLOSED or COMPLIANCE status

**2. overdue-escalation.ts:**

Daily cron (2AM IST):

- Iterate tenants with scoped context
- Find observations where dueDate < now AND status NOT IN [CLOSED, COMPLIANCE]
- Queue OVERDUE_ESCALATION to: assignedTo (auditee), createdBy (auditor), engagement's Audit Manager
- Check EmailLog: only escalate once per day per observation

**3. weekly-digest.ts:**

Monday cron (3AM IST):

- Iterate tenants with scoped context
- Per tenant: aggregate stats for the week:
  - Total open observations, closed this week, new assignments
  - Top 3 critical/high findings
  - Compliance score (current)
  - Upcoming deadlines (next 7 days)
- Find CAE/CCO users for tenant
- Queue WEEKLY_DIGEST to each CAE/CCO (cannot opt out — regulatory)

**4. index.ts:**

Register all jobs and cron schedules with pg-boss:

```typescript
export async function registerJobs(boss: PgBoss) {
  // Cron jobs
  await boss.schedule("deadline-check", "0 18 * * *"); // midnight IST = 18:30 UTC
  await boss.schedule("overdue-escalation", "0 20 * * *"); // 2AM IST
  await boss.schedule("weekly-digest", "0 21 * * 1"); // Monday 3AM IST

  // Continuous processor (every minute)
  await boss.schedule("process-notifications", "*/1 * * * *");

  // Register handlers
  await boss.work("deadline-check", processDeadlineReminders);
  await boss.work("overdue-escalation", processOverdueEscalation);
  await boss.work("weekly-digest", processWeeklyDigest);
  await boss.work("process-notifications", processNotifications);
}
```

Note: IST is UTC+5:30. Cron times converted to UTC.
</action>
<verify>Run `pnpm build`. Verify all 3 cron jobs iterate tenants with prismaForTenant. Verify duplicate prevention via EmailLog check. Verify cron schedules in index.ts with correct UTC offsets for IST.</verify>
<done>Deadline reminders (NOTF-03), overdue escalation (NOTF-04), weekly digest (NOTF-05) jobs created. All registered in index.ts with correct IST cron schedules.</done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds
2. Notification processor handles individual + batched notifications
3. Deadline reminder checks 7d, 3d, 1d with duplicate prevention
4. Overdue escalation sends to auditee + creator + Audit Manager
5. Weekly digest aggregates per-tenant stats for CAE/CCO
6. All cron times use correct UTC offset for IST
7. Cross-tenant processing uses prismaForTenant (RLS compatible)
8. Retry logic: 3 attempts with exponential backoff (5min/15min/45min)
</verification>

<success_criteria>

- Deadline reminders sent at 7d, 3d, 1d before due (NOTF-03)
- Overdue observations trigger escalation to auditee + supervisor (NOTF-04)
- CAE/CCO receive weekly digest every Monday (NOTF-05)
- Bulk operations batched into single digest email (NOTF-06)
- Duplicate prevention prevents re-sending same reminder
- Cross-tenant processing respects RLS boundaries
- Failed notifications retry with exponential backoff
  </success_criteria>

<output>
After completion, create `.planning/phases/08-notifications-reports/08-03-SUMMARY.md`
</output>
