---
phase: 06-observation-lifecycle
plan: 06
type: execute
wave: 3
depends_on: [06-03]
files_modified:
  - src/app/(dashboard)/findings/[id]/page.tsx
  - src/components/findings/finding-detail.tsx
  - src/components/findings/status-timeline.tsx
  - src/components/findings/observation-actions.tsx
  - src/components/findings/tagging-panel.tsx
autonomous: true

must_haves:
  truths:
    - Observation detail page loads from PostgreSQL via DAL (not JSON)
    - Status timeline displays all immutable timeline entries with who, when, and comment (OBS-03)
    - Timeline entries are color-coded by event type (status change, severity escalation, repeat confirmation)
    - User sees available state transitions as action buttons based on their role and current state
    - Transition buttons trigger transitionObservation action with comment dialog
    - Observation tags (risk category, RBI circulars, audit area, branch, severity) are displayed
    - "Resolved during fieldwork" badge displayed when applicable (OBS-07)
  artifacts:
    - path: src/app/(dashboard)/findings/[id]/page.tsx
      provides: Observation detail page fetching from PostgreSQL
      min_lines: 25
    - path: src/components/findings/finding-detail.tsx
      provides: Updated detail component rendering PostgreSQL observation data with 5C fields
      min_lines: 100
    - path: src/components/findings/status-timeline.tsx
      provides: Updated timeline rendering immutable ObservationTimeline entries from database
      min_lines: 60
    - path: src/components/findings/observation-actions.tsx
      provides: Role-based state transition buttons with comment dialog
      min_lines: 80
    - path: src/components/findings/tagging-panel.tsx
      provides: Display panel showing all observation tags (risk category, RBI circulars, audit area, branch)
      min_lines: 40
  key_links:
    - from: findings/[id]/page.tsx
      to: observations DAL
      via: getObservationById with session
      pattern: "getObservationById"
    - from: observation-actions.tsx
      to: transitionObservation action
      via: Action call with comment dialog
      pattern: "transitionObservation"
    - from: observation-actions.tsx
      to: getAvailableTransitions
      via: Determines which buttons to show
      pattern: "getAvailableTransitions"
    - from: status-timeline.tsx
      to: ObservationTimeline data
      via: Renders timeline entries from database (ordered by createdAt ASC)
      pattern: "timeline.*createdAt"
---

<objective>
Migrate the observation detail page from JSON to PostgreSQL, build the immutable timeline display, and add role-based state transition action buttons.

Purpose: The detail page is where the observation lifecycle happens — users see the full observation, its audit trail timeline, and take action (submit, review, issue, respond, close). This plan wires the server actions from Plan 03 to interactive UI elements.

Output: Migrated detail page, enhanced timeline component, observation actions panel with transition buttons, and tagging display panel.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-observation-lifecycle/06-RESEARCH.md
@.planning/phases/06-observation-lifecycle/06-03-SUMMARY.md
@src/app/(dashboard)/findings/[id]/page.tsx
@src/components/findings/finding-detail.tsx
@src/components/findings/status-timeline.tsx
@src/lib/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate observation detail page and update timeline component</name>
  <files>src/app/(dashboard)/findings/[id]/page.tsx, src/components/findings/finding-detail.tsx, src/components/findings/status-timeline.tsx</files>
  <action>
**1. findings/[id]/page.tsx** — Migrate from JSON to DAL:

Replace JSON import:

```typescript
import { findings } from "@/data";
const data = findings as unknown as FindingsData;
```

With DAL fetch:

```typescript
import { getRequiredSession } from "@/data-access/session";
import { getObservationById } from "@/data-access/observations";

const session = await getRequiredSession();
const observation = await getObservationById(session, id);
```

- Remove `generateStaticParams` (no longer using static generation — data comes from DB)
- Keep `notFound()` if observation is null
- Pass observation AND session to FindingDetail component (session needed for role-based actions)
- Use Next.js 16 `params: Promise<{ id: string }>` pattern (already used in current code)

**2. finding-detail.tsx** — Update for PostgreSQL data:

Major changes:

- Update props type from `Finding` (JSON type) to match DAL return type (Prisma Observation with includes)
- Accept `session` prop for role-based rendering
- Display all 5C fields in labeled sections:
  - Condition ("What was found")
  - Criteria ("What should be")
  - Cause ("Why it happened")
  - Effect ("Risk / Impact")
  - Recommendation ("Suggested corrective action")
- Replace old fields (observation, rootCause, riskImpact, auditeeResponse, actionPlan) with new 5C fields
- Show "Resolved During Fieldwork" badge in amber when `resolvedDuringFieldwork === true`, with resolutionReason displayed (OBS-07)
- Show auditeeResponse and actionPlan only when status is RESPONSE or later
- Use OBSERVATION_STATUS_COLORS for status badge (not FINDING_STATUS_COLORS)
- Render ObservationActions component (from task 2) with session and observation data
- Render TaggingPanel component showing risk category, RBI circulars, audit area, branch
- Keep existing layout structure: header with badges, info cards, detail sections, timeline

**3. status-timeline.tsx** — Update for database timeline entries:

Replace `FindingTimeline` type with database shape:

```typescript
interface TimelineEntry {
  id: string;
  event: string; // "created", "status_changed", "severity_escalated", "repeat_confirmed", etc.
  oldValue: string | null;
  newValue: string | null;
  comment: string | null;
  createdBy: { name: string };
  createdAt: Date;
}
```

Display changes:

- Show event type with icon: status_changed (ArrowRight), severity_escalated (AlertTriangle), repeat_confirmed (Copy), created (Plus), resolved_during_fieldwork (CheckCircle)
- Show `oldValue → newValue` for status changes (e.g., "DRAFT → SUBMITTED")
- Show actor name from `createdBy.name`
- Show comment text below event description
- Color-code timeline dots:
  - status_changed: blue
  - severity_escalated: orange
  - repeat_confirmed: red
  - created: green
  - resolved_during_fieldwork: amber
- Sort by createdAt ASC (oldest first) — this comes from DAL already sorted
- Keep existing vertical timeline layout pattern from Phase 3
  </action>
  <verify>Run `pnpm build` to confirm TypeScript compilation. Verify findings/[id]/page.tsx imports from data-access. Verify status-timeline.tsx handles all event types (status_changed, severity_escalated, repeat_confirmed, created, resolved_during_fieldwork). Verify finding-detail.tsx shows 5C fields.</verify>
  <done>Observation detail page loads from PostgreSQL. Timeline displays immutable entries with color-coded event types and actor names. Finding detail shows 5C format and resolved-during-fieldwork badge.</done>
  </task>

<task type="auto">
  <name>Task 2: Create observation actions panel and tagging display</name>
  <files>src/components/findings/observation-actions.tsx, src/components/findings/tagging-panel.tsx</files>
  <action>
**1. observation-actions.tsx** — Client component ('use client'):

This component renders available state transition buttons based on the user's role and the observation's current state.

Implementation:

- Import `getAvailableTransitions` from `@/lib/state-machine`
- Compute available transitions on mount: `getAvailableTransitions(observation.status, session.user.roles, observation.severity)`
- Render each transition as a Button with the transition label
- On button click, show a Dialog/AlertDialog asking for comment (required for all transitions):
  - Dialog title: "Confirm: {transition.label}"
  - Textarea for comment (required, min 10 chars)
  - If transition is ISSUED → RESPONSE: also show auditeeResponse and actionPlan textareas
  - Confirm button calls `transitionObservation` action with: observationId, targetStatus, comment, version
- Handle optimistic lock errors with toast: "Observation was modified. Please refresh."
- Show success toast and revalidate on success
- Show "Resolve During Fieldwork" button when observation is DRAFT or SUBMITTED and user is AUDITOR/AUDIT_MANAGER:
  - Opens dialog asking for resolutionReason
  - Calls `resolveFieldwork` action
- If no transitions available (e.g., CLOSED state or wrong role), render nothing

Visual design:

- Primary button for forward transitions (Submit, Approve, Issue, Close)
- Outline/secondary button for return transitions (Return to Draft, Return for Review)
- Destructive-style button for "Resolve During Fieldwork" (amber, not red)
- Buttons displayed in a horizontal row with gap-2 spacing

**2. tagging-panel.tsx** — Server or client component:

Displays all observation tags in a compact panel:

- **Severity** badge with SEVERITY_COLORS
- **Status** badge with OBSERVATION_STATUS_COLORS
- **Branch** — branch name (or "Not assigned")
- **Audit Area** — audit area name (or "Not assigned")
- **Risk Category** — label from RISK_CATEGORIES constant (or "Not categorized")
- **RBI Circulars** — list of linked circular numbers/titles (from junction table). If none, show "None linked"
- **Assigned To** — user name (or "Unassigned")
- **Due Date** — formatted with formatDate (or "No deadline")

Layout: Compact grid layout (2 columns on desktop, 1 on mobile). Each tag shows label + value pair. Use muted text for labels, normal weight for values.
</action>
<verify>Run `pnpm build` to confirm compilation. Verify observation-actions.tsx imports getAvailableTransitions from state-machine.ts. Verify observation-actions.tsx imports transitionObservation from actions. Verify both components have proper TypeScript types.</verify>
<done>ObservationActions shows role-based transition buttons with comment dialog. TaggingPanel displays all observation metadata tags. Both integrate with server actions and state machine.</done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds
2. Detail page loads observation from PostgreSQL (not JSON)
3. Timeline displays event types with correct colors and actor names
4. Transition buttons appear based on user role and current state
5. Comment dialog enforces required comment for all transitions
6. Tagging panel shows all metadata dimensions
7. "Resolved During Fieldwork" button and badge work correctly
</verification>

<success_criteria>

- Observation detail fetches from PostgreSQL via DAL
- Immutable timeline shows all events with who, when, comment (OBS-03)
- Available transitions shown as action buttons per role (OBS-04, OBS-05, OBS-06)
- Comment dialog captures reason for every transition
- Tags panel shows risk category, RBI circulars, audit area, branch, severity (OBS-08)
- Resolved during fieldwork displayed as badge with rationale (OBS-07)
- Optimistic lock errors handled gracefully
  </success_criteria>

<output>
After completion, create `.planning/phases/06-observation-lifecycle/06-06-SUMMARY.md`
</output>
