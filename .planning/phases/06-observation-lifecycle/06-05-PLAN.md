---
phase: 06-observation-lifecycle
plan: 05
type: execute
wave: 3
depends_on: [06-03, 06-04]
files_modified:
  - src/app/(dashboard)/findings/new/page.tsx
  - src/components/findings/observation-form.tsx
  - src/components/findings/repeat-finding-banner.tsx
  - src/app/(dashboard)/findings/page.tsx
  - src/components/findings/findings-table.tsx
  - src/components/findings/findings-filters.tsx
autonomous: true

must_haves:
  truths:
    - Auditor can fill 5C observation form (condition, criteria, cause, effect, recommendation) (OBS-01)
    - Form includes severity, branch, audit area, risk category, and due date fields (OBS-08)
    - Creating observation shows repeat finding banner if matches detected (OBS-09)
    - Findings list page loads data from PostgreSQL via DAL (not JSON) (OBS-11 / success criteria 8)
    - Findings table uses OBSERVATION_STATUS_COLORS with all 7 states
    - Findings summary cards show real counts from PostgreSQL
  artifacts:
    - path: src/app/(dashboard)/findings/new/page.tsx
      provides: Create observation page with form and repeat finding detection
      min_lines: 30
    - path: src/components/findings/observation-form.tsx
      provides: 5C observation form with all tagging fields
      min_lines: 120
    - path: src/components/findings/repeat-finding-banner.tsx
      provides: Banner showing potential repeat finding matches with confirm/dismiss buttons
      min_lines: 50
    - path: src/app/(dashboard)/findings/page.tsx
      provides: Findings list page fetching from PostgreSQL DAL
      min_lines: 40
    - path: src/components/findings/findings-table.tsx
      provides: Updated findings table using PostgreSQL data with 7-state status badges
      min_lines: 80
  key_links:
    - from: observation-form.tsx
      to: createObservation action
      via: Form submission via useActionState
      pattern: "createObservation|useActionState"
    - from: observation-form.tsx
      to: detectRepeatFindings action
      via: Debounced detection on title/branch/area change
      pattern: "detectRepeatFindings"
    - from: findings/page.tsx
      to: observations DAL
      via: Server component fetching from getObservations + getObservationSummary
      pattern: "getObservations|getObservationSummary"
    - from: findings-table.tsx
      to: OBSERVATION_STATUS_COLORS
      via: Import from constants for 7-state badge styling
      pattern: "OBSERVATION_STATUS_COLORS"
---

<objective>
Build the create observation form with 5C fields, repeat finding detection banner, and migrate the findings list page from JSON data to PostgreSQL queries.

Purpose: This plan delivers the primary user-facing UI for the observation lifecycle. Auditors need a form to create observations (OBS-01), see repeat finding suggestions (OBS-09/11), and the findings list must display real database data instead of JSON demo data.

Output: Create observation page at /findings/new, observation form component, repeat finding banner component, and migrated findings list page + table.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-observation-lifecycle/06-RESEARCH.md
@.planning/phases/06-observation-lifecycle/06-03-SUMMARY.md
@.planning/phases/06-observation-lifecycle/06-04-SUMMARY.md
@src/app/(dashboard)/findings/page.tsx
@src/components/findings/findings-table.tsx
@src/components/findings/findings-filters.tsx
@src/lib/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create observation form page with repeat finding detection</name>
  <files>src/app/(dashboard)/findings/new/page.tsx, src/components/findings/observation-form.tsx, src/components/findings/repeat-finding-banner.tsx</files>
  <action>
**1. findings/new/page.tsx** — Server component page:
- Import getRequiredSession from data-access/session.ts
- Fetch branches and audit areas for dropdown options (from DAL or direct Prisma query)
- Render ObservationForm component passing branches, auditAreas, and session context
- Page title: "Create Observation"
- Back link to /findings

**2. observation-form.tsx** — Client component ('use client'):

- Form with sections matching 5C format (OBS-01):
  - **Title** — text input, required
  - **Condition** — textarea, "What was found" (required)
  - **Criteria** — textarea, "What should be" (required)
  - **Cause** — textarea, "Why it happened" (required)
  - **Effect** — textarea, "Risk / impact" (required)
  - **Recommendation** — textarea, "Suggested corrective action" (required)
- Metadata fields in sidebar/right column:
  - Severity dropdown (LOW, MEDIUM, HIGH, CRITICAL)
  - Branch dropdown (from props)
  - Audit Area dropdown (from props)
  - Risk Category dropdown (from RISK_CATEGORIES constant)
  - Assigned To dropdown (optional — for audit manager assignment)
  - Due Date picker (optional)
- Form submission:
  - Use `useActionState` with `createObservation` server action
  - Show validation errors from Zod schema per field
  - Show success toast (via sonner) and redirect to /findings/[id] on success
  - Disable submit button while pending (isPending from useActionState)
- Repeat finding detection:
  - When title, branchId, AND auditAreaId are all filled, call `detectRepeatFindings` action
  - Debounce detection by 500ms after title stops changing
  - If candidates returned, render RepeatFindingBanner below form header
  - Use `useTransition` or `startTransition` for non-blocking detection calls

**3. repeat-finding-banner.tsx** — Client component:

- Displayed when repeat candidates are detected
- Shows yellow/amber warning banner: "Potential Repeat Finding Detected"
- Lists up to 3 candidates with: title, similarity %, severity, occurrence count
- Each candidate has "Confirm as Repeat" and "Dismiss" buttons
- Confirm calls `confirmRepeatFinding` action → shows escalation result
- Dismiss calls `dismissRepeatFinding` action → removes candidate from list
- If all dismissed, banner disappears

**Use shadcn/ui components:** Card, Button, Badge, Select, Textarea, Input, Label, Separator. Use Sonner for toast notifications (already in project from v1.0).

**Layout:** Two-column on desktop (form fields left, metadata right), single column on mobile. Follow Phase 4 responsive patterns: p-4 md:p-6, grid-cols-1 lg:grid-cols-3.
</action>
<verify>Run `pnpm build` to confirm TypeScript compilation. Verify observation-form.tsx has 'use client' directive. Verify form includes all 5C fields (condition, criteria, cause, effect, recommendation). Navigate to /findings/new in browser (manual check).</verify>
<done>Create observation page exists at /findings/new with complete 5C form, metadata fields, Zod-validated submission, and repeat finding detection banner.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate findings list page from JSON to PostgreSQL</name>
  <files>src/app/(dashboard)/findings/page.tsx, src/components/findings/findings-table.tsx, src/components/findings/findings-filters.tsx</files>
  <action>
**1. findings/page.tsx** — Migrate from JSON to DAL:

Replace:

```typescript
import { findings } from "@/data";
const data = findings as unknown as FindingsData;
```

With:

```typescript
import { getRequiredSession } from "@/data-access/session";
import {
  getObservationSummary,
  getObservations,
} from "@/data-access/observations";

const session = await getRequiredSession();
const summary = await getObservationSummary(session);
const { observations } = await getObservations(session);
```

- Keep severity cards layout exactly as-is, but use `summary.bySeverity.CRITICAL` (uppercase keys from Prisma enum)
- Add "Create Observation" button (link to /findings/new) next to the title — visible only for users with AUDITOR role
- Pass observations array to FindingsTable as props (not importing from JSON)

**2. findings-table.tsx** — Update to use PostgreSQL data:

Major changes:

- Remove `import { findings } from "@/data"` — receive data as props instead
- Accept props: `{ observations: ObservationRow[] }` where ObservationRow matches the DAL return type
- Update column definitions to match Prisma model fields:
  - `title` (string)
  - `severity` (uppercase: "LOW", "MEDIUM", "HIGH", "CRITICAL")
  - `status` (uppercase: "DRAFT", "SUBMITTED", etc.)
  - `branch.name` (nested from include)
  - `auditArea.name` (nested from include)
  - `createdBy.name` (nested)
  - `createdAt` (Date, not string)
  - `dueDate` (Date | null)
- Use OBSERVATION_STATUS_COLORS (not FINDING_STATUS_COLORS) for badges
- Use OBSERVATION_STATUS_ORDER for sort order
- Keep existing sort/filter UI patterns from Phase 3
- Row click navigates to `/findings/[id]`
- Show "Resolved" badge on observations where resolvedDuringFieldwork is true

**3. findings-filters.tsx** — Update filter options:

- Status filter uses 7 states (DRAFT through CLOSED) instead of old 5
- Severity filter stays same (but uppercase values)
- Add branch filter dropdown
- Add audit area filter dropdown
- Keep existing filter pattern with columnFilters state

**Backwards compatibility:** If the app falls back to JSON data when database is unavailable (Phase 5 not yet running), add a try/catch in the page that falls back to JSON import. This ensures the prototype still works during development. Add a comment: `// TODO: Remove JSON fallback once Phase 5 is fully deployed`.
</action>
<verify>Run `pnpm build` to confirm compilation. Verify findings/page.tsx imports from data-access (not from @/data). Verify findings-table.tsx receives observations as props. Verify OBSERVATION_STATUS_COLORS used instead of FINDING_STATUS_COLORS.</verify>
<done>Findings list page fetches from PostgreSQL via DAL. FindingsTable accepts observations as props. All 7 observation states have correct styling. Create Observation button visible for auditors.</done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds
2. /findings/new page renders observation form with all 5C fields
3. findings/page.tsx imports from data-access (not @/data)
4. findings-table.tsx receives data as props (not self-contained JSON import)
5. OBSERVATION_STATUS_COLORS used for all 7 states
6. Repeat finding banner appears when candidates detected
7. Create Observation button links to /findings/new
</verification>

<success_criteria>

- Auditor can create observation with 5C format via form (OBS-01)
- Form includes severity, branch, audit area, risk category tagging (OBS-08)
- Repeat finding detection banner appears when matches found (OBS-09/11)
- Findings list page loads from PostgreSQL (success criteria 8)
- All 7 observation states displayed with correct colors
- Responsive layout following Phase 4 patterns
  </success_criteria>

<output>
After completion, create `.planning/phases/06-observation-lifecycle/06-05-SUMMARY.md`
</output>
