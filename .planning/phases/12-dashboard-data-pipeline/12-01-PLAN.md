---
phase: 12-dashboard-data-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/data-access/dashboard.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Observation model has optional engagementId FK to AuditEngagement"
    - "Observation model has optional repeatOfId self-referential FK"
    - "DashboardSnapshot model exists with tenantId, capturedAt, and metrics JSON column"
    - "getMyEngagementProgress returns real observation counts per engagement"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "DashboardSnapshot model, engagementId + repeatOfId on Observation"
      contains: "model DashboardSnapshot"
    - path: "prisma/migrations"
      provides: "Migration SQL for schema changes"
  key_links:
    - from: "prisma/schema.prisma (Observation.engagementId)"
      to: "prisma/schema.prisma (AuditEngagement.id)"
      via: "optional FK with onDelete: SetNull"
      pattern: "engagementId.*AuditEngagement.*SetNull"
    - from: "prisma/schema.prisma (Observation.repeatOfId)"
      to: "prisma/schema.prisma (Observation.id)"
      via: "self-referential FK with onDelete: SetNull"
      pattern: "repeatOfId.*RepeatHierarchy.*SetNull"
    - from: "src/data-access/dashboard.ts (getMyEngagementProgress)"
      to: "prisma/schema.prisma (Observation.engagementId)"
      via: "Prisma count query on engagementId"
      pattern: "observation\\.count.*engagementId"
---

<objective>
Add DashboardSnapshot model for time-series metrics, add engagementId and repeatOfId foreign keys to Observation model, and update the engagement progress query to return real observation counts.

Purpose: Schema foundation for trend dashboard pipeline, engagement tracking, and repeat finding detection — closing Phase 9 tech debt (engagementId) and enabling Phase 12 Plan 02 queries.
Output: Updated Prisma schema, migration SQL, and working getMyEngagementProgress with real counts.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-dashboard-data-pipeline/12-RESEARCH.md
@prisma/schema.prisma
@src/data-access/dashboard.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DashboardSnapshot model and Observation FK fields to schema</name>
  <files>prisma/schema.prisma</files>
  <action>
  Add three schema changes to `prisma/schema.prisma`:

**1. DashboardSnapshot model** (add after the BoardReport model section):

```prisma
model DashboardSnapshot {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId   String   @db.Uuid
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  capturedAt DateTime @default(now())
  metrics    Json     // { healthScore, compliance: {total,compliant,percentage}, severity: {total,criticalOpen,highOpen,mediumOpen,lowOpen} }

  @@index([tenantId, capturedAt(sort: Desc)])
}
```

**2. Add engagementId + repeatOfId fields to Observation model** (add after the `riskCategory` field, before `createdAt`):

```prisma
// Engagement tracking (Phase 12 — links observation to audit engagement)
engagementId String?          @db.Uuid
engagement   AuditEngagement? @relation(fields: [engagementId], references: [id], onDelete: SetNull)

// Repeat finding relation (Phase 12 — self-referential)
repeatOfId      String?       @db.Uuid
repeatOf        Observation?  @relation("RepeatHierarchy", fields: [repeatOfId], references: [id], onDelete: SetNull)
repeatInstances Observation[] @relation("RepeatHierarchy")
```

**3. Add indexes for the new FK fields** (add to the `@@index` block in Observation, before the closing `}`):

```prisma
@@index([engagementId])
@@index([repeatOfId])
```

**4. Add relation arrays to Tenant and AuditEngagement models:**

- In `model Tenant`, add `dashboardSnapshots DashboardSnapshot[]` to the relations section (after `boardReports`).
- In `model AuditEngagement`, add `observations Observation[]` to the relations section (after `updatedAt`).

**5. Generate migration with --create-only for safety:**

```bash
npx prisma migrate dev --create-only --name add-dashboard-snapshot-engagement-repeat
```

Then run `npx prisma generate` to update the client types.

**CRITICAL:**

- `onDelete: SetNull` on BOTH engagementId and repeatOfId (NOT Cascade — prevents deletion loops on self-referential FK)
- Both fields are optional (String?) — existing observations will have NULL values
- Do NOT backfill existing data — leave NULL for existing observations
  </action>
  <verify>

1. `npx prisma validate` exits with 0 (schema is valid)
2. Migration SQL file exists in `prisma/migrations/` directory
3. `npx prisma generate` completes without error
4. Grep schema.prisma for "DashboardSnapshot" — model exists with tenantId, capturedAt, metrics
5. Grep schema.prisma for "engagementId" — appears on Observation with SetNull
6. Grep schema.prisma for "repeatOfId" — appears on Observation with SetNull and RepeatHierarchy relation name
   </verify>
   <done>
   DashboardSnapshot model exists in schema. Observation has optional engagementId (FK to AuditEngagement, SetNull) and optional repeatOfId (self-referential FK, SetNull). Migration SQL generated. Prisma client types updated.
   </done>
   </task>

<task type="auto">
  <name>Task 2: Update getMyEngagementProgress to count observations via engagementId</name>
  <files>src/data-access/dashboard.ts</files>
  <action>
  Update `getMyEngagementProgress()` in `src/data-access/dashboard.ts` (lines 684-714) to count observations per engagement using the new `engagementId` field.

**Replace the current implementation** (which returns `observationCount: 0` with a comment about missing engagementId) with:

```typescript
export async function getMyEngagementProgress(
  db: ReturnType<typeof prismaForTenant>,
  userId: string,
  tenantId: string,
): Promise<EngagementProgress[]> {
  const fy = getCurrentFiscalYearRange();

  const engagements = await db.auditEngagement.findMany({
    where: {
      tenantId,
      assignedToId: userId,
      auditPlan: { year: fy.year },
    },
    select: {
      id: true,
      status: true,
      branch: { select: { name: true } },
      auditArea: { select: { name: true } },
      _count: {
        select: { observations: true },
      },
    },
  });

  return engagements.map((e: any) => ({
    id: e.id,
    branchName: e.branch?.name ?? null,
    auditAreaName: e.auditArea?.name ?? null,
    status: e.status,
    observationCount: e._count?.observations ?? 0,
  }));
}
```

**Key changes:**

- Added `_count: { select: { observations: true } }` to the Prisma query — this uses the new `AuditEngagement.observations` relation to count linked observations
- Replaced hardcoded `observationCount: 0` with `e._count?.observations ?? 0`
- Removed the comment about missing engagementId (now resolved)

**Do NOT change** the function signature or the EngagementProgress interface — they remain the same.
</action>
<verify>

1. `pnpm build` completes without TypeScript errors
2. Grep `dashboard.ts` for `observationCount: 0` — should NOT appear (replaced with real count)
3. Grep `dashboard.ts` for `_count.*observations` — should appear in getMyEngagementProgress
4. The EngagementProgress interface still has `observationCount: number` field
   </verify>
   <done>
   getMyEngagementProgress returns real observation counts from the engagementId FK relation using Prisma \_count. No more hardcoded zero.
   </done>
   </task>

</tasks>

<verification>
1. `npx prisma validate` passes — schema is valid
2. `npx prisma generate` passes — client types include DashboardSnapshot, engagementId, repeatOfId
3. `pnpm build` passes — no TypeScript errors from schema changes
4. Migration SQL file exists in `prisma/migrations/`
5. getMyEngagementProgress uses `_count.observations` instead of hardcoded 0
</verification>

<success_criteria>

- DashboardSnapshot model exists with (tenantId, capturedAt DESC) index
- Observation.engagementId is optional FK to AuditEngagement with onDelete: SetNull
- Observation.repeatOfId is optional self-referential FK with onDelete: SetNull (NOT Cascade)
- AuditEngagement has `observations` relation array
- getMyEngagementProgress returns real observation counts
- `pnpm build` succeeds
  </success_criteria>

<output>
After completion, create `.planning/phases/12-dashboard-data-pipeline/12-01-SUMMARY.md`
</output>
