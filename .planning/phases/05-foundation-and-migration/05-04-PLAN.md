---
phase: 05-foundation-and-migration
plan: 04
type: execute
wave: 2
depends_on: [05-03]
files_modified:
  - src/lib/permissions.ts
  - src/lib/nav-items.ts
  - src/components/layout/app-sidebar.tsx
  - src/app/(dashboard)/layout.tsx
  - src/app/(dashboard)/admin/users/page.tsx
  - src/components/admin/role-assignment-form.tsx
  - src/components/admin/user-list.tsx
  - src/data-access/users.ts
  - src/actions/users.ts
autonomous: true

must_haves:
  truths:
    - Admin can assign one or more roles to a user
    - User with roles [CAE, CCO] sees union of both role sidebar items
    - Route guards check ALL roles the user holds (not just first)
    - Unauthenticated user cannot access any dashboard route
    - BOARD_OBSERVER role exists in enum but has no permissions yet
  artifacts:
    - path: src/lib/permissions.ts
      provides: Role-to-permission mapping, hasPermission check functions
      min_lines: 60
    - path: src/lib/nav-items.ts
      provides: Sidebar navigation items filtered by roles
      min_lines: 40
    - path: src/components/layout/app-sidebar.tsx
      provides: Role-filtered sidebar showing only permitted items
      min_lines: 40
    - path: src/data-access/users.ts
      provides: Server-only user queries with tenant scope
      min_lines: 30
    - path: src/actions/users.ts
      provides: Server actions for role assignment
      min_lines: 30
  key_links:
    - from: AppSidebar
      to: permissions.ts
      via: Role-based nav filtering
      pattern: "filterNavByRoles"
    - from: Dashboard layout
      to: Session
      via: Session roles passed to sidebar
      pattern: "session\\.user\\.roles"
    - from: Role assignment action
      to: Database
      via: Prisma update with audit trail
      pattern: "prisma\\.user\\.update.*roles"
---

<objective>
Implement role-based access control (RBAC) with multi-role support, sidebar filtering, route guards, and admin role assignment UI.

Purpose: Control what each user can see and do based on their assigned roles. Multi-role support is critical for Tier III/IV UCBs where 3-5 person teams require individuals to hold multiple roles (e.g., CEO+CAE, CCO+Manager).

Output: Role-filtered sidebar, route-level guards, admin page for role management, and permission utilities.

**Key decisions incorporated:**

- D13: Multi-role users — `roles Role[]` not single enum (DE1)
- D20: Permission checks use `roles.includes()` not `role ===` (UCB Expert)
- DE9: BOARD_OBSERVER role reserved in enum (not built)
- Maker-checker: same person cannot create AND approve same observation (transaction-level)
  </objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/research/ARCHITECTURE.md
@.planning/research/PITFALLS.md
@.planning/phases/05-foundation-and-migration/05-03-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create permission system and role definitions</name>
  <files>
    src/lib/permissions.ts
  </files>
  <action>
    Create centralized permission system:

    **Role enum values (must match Prisma schema from 05-02):**
    - AUDITOR
    - AUDIT_MANAGER
    - CAE (Chief Audit Executive)
    - CCO (Chief Compliance Officer)
    - CEO (Chief Executive Officer)
    - AUDITEE
    - BOARD_OBSERVER (reserved — no permissions defined yet, DE9)

    **Permission types:**
    Define granular permissions:
    ```typescript
    type Permission =
      // Observations
      | 'observation:create'
      | 'observation:read'
      | 'observation:review'
      | 'observation:approve'
      | 'observation:close_low_medium'
      | 'observation:close_high_critical'
      // Compliance
      | 'compliance:read'
      | 'compliance:update'
      | 'compliance:mark_na'
      // Audit Plans
      | 'audit_plan:read'
      | 'audit_plan:create'
      | 'audit_plan:manage'
      // Reports
      | 'report:read'
      | 'report:generate'
      | 'report:add_commentary'
      // Admin
      | 'admin:manage_users'
      | 'admin:manage_roles'
      | 'admin:manage_settings'
      // Audit Trail
      | 'audit_trail:read'
      // Dashboard
      | 'dashboard:auditor'
      | 'dashboard:manager'
      | 'dashboard:cae'
      | 'dashboard:cco'
      | 'dashboard:ceo';
    ```

    **Role-to-permission mapping:**
    ```typescript
    const ROLE_PERMISSIONS: Record<Role, Permission[]> = {
      AUDITOR: ['observation:create', 'observation:read', 'compliance:read', 'audit_plan:read', 'dashboard:auditor'],
      AUDIT_MANAGER: ['observation:read', 'observation:review', 'observation:close_low_medium', 'audit_plan:create', 'audit_plan:manage', 'compliance:read', 'compliance:update', 'report:read', 'dashboard:manager'],
      CAE: ['observation:read', 'observation:approve', 'observation:close_high_critical', 'audit_plan:read', 'audit_plan:manage', 'compliance:read', 'compliance:update', 'compliance:mark_na', 'report:read', 'report:generate', 'report:add_commentary', 'audit_trail:read', 'admin:manage_users', 'admin:manage_roles', 'dashboard:cae'],
      CCO: ['compliance:read', 'compliance:update', 'observation:read', 'report:read', 'dashboard:cco'],
      CEO: ['dashboard:ceo', 'report:read', 'observation:read', 'compliance:read'],
      AUDITEE: ['observation:read'],  // Limited to assigned observations only
      BOARD_OBSERVER: [],  // Reserved — no permissions yet (DE9)
    };
    ```

    **Helper functions:**
    ```typescript
    /**
     * Check if user with given roles has a specific permission.
     * Uses roles.some() to check across ALL held roles (Decision D20).
     * NEVER use roles[0] or assume single role.
     */
    export function hasPermission(roles: Role[], permission: Permission): boolean {
      return roles.some(role => ROLE_PERMISSIONS[role]?.includes(permission));
    }

    /**
     * Get all permissions for a set of roles (union).
     */
    export function getPermissions(roles: Role[]): Permission[] {
      const permissions = new Set<Permission>();
      for (const role of roles) {
        for (const perm of ROLE_PERMISSIONS[role] ?? []) {
          permissions.add(perm);
        }
      }
      return Array.from(permissions);
    }

    /**
     * Maker-checker enforcement:
     * Same person cannot create AND approve the same observation.
     * This is transaction-level, not role-level.
     */
    export function canApproveObservation(
      userId: string,
      observation: { createdById: string }
    ): boolean {
      return userId !== observation.createdById;
    }
    ```

  </action>
  <verify>
    pnpm build (no TypeScript errors)
    # Unit test: hasPermission(['CAE', 'CCO'], 'audit_trail:read') → true
    # Unit test: hasPermission(['AUDITOR'], 'audit_trail:read') → false
    # Unit test: hasPermission(['AUDITOR', 'AUDIT_MANAGER'], 'observation:review') → true (from AUDIT_MANAGER role)
  </verify>
  <done>
    Permission system with role-to-permission mapping, multi-role support via union, and maker-checker enforcement.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update sidebar navigation with role filtering</name>
  <files>
    src/lib/nav-items.ts
    src/components/layout/app-sidebar.tsx
  </files>
  <action>
    Update sidebar to filter by user's roles:

    **Update nav-items.ts:**
    - Add `requiredPermission: Permission` to each nav item definition
    - Each sidebar item specifies which permission is needed to see it
    - Example:
      - Dashboard: different dashboard permissions per role
      - Compliance: 'compliance:read'
      - Findings: 'observation:read'
      - Audit Plans: 'audit_plan:read'
      - Reports: 'report:read'
      - Settings: 'admin:manage_settings'
      - Audit Trail: 'audit_trail:read'
      - Admin (Users): 'admin:manage_users'

    **Create filter function:**
    ```typescript
    export function filterNavByRoles(roles: Role[]): NavItem[] {
      const permissions = getPermissions(roles);
      return NAV_ITEMS.filter(item =>
        permissions.includes(item.requiredPermission)
      );
    }
    ```

    **Update AppSidebar:**
    - Accept `roles: Role[]` as prop (passed from dashboard layout via session)
    - Call `filterNavByRoles(roles)` to get visible nav items
    - Render only filtered items
    - Show user's role badge(s) in sidebar footer/header
    - If user has multiple roles, show them as comma-separated badges

    **IMPORTANT:** User with roles [CAE, CCO] sees the UNION of both role's permitted nav items. This means they see both the CAE dashboard AND the CCO compliance items.

  </action>
  <verify>
    # Login as user with AUDITOR role → see limited sidebar items
    # Login as user with CAE role → see admin, audit trail, reports
    # Login as user with [CAE, CCO] → see union of both
    # BOARD_OBSERVER → see nothing (empty permissions, should be handled gracefully)
  </verify>
  <done>
    Sidebar filters by roles, shows union of all role permissions, displays role badges.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create admin user management page</name>
  <files>
    src/app/(dashboard)/admin/users/page.tsx
    src/components/admin/user-list.tsx
    src/components/admin/role-assignment-form.tsx
    src/data-access/users.ts
    src/actions/users.ts
  </files>
  <action>
    Create admin page for managing users and assigning roles:

    **User list page (src/app/(dashboard)/admin/users/page.tsx):**
    - Server component
    - Validate session + check `admin:manage_users` permission
    - If no permission → redirect or show "Access Denied"
    - Fetch all users for the tenant via DAL
    - Render UserList client component

    **User list component (src/components/admin/user-list.tsx):**
    - "use client" component
    - Table showing: Name, Email, Role(s), Last Login, Status
    - Role(s) displayed as badges (multiple if multi-role)
    - Click row → opens role assignment dialog/sheet

    **Role assignment form (src/components/admin/role-assignment-form.tsx):**
    - "use client" component
    - Multi-select checkboxes for roles (not single dropdown — multi-role support)
    - Available roles: AUDITOR, AUDIT_MANAGER, CAE, CCO, CEO, AUDITEE
    - BOARD_OBSERVER shown but disabled with tooltip "Coming soon" (DE9)
    - Submit calls server action to update roles
    - Confirmation dialog: "Change [user name]'s roles to [new roles]?"

    **User DAL (src/data-access/users.ts):**
    - `import 'server-only'`
    - `getUsers(session)` — list all users for tenant
    - `getUserById(session, userId)` — single user
    - All functions: get session, use prismaForTenant, explicit WHERE tenantId

    **User actions (src/actions/users.ts):**
    - `'use server'`
    - `updateUserRoles(userId, roles)` — validate session, check admin:manage_roles permission
    - Set audit context: `set_config('app.current_action', 'user.role_changed')`
    - Set justification from form input (required for role changes, DE6)
    - Update user's roles array in database
    - Revalidate relevant paths

    **IMPORTANT SECURITY:**
    - Admin cannot change their own role (prevent self-privilege-escalation)
    - Role changes require justification text (audit trail, DE6)
    - tenantId from session ONLY (Skeptic S2)

  </action>
  <verify>
    Navigate to /admin/users → see user list (requires admin:manage_users permission)
    Click user → open role assignment form
    Assign AUDITOR + AUDIT_MANAGER → user now has both roles
    Check audit_log → entry with action_type='user.role_changed' and justification
    Non-admin user → cannot access /admin/users
  </verify>
  <done>
    Admin user management page with multi-role assignment, justification capture, and proper permission guards.
  </done>
</task>

<task type="auto">
  <name>Task 4: Implement route-level permission guards</name>
  <files>
    src/lib/guards.ts
    src/app/(dashboard)/layout.tsx
  </files>
  <action>
    Create reusable route permission guards:

    **Guard utilities (src/lib/guards.ts):**
    ```typescript
    import { redirect } from 'next/navigation';
    import { getRequiredSession } from '@/data-access/session';
    import { hasPermission, Permission, Role } from '@/lib/permissions';

    /**
     * Require specific permission to access a page.
     * Call at the top of server component pages.
     * Returns session if authorized.
     */
    export async function requirePermission(permission: Permission) {
      const session = await getRequiredSession();

      if (!hasPermission(session.user.roles as Role[], permission)) {
        redirect('/dashboard?unauthorized=true');
      }

      return session;
    }

    /**
     * Require any of the specified permissions.
     * Useful for pages accessible by multiple roles.
     */
    export async function requireAnyPermission(permissions: Permission[]) {
      const session = await getRequiredSession();
      const userRoles = session.user.roles as Role[];

      const hasAny = permissions.some(perm => hasPermission(userRoles, perm));
      if (!hasAny) {
        redirect('/dashboard?unauthorized=true');
      }

      return session;
    }
    ```

    **Usage in page components:**
    ```typescript
    // src/app/(dashboard)/compliance/page.tsx
    export default async function CompliancePage() {
      const session = await requirePermission('compliance:read');
      // ... fetch data and render
    }
    ```

    **Update dashboard layout:**
    - If `?unauthorized=true` in URL, show a toast notification "You don't have permission to access that page"
    - The layout already validates authentication (from 05-03)
    - Pass session.user.roles to AppSidebar for filtering

  </action>
  <verify>
    # AUDITOR accessing /admin/users → redirect to /dashboard?unauthorized=true
    # CAE accessing /admin/users → page loads normally
    # User with [AUDITOR, CAE] → can access both auditor and CAE pages
    pnpm build (no TypeScript errors)
  </verify>
  <done>
    Route-level permission guards with multi-role support and graceful redirect for unauthorized access.
  </done>
</task>

</tasks>

<verification>
**RBAC validation:**
1. Permission system handles multi-role users correctly (union of permissions)
2. User with [CAE, CCO] sees sidebar items from both roles
3. BOARD_OBSERVER role exists but has no permissions (graceful handling)
4. Admin can assign multiple roles to a user
5. Role change requires justification (captured in audit log)
6. Self-role-change prevented for admins
7. Route guards redirect unauthorized users to /dashboard
8. Maker-checker: observation creator cannot approve their own observation
9. All permission checks use `roles.includes()` not `role ===` (Decision D20)
10. tenantId sourced from session only (never from request input)

**Multi-role scenarios tested:**

- AUDITOR only: limited sidebar, can create observations
- CAE only: full access including audit trail and admin
- [AUDITOR, AUDIT_MANAGER]: can create AND review observations
- [CAE, CCO]: union of both dashboards and permissions
- BOARD_OBSERVER: no sidebar items (future feature)
  </verification>

<success_criteria>

1. Multi-role user sees union of all role permissions in sidebar
2. Admin can assign 1+ roles to any user with justification
3. Route guards prevent unauthorized access with graceful redirect
4. Permission system is extensible for future roles/permissions
5. All permission checks work with role arrays (not single role)
   </success_criteria>

<output>
After completion, create `.planning/phases/05-foundation-and-migration/05-04-SUMMARY.md`
</output>
