---
phase: 10-onboarding-compliance
plan: 07
type: execute
wave: 4
depends_on: [10-05, 10-06]
files_modified:
  - src/actions/onboarding.ts
  - src/actions/user-invitations.ts
  - src/app/accept-invite/page.tsx
  - src/app/(onboarding)/onboarding/_components/completion-summary.tsx
  - src/data-access/onboarding.ts
autonomous: true

must_haves:
  truths:
    - "completeOnboarding server action runs Steps 2-9 in a single database transaction (atomic)"
    - "Compliance registry seeded from selected Master Direction items per tier (ONBD-05)"
    - "N/A items created with notApplicableReason populated (CMPL-03)"
    - "User records created with status: INVITED and bcrypt-hashed invite tokens"
    - "UserBranchAssignment records created for AUDITEE users"
    - "Invitation emails queued via Phase 8 notification system (or console.log fallback)"
    - "Accept-invite page: public route validating token hash + expiry, allows password setting"
    - "Audit log entries for all created records"
    - "localStorage cleared after successful completion"
    - "Redirect to dashboard with welcome message showing seed count"
  artifacts:
    - path: src/actions/onboarding.ts
      provides: Server actions for saving wizard steps and completing onboarding
      min_lines: 100
      contains: "completeOnboarding"
    - path: src/actions/user-invitations.ts
      provides: Server actions for sending, accepting, resending, revoking invitations
      min_lines: 80
      contains: "acceptInvitation"
    - path: src/app/accept-invite/page.tsx
      provides: Public invite acceptance page for password setting
      min_lines: 50
      contains: "AcceptInvite"
    - path: src/data-access/onboarding.ts
      provides: DAL for onboarding data operations
      min_lines: 60
      contains: "seedComplianceRegistry"
  key_links:
    - from: onboarding.ts (actions)
      to: src/data-access/onboarding.ts
      via: DAL functions for atomic transaction
      pattern: "$transaction"
    - from: onboarding.ts (actions)
      to: src/lib/notification-service.ts
      via: Queue invitation emails after user creation
      pattern: "queueNotification"
    - from: accept-invite/page.tsx
      to: src/actions/user-invitations.ts
      via: Token verification and password setting
      pattern: "acceptInvitation"
---

<objective>
Implement the onboarding completion flow (atomic transaction), user invitation system, and accept-invite page.

Purpose: The completion flow creates the entire tenant infrastructure in a single atomic transaction: tenant record, departments, branches, compliance registry seeding, user creation, and invitation emails. The accept-invite page allows invitees to set their password and activate their account.

Output: 2 server action modules, 1 DAL, 1 accept-invite page, 1 completion summary component.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-onboarding-compliance/10-PLAN.md
@src/stores/onboarding-store.ts
@src/lib/notification-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create onboarding DAL and server actions</name>
  <files>src/data-access/onboarding.ts, src/actions/onboarding.ts</files>
  <action>
**1. onboarding.ts (DAL):**

- `saveOnboardingStep(tenantId, step, data)`: Upserts OnboardingProgress record
- `getOnboardingProgress(tenantId)`: Returns current wizard state from DB
- `seedComplianceRegistry(tx, tenantId, selectedItems)`: Within transaction:
  - For each selected checklist item: create ComplianceRequirement record
  - Set status to PENDING
  - Set sourceItemCode for traceability
  - Handle N/A items: set notApplicableReason
  - Set initial nextReviewDate = now + 90 days
- `createDepartments(tx, tenantId, departments)`: Bulk create Department records
- `createBranches(tx, tenantId, branches)`: Bulk create Branch records

**2. onboarding.ts (server actions):**

- `saveOnboardingStep(step, data)`: Save wizard step to server (called by Save & Exit)
- `getOnboardingProgress()`: Retrieve saved wizard state
- `completeOnboarding(wizardData)`: The atomic completion action:

  ```
  prisma.$transaction(async (tx) => {
    1. Validate all steps (re-validate server-side)
    2. Update Tenant record with Step 1 + Step 2 data
    3. Create departments from Step 4
    4. Create branches from Step 4
    5. Seed compliance registry from Step 3 selections
    6. Create invited users with status: INVITED from Step 5
    7. Create UserBranchAssignment for AUDITEE users
    8. Create audit log entries
    9. Mark tenant as onboardingCompleted = true
  })
  ```

  After transaction success:
  - Queue invitation emails via notification system (non-transactional)
  - Delete OnboardingProgress record
  - Return success with seeded counts

- `validateExcelUpload(formData)`: Parse and validate uploaded Excel (server-side)
  </action>
  <verify>Run `pnpm build`. Verify completeOnboarding uses $transaction. Verify all 9 steps in transaction. Verify invitation emails queued after (not during) transaction.</verify>
  <done>Onboarding DAL and server actions with atomic completion transaction.</done>
  </task>

<task type="auto">
  <name>Task 2: Create user invitation actions and accept-invite page</name>
  <files>src/actions/user-invitations.ts, src/app/accept-invite/page.tsx, src/app/(onboarding)/onboarding/_components/completion-summary.tsx</files>
  <action>
**1. user-invitations.ts (server actions):**

- `sendUserInvitations(users)`:
  - For each user: create User record with status: INVITED
  - Generate random 32-byte token: `crypto.randomBytes(32).toString('hex')`
  - Store bcrypt hash: `await bcrypt.hash(token, 12)` in inviteTokenHash
  - Set inviteExpiry: 7 days from now
  - Queue invitation email with raw token in link
  - Return created user IDs

- `acceptInvitation(token, email, password)`:
  - Find user by email with INVITED status
  - Verify: `bcrypt.compare(token, user.inviteTokenHash)` — reject if mismatch
  - Verify: inviteExpiry > now — reject if expired
  - Hash password and update user: status → ACTIVE, set password, clear inviteTokenHash
  - Create audit log entry

- `resendInvitation(userId)`:
  - Generate new token, update hash and expiry
  - Queue new invitation email

- `revokeInvitation(userId)`:
  - Delete User record (only if status = INVITED)
  - Create audit log entry

**2. accept-invite/page.tsx:**

Public page (no auth required):

- Read token and email from URL query params
- Form: set password + confirm password
- On submit: call acceptInvitation server action
- On success: redirect to /login with "Account activated. Please log in."
- On error: show appropriate message (expired, invalid, already activated)
- Rate limiting: max 5 attempts per IP per hour (in server action)

**3. completion-summary.tsx:**

Post-completion summary component:

- Shows: "Onboarding complete!"
- Counts: N compliance requirements seeded from M Master Directions
- User invite count: X users invited (emails will be sent)
- Departments and branches created
- CTA: "Go to Dashboard"
- On mount: calls Zustand store reset() to clear localStorage
  </action>
  <verify>Run `pnpm build`. Verify invitation uses bcrypt hash (not raw token). Verify accept-invite validates token + expiry. Verify completion summary shows seed counts and clears localStorage.</verify>
  <done>User invitation with bcrypt tokens, accept-invite page, and completion summary.</done>
  </task>

</tasks>

<verification>
1. `pnpm build` succeeds
2. completeOnboarding runs in single $transaction (atomic)
3. Compliance registry seeded with N items from selected Master Directions
4. N/A items have notApplicableReason populated
5. Users created with INVITED status and bcrypt-hashed tokens
6. UserBranchAssignment created for AUDITEE users
7. Accept-invite validates token hash + expiry
8. Password set and status → ACTIVE on successful acceptance
9. Audit log entries for all actions
10. localStorage cleared on completion
</verification>

<success_criteria>

- Atomic onboarding completion (no partial state on failure)
- Compliance registry seeded with tier-appropriate items (ONBD-05)
- User invitations with secure token handling (ONBD-04)
- Accept-invite page for password setting
- Audit trail for all onboarding actions
- Clean localStorage on completion
  </success_criteria>

<output>
After completion, create `.planning/phases/10-onboarding-compliance/10-07-SUMMARY.md`
</output>
