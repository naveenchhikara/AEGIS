---
phase: 04-polish-deploy
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - deploy/setup.sh
  - deploy/ecosystem.config.js
  - deploy/nginx-aegis.conf
autonomous: false

must_haves:
  truths:
    - "AWS Lightsail instance running in ap-south-1 (Mumbai)"
    - "Static IP attached to the instance"
    - "Node.js, PM2, and Nginx installed on the instance"
    - "SSH access working from local machine"
  artifacts:
    - path: "deploy/setup.sh"
      provides: "Server setup script for Node.js, PM2, Nginx"
      contains: "pm2"
    - path: "deploy/ecosystem.config.js"
      provides: "PM2 process configuration for Next.js"
      contains: "next.*start"
    - path: "deploy/nginx-aegis.conf"
      provides: "Nginx reverse proxy configuration"
      contains: "proxy_pass"
  key_links:
    - from: "deploy/ecosystem.config.js"
      to: "PM2 on server"
      via: "PM2 reads this config to manage Next.js process"
      pattern: "apps.*script.*next"
    - from: "deploy/nginx-aegis.conf"
      to: "PM2/Next.js on port 3000"
      via: "Nginx proxies HTTP to localhost:3000"
      pattern: "proxy_pass.*localhost:3000"

user_setup:
  - service: aws-lightsail
    why: "Demo deployment to Mumbai region for RBI data localization"
    env_vars: []
    dashboard_config:
      - task: "Create Lightsail instance ($5/mo Ubuntu 22.04, ap-south-1)"
        location: "AWS Console > Lightsail > Create instance"
      - task: "Create and attach static IP"
        location: "AWS Console > Lightsail > Networking > Create static IP"
      - task: "Download SSH key pair (.pem file)"
        location: "AWS Console > Lightsail > Account > SSH keys"
---

<objective>
Create deployment configuration files (setup script, PM2 config, Nginx config) and prepare for AWS Lightsail instance provisioning in Mumbai region.

Purpose: Prepare all server-side configuration so deployment is a single script execution once the Lightsail instance is running.
Output: Deploy configuration files in `deploy/` directory, ready to run on a fresh Ubuntu instance.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-polish-deploy/04-RESEARCH.md
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deployment configuration files</name>
  <files>
    deploy/setup.sh
    deploy/ecosystem.config.js
    deploy/nginx-aegis.conf
    deploy/deploy.sh
    deploy/README.md
  </files>
  <action>
    Create a `deploy/` directory at project root with all deployment configuration files.

    1. **`deploy/setup.sh`** - One-time server setup script (run once on fresh Ubuntu):
       ```bash
       #!/bin/bash
       set -e

       echo "=== AEGIS Server Setup ==="
       echo "Target: Ubuntu 22.04 on AWS Lightsail (ap-south-1)"

       # Update system
       sudo apt update && sudo apt upgrade -y

       # Install Node.js 20 LTS via NodeSource
       curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
       sudo apt install -y nodejs

       # Install pnpm globally
       sudo npm install -g pnpm

       # Install PM2 globally
       sudo npm install -g pm2

       # Install Nginx
       sudo apt install -y nginx

       # Install Certbot for SSL
       sudo apt install -y certbot python3-certbot-nginx

       # Create app directory
       sudo mkdir -p /home/ubuntu/aegis
       sudo chown ubuntu:ubuntu /home/ubuntu/aegis

       # Configure Nginx
       sudo cp /home/ubuntu/aegis/deploy/nginx-aegis.conf /etc/nginx/sites-available/aegis
       sudo ln -sf /etc/nginx/sites-available/aegis /etc/nginx/sites-enabled/aegis
       sudo rm -f /etc/nginx/sites-enabled/default
       sudo nginx -t && sudo systemctl reload nginx

       # Configure PM2 to start on boot
       pm2 startup systemd -u ubuntu --hp /home/ubuntu
       # NOTE: Run the command PM2 outputs (sudo env PATH=...)

       echo "=== Setup complete ==="
       echo "Next steps:"
       echo "  1. Run the PM2 startup command shown above"
       echo "  2. Run deploy.sh to deploy the application"
       echo "  3. Configure SSL with: sudo certbot --nginx -d yourdomain.com"
       ```

    2. **`deploy/ecosystem.config.js`** - PM2 process config:
       ```javascript
       module.exports = {
         apps: [{
           name: 'aegis',
           script: 'node_modules/.bin/next',
           args: 'start',
           cwd: '/home/ubuntu/aegis',
           instances: 1,
           autorestart: true,
           max_memory_restart: '400M',
           env: {
             NODE_ENV: 'production',
             PORT: 3000,
           },
         }],
       };
       ```

    3. **`deploy/nginx-aegis.conf`** - Nginx reverse proxy (HTTP only initially, Certbot adds SSL):
       ```nginx
       server {
           listen 80;
           server_name _;

           # Security headers
           add_header X-Frame-Options "SAMEORIGIN" always;
           add_header X-Content-Type-Options "nosniff" always;
           add_header X-XSS-Protection "1; mode=block" always;

           location / {
               proxy_pass http://localhost:3000;
               proxy_http_version 1.1;
               proxy_set_header Upgrade $http_upgrade;
               proxy_set_header Connection 'upgrade';
               proxy_set_header Host $host;
               proxy_set_header X-Real-IP $remote_addr;
               proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
               proxy_set_header X-Forwarded-Proto $scheme;
               proxy_cache_bypass $http_upgrade;
           }

           # Cache Next.js static assets
           location /_next/static/ {
               proxy_pass http://localhost:3000;
               expires 365d;
               add_header Cache-Control "public, immutable";
           }

           # Cache public assets
           location /logos/ {
               proxy_pass http://localhost:3000;
               expires 30d;
               add_header Cache-Control "public";
           }
       }
       ```

    4. **`deploy/deploy.sh`** - Deployment script (run each time to update):
       ```bash
       #!/bin/bash
       set -e

       APP_DIR="/home/ubuntu/aegis"
       echo "=== Deploying AEGIS ==="

       cd $APP_DIR

       # Pull latest code
       git pull origin main

       # Install dependencies
       pnpm install --frozen-lockfile

       # Build application
       pnpm build

       # Restart PM2 process
       pm2 reload ecosystem.config.js --update-env || pm2 start ecosystem.config.js

       # Save PM2 process list
       pm2 save

       echo "=== Deployment complete ==="
       echo "App running at http://$(curl -s ifconfig.me):80"
       ```

    5. **`deploy/README.md`** - Quick reference for deployment steps:
       Document the 3-step process:
       - Step 1: Create Lightsail instance (manual - AWS Console)
       - Step 2: Run setup.sh (one-time)
       - Step 3: Run deploy.sh (each deployment)
       Include SSH connection command template: `ssh -i ~/path-to-key.pem ubuntu@STATIC_IP`

    Make both .sh files executable: `chmod +x deploy/setup.sh deploy/deploy.sh`

  </action>
  <verify>
    - `deploy/setup.sh` exists and is executable
    - `deploy/deploy.sh` exists and is executable
    - `deploy/ecosystem.config.js` exists with valid JS
    - `deploy/nginx-aegis.conf` exists with valid Nginx syntax
    - `deploy/README.md` exists with deployment instructions
    - All scripts reference correct paths (/home/ubuntu/aegis)
  </verify>
  <done>All deployment config files created in deploy/ directory, ready to execute on AWS Lightsail Ubuntu instance</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Provision AWS Lightsail instance</name>
  <action>
    Create an AWS Lightsail instance in Mumbai region.
  </action>
  <instructions>
    1. Go to AWS Console > Lightsail (https://lightsail.aws.amazon.com)
    2. Switch region to **Mumbai (ap-south-1)** in the top-right
    3. Click "Create instance"
    4. Select: **Linux/Unix** > **OS Only** > **Ubuntu 22.04 LTS**
    5. Select the **$5/month plan** (1 vCPU, 0.5 GB RAM, 20 GB SSD)
    6. Name the instance: `aegis-demo`
    7. Click "Create instance"
    8. After creation, go to **Networking** tab > **Create static IP** > Attach to `aegis-demo`
    9. Note the static IP address: _______________
    10. Go to **Account** > **SSH keys** > Download the default SSH key (.pem)
    11. Save the .pem file to `~/.ssh/aegis-lightsail.pem`
    12. Set permissions: `chmod 400 ~/.ssh/aegis-lightsail.pem`
    13. Test SSH: `ssh -i ~/.ssh/aegis-lightsail.pem ubuntu@STATIC_IP`
  </instructions>
  <resume-signal>Provide the static IP address and confirm SSH works: "IP: x.x.x.x, SSH works"</resume-signal>
</task>

</tasks>

<verification>
1. `deploy/` directory contains setup.sh, deploy.sh, ecosystem.config.js, nginx-aegis.conf, README.md
2. Shell scripts are executable
3. AWS Lightsail instance running in ap-south-1
4. Static IP attached
5. SSH access confirmed
</verification>

<success_criteria>

- All deployment configuration files exist and are correct
- AWS Lightsail instance provisioned in Mumbai (ap-south-1)
- Static IP attached to instance
- SSH access works from local machine
  </success_criteria>

<output>
After completion, create `.planning/phases/04-polish-deploy/04-05-SUMMARY.md`
</output>
