---
phase: 08-notifications-reports
plan: 04
type: execute
wave: 2
depends_on: [08-01]
files_modified:
  - src/components/pdf-report/board-report.tsx
  - src/components/pdf-report/cover-page.tsx
  - src/components/pdf-report/executive-summary.tsx
  - src/components/pdf-report/audit-coverage.tsx
  - src/components/pdf-report/key-findings.tsx
  - src/components/pdf-report/compliance-scorecard.tsx
  - src/components/pdf-report/recommendations.tsx
  - src/components/pdf-report/repeat-findings.tsx
  - src/components/pdf-report/pdf-charts/bar-chart.tsx
  - src/components/pdf-report/pdf-charts/stacked-bar-chart.tsx
  - src/components/pdf-report/pdf-primitives/page-header.tsx
  - src/components/pdf-report/pdf-primitives/page-footer.tsx
  - src/app/api/reports/board-report/route.ts
  - src/data-access/reports.ts
  - next.config.ts
autonomous: true

must_haves:
  truths:
    - "Board report has 5 sections: executive summary, audit coverage, key findings, compliance scorecard, recommendations (RPT-02)"
    - "Cover page has bank name, logo, confidentiality notice, reporting period (RPT-04)"
    - "CAE can add executive commentary before generation (RPT-03)"
    - "Report includes page numbers on every page (RPT-04)"
    - "Report includes repeat findings summary (RPT-05)"
    - "Custom SVG charts built with React-PDF primitives (not Recharts)"
    - "PDF generated server-side via API route handler (not server component)"
    - "Generated report stored in S3 under reports/ prefix with delete allowed"
    - "BoardReport record created for audit trail"
  artifacts:
    - path: src/components/pdf-report/board-report.tsx
      provides: Main React-PDF document component composing all 5 sections
      min_lines: 50
      contains: "BoardReport"
    - path: src/components/pdf-report/cover-page.tsx
      provides: Cover page with bank logo, confidentiality, period
      min_lines: 30
      contains: "CoverPage"
    - path: src/app/api/reports/board-report/route.ts
      provides: API route handler for PDF generation and download
      min_lines: 40
      contains: "renderToBuffer"
    - path: src/data-access/reports.ts
      provides: DAL for report data aggregation and BoardReport record management
      min_lines: 60
      contains: "aggregateReportData"
  key_links:
    - from: route.ts
      to: board-report.tsx
      via: renderToBuffer for PDF generation
      pattern: "renderToBuffer"
    - from: route.ts
      to: src/data-access/reports.ts
      via: Aggregates observation, compliance, audit data
      pattern: "aggregateReportData"
    - from: route.ts
      to: S3
      via: Stores generated PDF under reports/ prefix
      pattern: "reports/"
---

<objective>
Implement the PDF board report with all 5 sections, custom SVG charts, and professional formatting using React-PDF.

Purpose: The board report is a key deliverable — CAE presents this to the audit committee. It aggregates observation data, compliance scores, audit coverage, and recommendations into a formatted PDF with charts, page numbers, and confidentiality notices.

Output: 8 PDF section components, 2 custom chart components, 2 PDF primitives, 1 API route handler, 1 report DAL.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-notifications-reports/08-PLAN.md
@src/lib/report-utils.ts
@src/lib/constants.ts
@next.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure React-PDF and create primitives and charts</name>
  <files>next.config.ts, src/components/pdf-report/pdf-primitives/page-header.tsx, src/components/pdf-report/pdf-primitives/page-footer.tsx, src/components/pdf-report/pdf-charts/bar-chart.tsx, src/components/pdf-report/pdf-charts/stacked-bar-chart.tsx</files>
  <action>
**1. next.config.ts update:**

Add to config: `serverExternalPackages: ['@react-pdf/renderer']`

**2. page-header.tsx:**

React-PDF component with `fixed` prop (repeats on every page):

- Bank name (left-aligned)
- "CONFIDENTIAL" text (right-aligned, gray)
- Thin separator line below

**3. page-footer.tsx:**

React-PDF component with `fixed` prop:

- Page number: `Page {pageNumber} of {totalPages}` using render prop
- Generation timestamp
- Bank name (centered)

**4. bar-chart.tsx:**

Custom React-PDF SVG bar chart:

- Props: `data: { label: string; value: number; color?: string }[]`, `width: number`, `height: number`
- Renders horizontal or vertical bars using `<Svg>`, `<Rect>`, `<Text>`
- Axis labels, value labels on bars
- Used for: audit coverage completion rates

**5. stacked-bar-chart.tsx:**

Custom React-PDF SVG stacked bar chart:

- Props: `data: { label: string; segments: { value: number; color: string; label: string }[] }[]`
- Renders stacked bars using `<Rect>` with calculated offsets
- Legend below chart
- Used for: compliance status distribution per category

Both charts use React-PDF SVG primitives only (no Recharts dependency).
</action>
<verify>Run `pnpm build`. Verify next.config.ts has serverExternalPackages. Verify chart components only use React-PDF SVG primitives.</verify>
<done>React-PDF configured. Page header/footer with fixed positioning. Custom SVG bar and stacked bar charts.</done>
</task>

<task type="auto">
  <name>Task 2: Build report section components</name>
  <files>src/components/pdf-report/cover-page.tsx, src/components/pdf-report/executive-summary.tsx, src/components/pdf-report/audit-coverage.tsx, src/components/pdf-report/key-findings.tsx, src/components/pdf-report/compliance-scorecard.tsx, src/components/pdf-report/recommendations.tsx, src/components/pdf-report/repeat-findings.tsx, src/components/pdf-report/board-report.tsx</files>
  <action>
**1. cover-page.tsx:** Bank logo, "Internal Audit Board Report", period (quarter + fiscal year), "CONFIDENTIAL", generation date.

**2. executive-summary.tsx:** Overall risk rating, key metrics (observations, critical/high, compliance score), CRAR/NPA, audit completion rate, executive commentary (RPT-03), 3-5 bullet highlights.

**3. audit-coverage.tsx:** Table: audit type × planned/completed/in-progress/rate. Branch coverage. Bar chart showing completion rates.

**4. key-findings.tsx:** Grouped by severity (Critical → High → Medium). Each: title, branch, observation excerpt, status, due date. Color-coded severity indicators. Overdue flagged red.

**5. compliance-scorecard.tsx:** Overall compliance %. Table: category × total/compliant/partial/non-compliant/pending/score. Stacked bar chart per category. Trend vs previous period.

**6. recommendations.tsx:** Prioritized list by severity. Each: title, description, related finding IDs, target date. Grouped by risk category.

**7. repeat-findings.tsx (RPT-05):** Table: title, original date, current occurrence, severity escalation. Highlights repeated unresolved observations.

**8. board-report.tsx:** Main Document component composing all sections:

```typescript
<Document>
  <CoverPage {...} />
  <Page>
    <PageHeader />
    <ExecutiveSummary />
    <PageFooter />
  </Page>
  <Page>
    <PageHeader />
    <AuditCoverage />
    <PageFooter />
  </Page>
  // ... remaining sections
</Document>
```

Register Noto Sans fonts (Regular, Bold, Italic) before rendering.
</action>
<verify>Run `pnpm build`. Verify all 7 section components exist. Verify board-report.tsx composes all sections. Verify font registration.</verify>
<done>All 7 report sections and main BoardReport document component created with custom charts and font registration.</done>
</task>

<task type="auto">
  <name>Task 3: Create report DAL and API route handler</name>
  <files>src/data-access/reports.ts, src/app/api/reports/board-report/route.ts</files>
  <action>
**1. reports.ts (DAL):**

- `aggregateReportData(session, year, quarter)`: Aggregates all data needed for board report:
  - Observation counts by severity, status
  - Audit engagement completion rates
  - Compliance requirement scores by category
  - Repeat findings with escalation history
  - Top critical/high findings
  - Branch coverage data
- `createBoardReport(session, { year, quarter, executiveCommentary, s3Key, fileSize, metricsSnapshot })`: Creates BoardReport record
- `getBoardReports(session)`: Lists previously generated reports
- `getBoardReportById(session, id)`: Gets specific report with S3 download URL

**2. board-report/route.ts (API route):**

POST handler:

- Verify CAE role from session
- Parse body: year, quarter, executiveCommentary
- Aggregate data via `aggregateReportData()`
- Render PDF: `pdf(<BoardReport data={data} />).toBuffer()`
- Use `export const dynamic = 'force-dynamic'` (Next.js 15+ PDF workaround)
- Store PDF in S3: `{tenantId}/reports/{year}/{quarter}/{reportId}.pdf`
- Create BoardReport record with metricsSnapshot
- Return PDF binary with `Content-Disposition: attachment; filename="board-report-Q{q}-FY{year}.pdf"`

GET handler (with id query param):

- Verify CAE/CCO/CEO role
- Fetch BoardReport record
- Generate presigned download URL from S3
- Return presigned URL (client redirects to download)
  </action>
  <verify>Run `pnpm build`. Verify POST handler checks CAE role. Verify PDF stored in S3 under reports/ prefix. Verify BoardReport record created. Verify `dynamic = 'force-dynamic'` set.</verify>
  <done>Report DAL aggregates observation, compliance, and audit data. API route generates PDF, stores in S3, creates audit trail record.</done>
  </task>

</tasks>

<verification>
1. `pnpm build` succeeds
2. Board report has all 5 sections plus repeat findings
3. Cover page has bank logo, confidentiality, reporting period
4. Custom SVG charts render in PDF (bar chart, stacked bar)
5. Page numbers on every page via fixed footer
6. Executive commentary included from CAE input (RPT-03)
7. PDF generated via API route (not server component)
8. Generated PDF stored in S3 under reports/ prefix
9. BoardReport record created for audit trail
10. `serverExternalPackages` includes @react-pdf/renderer
</verification>

<success_criteria>

- CAE generates PDF board report for selected period (RPT-01)
- Report has 5 sections: exec summary, coverage, findings, compliance, recommendations (RPT-02)
- CAE adds executive commentary before generation (RPT-03)
- Report has logo, confidentiality, page numbers, charts (RPT-04)
- Report includes repeat findings summary (RPT-05)
- PDF stored in S3 with delete allowed (unlike evidence which is immutable)
  </success_criteria>

<output>
After completion, create `.planning/phases/08-notifications-reports/08-04-SUMMARY.md`
</output>
