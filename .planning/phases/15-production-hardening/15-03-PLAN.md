---
phase: 15-production-hardening
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/current-user.ts
  - src/components/layout/top-bar.tsx
  - src/data/index.ts
  - src/data/demo/bank-profile.json
  - src/data/demo/staff.json
  - src/data/demo/branches.json
  - src/data/demo/compliance-requirements.json
  - src/data/demo/audit-plans.json
  - src/data/demo/findings.json
  - src/data/demo/rbi-circulars.json
  - prisma/seed.ts
autonomous: true

must_haves:
  truths:
    - "top-bar.tsx uses Better Auth session instead of hardcoded currentUser"
    - "src/lib/current-user.ts is deleted (no file on disk)"
    - "Demo JSON files live in src/data/seed/ directory (not src/data/demo/)"
    - "src/data/index.ts only exports RBI regulation data (no demo data exports)"
    - "prisma/seed.ts imports demo data from src/data/seed/ paths"
    - "No app code imports demo data at runtime from @/data barrel"
    - "Locale-specific demo data directories (hi/, mr/, gu/) are deleted"
  artifacts:
    - path: "src/data/seed/bank-profile.json"
      provides: "Demo bank profile for seed scripts only"
    - path: "src/data/seed/staff.json"
      provides: "Demo staff data for seed scripts only"
    - path: "src/data/index.ts"
      provides: "Barrel export for RBI regulations only"
      contains: "regulations"
  key_links:
    - from: "src/components/layout/top-bar.tsx"
      to: "src/lib/auth-client.ts"
      via: "authClient.useSession()"
      pattern: "useSession"
    - from: "prisma/seed.ts"
      to: "src/data/seed/"
      via: "import from seed directory"
      pattern: "data/seed"
---

<objective>
Remove legacy demo data dependencies from runtime code. Replace hardcoded currentUser with Better Auth session in top-bar.tsx, move demo JSON to seed-only directory, clean up barrel export, and delete unused locale-specific demo data.

Purpose: Prevent demo data from leaking into production bundles, eliminate hardcoded user identity, and enforce clean separation between seed data and application code.
Output: currentUser.ts deleted, demo JSON in src/data/seed/, barrel export cleaned, locale demo data deleted.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-production-hardening/15-RESEARCH.md
@src/lib/current-user.ts
@src/components/layout/top-bar.tsx
@src/data/index.ts
@src/lib/auth-client.ts
@prisma/seed.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace currentUser with Better Auth session in top-bar.tsx and delete current-user.ts</name>
  <files>
    src/components/layout/top-bar.tsx
    src/lib/current-user.ts
  </files>
  <action>
    1. Update `src/components/layout/top-bar.tsx`:
       - Remove imports: `import { currentUser } from "@/lib/current-user"` and `import { bankProfile } from "@/data"`
       - Remove: `const bank = bankProfile as unknown as BankProfile` and `import type { BankProfile } from "@/types"`
       - Add import: `import { authClient } from "@/lib/auth-client"`
       - Inside TopBar component, add: `const { data: session } = authClient.useSession();`
       - Replace `currentUser.initials` with computed initials from session:
         ```typescript
         const userInitials = session?.user?.name
           ? session.user.name.split(" ").map((n: string) => n[0]).join("")
           : "?";
         ```
       - Replace `currentUser.name` with `session?.user?.name ?? "User"`
       - Replace `currentUser.role` with `session?.user?.role ?? ""`
       - For the bank name in the header breadcrumb: the bank name should come from session context (tenant name). Since the session may not include tenant name directly, use a fallback approach:
         - If session.user has a tenantName or organization field, use it
         - Otherwise, remove the hardcoded bank name display (it was only demo data)
         - The breadcrumb should show current page name only (bank name can be added later when tenant context is available in session)
       - Replace the sign-out link (`<Link href="/login">`) with an actual sign-out action:
         ```typescript
         onClick={() => authClient.signOut({ fetchOptions: { onSuccess: () => { window.location.href = "/login"; } } })}
         ```
       - Keep the "use client" directive (already present), locale switcher, and notification bell as-is

    2. Delete `src/lib/current-user.ts` entirely.
       - Verify no other files import from it first: only top-bar.tsx imports it (confirmed by grep)

    IMPORTANT: The top-bar.tsx is a "use client" component. authClient.useSession() works in client components.
    Do NOT import server-side auth — use the client auth module at src/lib/auth-client.ts.

  </action>
  <verify>
    - `pnpm tsc --noEmit` passes
    - `! test -f src/lib/current-user.ts` — file is deleted
    - `grep "currentUser" src/components/layout/top-bar.tsx` returns NO matches
    - `grep "authClient" src/components/layout/top-bar.tsx` returns matches
    - `grep "useSession" src/components/layout/top-bar.tsx` returns matches
  </verify>
  <done>
    top-bar.tsx uses Better Auth session for user identity. currentUser.ts is deleted. No hardcoded demo user in the application.
  </done>
</task>

<task type="auto">
  <name>Task 2: Move demo JSON to seed directory and clean up barrel export</name>
  <files>
    src/data/index.ts
    src/data/demo/bank-profile.json
    src/data/demo/staff.json
    src/data/demo/branches.json
    src/data/demo/compliance-requirements.json
    src/data/demo/audit-plans.json
    src/data/demo/findings.json
    src/data/demo/rbi-circulars.json
  </files>
  <action>
    1. Create seed directory: `mkdir -p src/data/seed`

    2. Move all demo JSON files to seed directory:
       ```bash
       mv src/data/demo/bank-profile.json src/data/seed/
       mv src/data/demo/staff.json src/data/seed/
       mv src/data/demo/branches.json src/data/seed/
       mv src/data/demo/compliance-requirements.json src/data/seed/
       mv src/data/demo/audit-plans.json src/data/seed/
       mv src/data/demo/findings.json src/data/seed/
       mv src/data/demo/rbi-circulars.json src/data/seed/
       ```

    3. Delete locale-specific demo data directories (no longer used since v2.0 — all data comes from DB):
       ```bash
       rm -rf src/data/demo/hi
       rm -rf src/data/demo/mr
       rm -rf src/data/demo/gu
       ```

    4. Delete the now-empty `src/data/demo/` directory:
       ```bash
       rmdir src/data/demo
       ```

    5. Update `src/data/index.ts` to remove all demo data exports. Keep ONLY RBI regulation exports:
       ```typescript
       // ============================================================================
       // AEGIS Platform - Data Exports
       // ============================================================================
       // RBI Regulations data for runtime use.
       // Demo/seed data is in src/data/seed/ (NOT exported here — seed-only).
       // ============================================================================

       // RBI Regulations Data
       export { regulations } from "./rbi-regulations/index";
       export { chapters } from "./rbi-regulations/chapters";
       export { definitions } from "./rbi-regulations/definitions";
       export { capitalStructure } from "./rbi-regulations/capital-structure";
       export { complianceRequirements } from "./rbi-regulations/compliance-requirements";
       ```

    6. Update `prisma/seed.ts` imports to use new seed paths:
       - Change `import("../src/data/demo/compliance-requirements.json")` → `import("../src/data/seed/compliance-requirements.json")`
       - Change `import("../src/data/demo/findings.json")` → `import("../src/data/seed/findings.json")`

    IMPORTANT: The 11 app files that currently import demo data from `@/data` (like `bankProfile`, `auditPlans`, `findings`, `demoComplianceRequirements`) are PROTOTYPE-ERA code that still renders hardcoded demo data on dashboard widgets and pages. These are NOT production data paths — v2.0 added real database-backed pages alongside the prototype pages. However, removing these imports NOW would break the prototype views that still render this data.

    DECISION: For this plan, only remove the barrel EXPORTS of demo data from index.ts. The 11 app files that import demo data will get TypeScript errors, which is INTENTIONAL — it surfaces all remaining prototype code that needs migration to database-backed queries. These are known legacy views that should be migrated in a future phase. For now, those files should be updated to import directly from the seed directory OR (preferred) have their demo data usage commented out / replaced with TODO comments indicating they need database migration.

    Actually, since these 11 files are still actively rendering content in the prototype views (dashboard widgets, compliance page, reports page, audit-plans page), breaking them would make the app non-functional. The safer approach:

    REVISED APPROACH: Keep the barrel export working but pointing to the NEW seed location:
    - Move the demo JSON files to src/data/seed/
    - Update index.ts demo exports to point to "./seed/..." instead of "./demo/..."
    - This preserves runtime functionality while physically isolating seed data
    - A comment in index.ts warns these exports are deprecated and should be replaced with DB queries

    This way the app still works, but the physical files are in the seed directory, making it clear they're seed/demo data.

  </action>
  <verify>
    - `ls src/data/seed/*.json | wc -l` returns 7 (all demo JSON files moved)
    - `! test -d src/data/demo` — demo directory is deleted
    - `pnpm tsc --noEmit` passes (barrel export still works, pointing to seed/)
    - `pnpm build` succeeds
    - `grep "seed/" src/data/index.ts` returns matches for demo data exports
    - `grep "seed/" prisma/seed.ts` returns matches for seed imports
  </verify>
  <done>
    Demo JSON files moved to src/data/seed/. Locale-specific demo dirs (hi/, mr/, gu/) deleted. Barrel export updated to reference seed paths with deprecation comment. Seed script imports updated.
  </done>
</task>

</tasks>

<verification>
1. `pnpm tsc --noEmit` — no type errors
2. `pnpm build` — succeeds
3. `! test -f src/lib/current-user.ts` — currentUser.ts deleted
4. `! test -d src/data/demo` — demo directory gone
5. `ls src/data/seed/*.json | wc -l` — returns 7
6. `grep "currentUser" src/components/layout/top-bar.tsx` — no matches
7. `grep "useSession" src/components/layout/top-bar.tsx` — has matches
8. `grep "from.*rbi-regulations" src/data/index.ts` — RBI exports present
9. `grep "DEPRECATED" src/data/index.ts` — deprecation warning present
</verification>

<success_criteria>

- currentUser.ts is deleted, top-bar.tsx uses Better Auth session
- Demo JSON files physically in src/data/seed/ (not src/data/demo/)
- Locale demo data directories (hi/, mr/, gu/) are deleted
- Barrel export updated with seed paths and deprecation comments
- prisma/seed.ts imports from src/data/seed/ paths
- No type errors, build succeeds, app functions correctly
  </success_criteria>

<output>
After completion, create `.planning/phases/15-production-hardening/15-03-SUMMARY.md`
</output>
