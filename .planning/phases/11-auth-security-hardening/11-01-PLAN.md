---
phase: 11-auth-security-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/auth.ts
  - src/lib/auth-lockout-plugin.ts
  - src/lib/auth-client.ts
autonomous: true

must_haves:
  truths:
    - "Login endpoint rejects requests after 10 attempts per IP in 15 minutes with 429 status"
    - "Account is locked after 5 consecutive failed login attempts for that email"
    - "Locked account returns 423 status with informative error message"
    - "Account auto-unlocks after 30 minutes"
    - "Successful login clears failed attempt counter for that email"
    - "User cannot have more than 2 concurrent sessions"
    - "Session cookies have httpOnly=true, secure=true (production), sameSite=lax"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "FailedLoginAttempt model"
      contains: "model FailedLoginAttempt"
    - path: "src/lib/auth-lockout-plugin.ts"
      provides: "Custom Better Auth plugin for account lockout"
      exports: ["accountLockout"]
    - path: "src/lib/auth.ts"
      provides: "Hardened auth configuration with rate limiting, session limits, cookies, lockout"
      contains: "rateLimit"
    - path: "src/lib/auth-client.ts"
      provides: "Auth client with multiSession plugin registered"
      contains: "multiSessionClient"
  key_links:
    - from: "src/lib/auth.ts"
      to: "src/lib/auth-lockout-plugin.ts"
      via: "plugin import"
      pattern: "import.*accountLockout.*auth-lockout-plugin"
    - from: "src/lib/auth-lockout-plugin.ts"
      to: "prisma/schema.prisma"
      via: "FailedLoginAttempt table access"
      pattern: "failedLoginAttempt"
    - from: "src/lib/auth.ts"
      to: "better-auth/plugins"
      via: "multiSession plugin"
      pattern: "multiSession"
---

<objective>
Harden Better Auth configuration with rate limiting, account lockout, concurrent session limits, and explicit cookie security — closing all 4 HIGH-severity auth security gaps from Phase 5.

Purpose: These are production-critical security controls required for a banking SaaS platform. Rate limiting prevents brute-force attacks, account lockout stops targeted credential attacks, session limits prevent credential sharing, and cookie hardening prevents XSS/CSRF attacks.

Output: Updated auth.ts with full security config, custom lockout plugin, FailedLoginAttempt schema model, updated auth-client with multiSession plugin.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-auth-security-hardening/11-RESEARCH.md

# Key source files

@src/lib/auth.ts
@src/lib/auth-client.ts
@src/lib/prisma.ts
@prisma/schema.prisma
@src/components/auth/login-form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add FailedLoginAttempt model and generate Prisma client</name>
  <files>prisma/schema.prisma</files>
  <action>
Add a `FailedLoginAttempt` model to `prisma/schema.prisma` after the `OnboardingProgress` model (at the end of the file). This model tracks failed login attempts by email (NOT userId — pre-authentication, user may not exist) for account lockout.

Model definition:

```prisma
// ─── Failed Login Attempt Tracking (Phase 11 — account lockout) ─────────────

model FailedLoginAttempt {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email       String    // Track by email, not userId (pre-auth, user may not exist)
  ipAddress   String
  attemptedAt DateTime  @default(now())
  lockedUntil DateTime? // NULL = not locked; non-NULL = account locked until this time

  @@index([email, attemptedAt])
  @@index([email, lockedUntil])
}
```

Key design decisions:

- No `tenantId` — this is a system-level security table, not tenant-scoped
- Track by `email` not `userId` to prevent user enumeration and handle non-existent accounts
- `lockedUntil` is nullable — when NULL, the record is just a failed attempt; when set, it indicates a lockout event
- Two indexes: one for counting recent failures, one for checking lockout status

After adding the model, run:

```bash
pnpm prisma generate
```

Do NOT run `prisma migrate` or `prisma db push` — schema generation is sufficient for plan validation. Migration happens when Docker/PostgreSQL is available.

Verify the model compiles by checking `pnpm prisma validate` exits 0.
</action>
<verify>
Run `pnpm prisma validate` — should exit 0 with no errors.
Run `pnpm prisma generate` — should generate client successfully.
Grep schema for `model FailedLoginAttempt` — should exist.
</verify>
<done>
FailedLoginAttempt model exists in schema.prisma with email, ipAddress, attemptedAt, lockedUntil fields and both indexes. Prisma client generates successfully.
</done>
</task>

<task type="auto">
  <name>Task 2: Create account lockout plugin and harden auth configuration</name>
  <files>src/lib/auth-lockout-plugin.ts, src/lib/auth.ts, src/lib/auth-client.ts</files>
  <action>
**File 1: `src/lib/auth-lockout-plugin.ts`** — Create custom Better Auth plugin for account lockout.

This plugin uses Better Auth's `hooks` architecture (`before` and `after` on sign-in endpoint) to:

1. **Before sign-in:** Check if the email is currently locked (lockedUntil > now). If locked, return 423 status with error message and `lockedUntil` timestamp.
2. **After sign-in (failure):** Record failed attempt. Count recent failures in 15-minute observation window. If count >= 5, set `lockedUntil` to now + 30 minutes on all recent attempts for that email. Also log lockout event to `AuditLog` table.
3. **After sign-in (success):** Delete all failed attempts for that email within the observation window (clear the counter).

Implementation details:

- Import `prisma` from `@/lib/prisma` (NOT `prismaForTenant` — this is system-level, no tenant scoping needed)
- Use `createAuthMiddleware` from `better-auth/plugins` for type-safe hooks
- Plugin ID: `"account-lockout"`
- Config interface: `{ maxAttempts: number, lockoutDuration: number, observationWindow: number }`
- Defaults: maxAttempts=5, lockoutDuration=1800 (30 min in seconds), observationWindow=900 (15 min in seconds)
- The `before` hook matcher should check `context.path === "/sign-in/email"`
- The `after` hook matcher should check `context.path === "/sign-in/email"`
- For the `before` hook: extract `email` from `ctx.body`, query FailedLoginAttempt where email matches AND lockedUntil > new Date(). If found, return `ctx.json({ error: "Account temporarily locked due to multiple failed login attempts. Please try again later.", code: "ACCOUNT_LOCKED", lockedUntil: lockout.lockedUntil }, { status: 423 })`
- For the `after` hook on failure (response.status === 401 or 403): create FailedLoginAttempt record, count recent failures, lock if threshold exceeded, log to AuditLog on lockout
- For the `after` hook on success (response.status === 200): deleteMany FailedLoginAttempt records for that email
- Get IP from `ctx.headers?.get("x-forwarded-for") || ctx.headers?.get("x-real-ip") || "unknown"`
- For AuditLog lockout entry: use tenantId="SYSTEM", tableName="User", recordId=email, operation="LOCKOUT", actionType="account.locked"

Export: `export const accountLockout = (config?: Partial<AccountLockoutConfig>): BetterAuthPlugin => { ... }`

**File 2: `src/lib/auth.ts`** — Update existing Better Auth configuration with all 4 security hardening features.

Changes to the existing `betterAuth({...})` config:

1. **Rate limiting** — Add top-level `rateLimit` config:

```typescript
rateLimit: {
  enabled: true,
  window: 900, // 15 minutes in seconds
  max: 100, // Global: 100 requests per 15 min per IP (generous for general use)
  storage: "database", // Multi-instance safe
  customRules: {
    "/sign-in/email": {
      window: 900, // 15 minutes
      max: 10, // 10 login attempts per IP per 15 minutes (Phase 11 SC-1)
    },
    "/sign-up/email": {
      window: 60, // 1 minute
      max: 3, // 3 signup attempts per IP per minute
    },
  },
},
```

2. **Concurrent session limit** — Add `plugins` array with `multiSession`:

```typescript
import { multiSession } from "better-auth/plugins";

plugins: [
  multiSession({
    maximumSessions: 2, // Max 2 concurrent sessions per user (Phase 11 SC-3)
  }),
  accountLockout({
    maxAttempts: 5, // 5 failed attempts triggers lockout (Phase 11 SC-2)
    lockoutDuration: 1800, // 30 minutes in seconds (Phase 11 SC-2)
    observationWindow: 900, // 15 minute window for counting attempts
  }),
],
```

3. **Cookie security** — Update the existing `advanced` block:

```typescript
advanced: {
  database: {
    generateId: () => randomUUID(),
  },
  // Explicit cookie security (Phase 11 SC-4)
  useSecureCookies: process.env.NODE_ENV === "production", // true in prod, false in dev (http://localhost)
  defaultCookieAttributes: {
    httpOnly: true, // Prevent JavaScript access to session cookies
    secure: process.env.NODE_ENV === "production", // HTTPS only in production
    sameSite: "lax" as const, // CSRF protection while allowing top-level navigations
  },
},
```

Keep ALL existing config (secret, baseURL, database adapter, emailAndPassword, user additionalFields). Only ADD the new fields.

**File 3: `src/lib/auth-client.ts`** — Add multiSession client plugin.

Update the auth client to include the `multiSessionClient` plugin so client-side session management works with the server-side multiSession plugin:

```typescript
import { createAuthClient } from "better-auth/react";
import { multiSessionClient } from "better-auth/client/plugins";

export const authClient = createAuthClient({
  baseURL: process.env.NEXT_PUBLIC_APP_URL || "http://localhost:3000",
  plugins: [multiSessionClient()],
});
```

Keep all existing exports (useSession, signIn, signUp, signOut, getSession, listSessions, revokeSession, revokeOtherSessions). The multiSessionClient plugin enhances the existing session methods with multi-session awareness.

Important: Do NOT change the login-form.tsx — it already handles `TOO_MANY_ATTEMPTS` and `ACCOUNT_LOCKED` error codes correctly.
</action>
<verify>

1. Run `pnpm build` (or `npx tsc --noEmit`) — TypeScript compilation succeeds with no errors
2. Grep `src/lib/auth.ts` for "rateLimit" — should appear in config
3. Grep `src/lib/auth.ts` for "multiSession" — should appear in plugins
4. Grep `src/lib/auth.ts` for "accountLockout" — should appear in plugins
5. Grep `src/lib/auth.ts` for "useSecureCookies" — should appear in advanced config
6. Grep `src/lib/auth.ts` for "httpOnly" — should appear in defaultCookieAttributes
7. Grep `src/lib/auth-lockout-plugin.ts` for "ACCOUNT_LOCKED" — lockout error code should be present
8. Grep `src/lib/auth-client.ts` for "multiSessionClient" — client plugin registered
   </verify>
   <done>
   auth.ts has rate limiting (10 attempts/15min on /sign-in/email), multiSession plugin (max 2 sessions), accountLockout plugin (5 failures → 30-min lock), and explicit cookie config (httpOnly=true, secure=true in prod, sameSite=lax). auth-lockout-plugin.ts exports the custom plugin. auth-client.ts has multiSessionClient plugin registered. TypeScript compiles cleanly.
   </done>
   </task>

</tasks>

<verification>
All Phase 11 success criteria verified:

1. **Rate limiting (SC-1):** `rateLimit.customRules["/sign-in/email"]` configured with `window: 900, max: 10` → max 10 login attempts per 15 minutes per IP
2. **Account lockout (SC-2):** `accountLockout({ maxAttempts: 5, lockoutDuration: 1800 })` → locked after 5 failures, auto-unlock after 30 minutes
3. **Concurrent session limit (SC-3):** `multiSession({ maximumSessions: 2 })` → max 2 active sessions per user
4. **Cookie security (SC-4):** `defaultCookieAttributes: { httpOnly: true, secure: true, sameSite: "lax" }` → explicit cookie hardening

Build verification: `pnpm build` passes with no TypeScript errors.

Note: Full E2E verification requires running PostgreSQL (Docker) and running the migration. This will be tested in Phase 14 (Verification & Production Readiness).
</verification>

<success_criteria>

- FailedLoginAttempt model in Prisma schema with email/ipAddress/attemptedAt/lockedUntil fields
- auth.ts rateLimit config with /sign-in/email custom rule (10 max, 900s window)
- auth.ts multiSession plugin with maximumSessions=2
- auth.ts accountLockout plugin with maxAttempts=5, lockoutDuration=1800
- auth.ts defaultCookieAttributes with httpOnly=true, secure=env-based, sameSite=lax
- auth-lockout-plugin.ts exports accountLockout function
- auth-client.ts includes multiSessionClient plugin
- pnpm build succeeds
  </success_criteria>

<output>
After completion, create `.planning/phases/11-auth-security-hardening/11-01-SUMMARY.md`
</output>
