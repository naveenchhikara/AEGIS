---
phase: 14-verification-production-readiness
plan: 04
type: execute
wave: 2
depends_on: [14-03]
files_modified:
  - tests/e2e/permission-guards.spec.ts
autonomous: false

must_haves:
  truths:
    - "Permission guard E2E test verifies auditee cannot access CAE-only pages"
    - "Permission guard E2E test verifies CAE can access audit-trail page"
    - "AWS SES domain verification DNS records are created in ap-south-1"
    - "First test email sent successfully via AWS SES"
  artifacts:
    - path: "tests/e2e/permission-guards.spec.ts"
      provides: "Permission guard E2E tests for Phase 7 branch-scoped access"
      contains: "test.describe"
  key_links:
    - from: "tests/e2e/permission-guards.spec.ts"
      to: "playwright/.auth/*.json"
      via: "storageState for role-based access testing"
      pattern: "storageState"
---

<objective>
Create Phase 7 permission guard E2E tests using the Playwright infrastructure from plan 14-03, then checkpoint for AWS SES domain verification.

Purpose: Phase 7 had a skipped permission guard test. This plan creates the automated test and verifies AWS SES domain setup for production email sending (required for NOTF requirements).

Output: Permission guard test file and confirmed AWS SES domain verification.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/14-verification-production-readiness/14-RESEARCH.md
@.planning/phases/14-verification-production-readiness/14-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Phase 7 permission guard E2E tests</name>
  <files>tests/e2e/permission-guards.spec.ts</files>
  <action>
Create permission guard E2E tests that verify role-based access controls work correctly.

**Before writing tests:** Read the actual implementation to understand:

- `src/lib/auth.ts` — role definitions and permissions
- `src/middleware.ts` or route-level guards — how pages are protected
- `src/app/(dashboard)/audit-trail/page.tsx` — CAE-only page
- `src/app/(dashboard)/auditee/page.tsx` — Auditee portal page

**Test scenarios:**

```typescript
import { test, expect } from "@playwright/test";

test.describe("Permission Guards", () => {
  test.describe("Auditee role restrictions", () => {
    test.use({ storageState: "playwright/.auth/auditee.json" });

    test("auditee cannot access audit-trail page", async ({ page }) => {
      await page.goto("/audit-trail");
      // Verify redirect to dashboard or forbidden page
      await expect(page).not.toHaveURL(/\/audit-trail$/);
    });

    test("auditee cannot access settings/users page", async ({ page }) => {
      await page.goto("/settings");
      // Verify no access to user management
    });

    test("auditee can access auditee portal", async ({ page }) => {
      await page.goto("/auditee");
      await expect(page).toHaveURL(/\/auditee/);
    });

    test("auditee sees only branch-scoped observations", async ({ page }) => {
      await page.goto("/auditee");
      // Verify all displayed observations belong to auditee's branch
      // Check branch name in observation cards/table matches auditee's branch
    });
  });

  test.describe("CAE role access", () => {
    test.use({ storageState: "playwright/.auth/cae.json" });

    test("CAE can access audit-trail page", async ({ page }) => {
      await page.goto("/audit-trail");
      await expect(page).toHaveURL(/\/audit-trail/);
      await expect(
        page.getByRole("heading", { name: /audit trail/i }),
      ).toBeVisible();
    });

    test("CAE can access all dashboard sections", async ({ page }) => {
      await page.goto("/dashboard");
      // Verify CAE-specific widgets are visible
    });
  });

  test.describe("Auditor role restrictions", () => {
    test.use({ storageState: "playwright/.auth/auditor.json" });

    test("auditor can access findings but not audit-trail", async ({
      page,
    }) => {
      await page.goto("/findings");
      await expect(page).toHaveURL(/\/findings/);

      await page.goto("/audit-trail");
      await expect(page).not.toHaveURL(/\/audit-trail$/);
    });
  });

  test.describe("Manager role access", () => {
    test.use({ storageState: "playwright/.auth/manager.json" });

    test("manager can access review queue", async ({ page }) => {
      // Verify manager can see observations pending review
      await page.goto("/findings");
      await expect(page).toHaveURL(/\/findings/);
    });
  });
});
```

**CRITICAL:** Adapt test assertions to match actual permission implementation. Check:

1. Whether unauthorized access redirects (302) or shows forbidden page (403)
2. Whether sidebar items are hidden for unauthorized roles
3. Whether API routes also enforce permissions (not just UI)

Adjust selectors based on actual page implementations found during file reading.
</action>
<verify>

- `ls tests/e2e/permission-guards.spec.ts` exists
- Contains permission tests: `grep -c "test.describe" tests/e2e/permission-guards.spec.ts` returns >= 4
- Tests different roles: `grep -c "storageState" tests/e2e/permission-guards.spec.ts` returns >= 4
- Covers audit-trail access: `grep "audit-trail" tests/e2e/permission-guards.spec.ts` returns matches
  </verify>
  <done>Permission guard E2E tests created verifying auditee cannot access CAE pages, CAE can access audit-trail, auditor has correct access scope, and manager has review access.</done>
  </task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: AWS SES domain verification</name>
  <action>
AWS SES domain verification requires DNS record creation and 3-5 day propagation. This cannot be automated by Claude.

**What needs to happen:**

1. **Create email identity in AWS SES (Mumbai region):**

   ```bash
   aws sesv2 create-email-identity \
     --email-identity yourdomain.com \
     --region ap-south-1
   ```

2. **Get DKIM tokens:**

   ```bash
   aws sesv2 get-email-identity \
     --email-identity yourdomain.com \
     --region ap-south-1
   ```

3. **Add 3 CNAME records to DNS provider:**
   - Record name: `{token}._domainkey.yourdomain.com`
   - Record value: `{token}.dkim.amazonses.com`
   - CRITICAL: Do NOT add extra underscore prefix
   - Check if DNS provider auto-appends domain name

4. **Wait for DNS propagation (up to 72 hours)**

5. **Check verification status:**

   ```bash
   aws sesv2 get-email-identity \
     --email-identity yourdomain.com \
     --region ap-south-1 \
     | jq '.DkimAttributes.Status'
   ```

6. **Send test email after verification:**
   ```bash
   aws sesv2 send-email \
     --from-email-address noreply@yourdomain.com \
     --destination ToAddresses=your-email@example.com \
     --content "Simple={Subject={Data='AEGIS Test Email'},Body={Text={Data='AWS SES domain verification confirmed. Email sending from AEGIS is operational.'}}}" \
     --region ap-south-1
   ```

**If SES account is in sandbox mode:** Request production access via AWS Console > SES > Account Dashboard > Request Production Access. This may take 24-48 hours for AWS review.
</action>
<how-to-verify>

1. Run: `aws sesv2 get-email-identity --email-identity yourdomain.com --region ap-south-1 | jq '.DkimAttributes.Status'` returns "SUCCESS"
2. Test email received in inbox
3. If still in sandbox, confirm production access request submitted
   </how-to-verify>
   <resume-signal>Type "ses-verified" if domain verified and test email sent, "ses-pending" if DNS records added but waiting for propagation, or "ses-skip" to skip SES verification for now.</resume-signal>
   </task>

</tasks>

<verification>
- Permission guard tests exist and cover 4 roles
- AWS SES domain verification completed (or documented as pending with timeline)
</verification>

<success_criteria>

1. `tests/e2e/permission-guards.spec.ts` exists with role-based access tests for auditee, auditor, manager, and CAE
2. AWS SES domain verification: one of the following outcomes documented:
   - **ses-verified (IDEAL):** Domain verified, DKIM status SUCCESS, test email sent and received
   - **ses-pending:** DNS CNAME records added in ap-south-1, waiting for propagation (up to 72 hours) — Phase 14 marks the checkpoint, verification confirmed async
   - **ses-skip:** SES verification deferred with documented reason — does NOT satisfy Phase 14 success criteria #4 ("AWS SES domain verified and first test email sent successfully")
3. For ses-pending: plan 14-05 re-audit notes SES as the only outstanding item if not yet resolved
   </success_criteria>

<output>
After completion, create `.planning/phases/14-verification-production-readiness/14-04-SUMMARY.md`
</output>
