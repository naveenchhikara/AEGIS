---
phase: 08-notifications-reports
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - prisma/migrations/add_notification_tables.sql
  - src/lib/ses-client.ts
  - src/lib/job-queue.ts
  - src/instrumentation.ts
  - src/data-access/notifications.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "NotificationQueue model exists with batching support (batchKey, sendAfter) (NOTF-06)"
    - "EmailLog model exists for sent email audit trail"
    - "NotificationPreference model exists for per-user opt-in/out"
    - "BoardReport model exists with executiveCommentary and metricsSnapshot"
    - "NotificationType enum covers all 8 notification types"
    - "pg-boss initialized on app boot via instrumentation.ts"
    - "SES client configured for ap-south-1 (Mumbai) region"
    - "RLS policies exist for all new tables"
  artifacts:
    - path: prisma/schema.prisma
      provides: NotificationQueue, EmailLog, NotificationPreference, BoardReport models with enums
      contains: "model NotificationQueue"
    - path: prisma/migrations/add_notification_tables.sql
      provides: RLS policies, audit triggers, and indexes for notification tables
      min_lines: 25
    - path: src/lib/ses-client.ts
      provides: AWS SES v2 client singleton for ap-south-1
      min_lines: 20
      contains: "SESv2Client"
    - path: src/lib/job-queue.ts
      provides: pg-boss singleton with connection config
      min_lines: 25
      contains: "PgBoss"
    - path: src/instrumentation.ts
      provides: pg-boss worker startup on Next.js server boot
      min_lines: 10
    - path: src/data-access/notifications.ts
      provides: DAL for notification queue operations and preferences
      min_lines: 40
      contains: "createNotification"
  key_links:
    - from: job-queue.ts
      to: pg-boss
      via: PostgreSQL-based job queue (same DATABASE_URL)
      pattern: "PgBoss"
    - from: ses-client.ts
      to: "@aws-sdk/client-sesv2"
      via: SESv2Client for email sending
      pattern: "SESv2Client"
    - from: instrumentation.ts
      to: job-queue.ts
      via: Starts pg-boss workers on server boot
      pattern: "startWorkers"
---

<objective>
Set up the notification infrastructure: pg-boss job queue, AWS SES client, notification database models, and email rendering pipeline.

Purpose: This is the foundation for all email notifications, scheduled jobs, and report generation. pg-boss provides persistent job scheduling using the existing PostgreSQL database (no Redis). SES handles email delivery in Mumbai region. The notification queue model supports batching for bulk operations (NOTF-06).

Output: Prisma schema with 4 new models, pg-boss singleton, SES client, instrumentation hook, notification DAL.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-notifications-reports/08-PLAN.md
@prisma/schema.prisma
@src/instrumentation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add notification models to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add the following to the existing Prisma schema:

**1. Enums:**

```prisma
enum NotificationType {
  OBSERVATION_ASSIGNED
  RESPONSE_SUBMITTED
  DEADLINE_REMINDER_7D
  DEADLINE_REMINDER_3D
  DEADLINE_REMINDER_1D
  OVERDUE_ESCALATION
  WEEKLY_DIGEST
  BULK_DIGEST
  INVITATION
}

enum NotificationStatus {
  PENDING
  PROCESSING
  SENT
  FAILED
  SKIPPED
}
```

**2. NotificationQueue model:**

- id (UUID), tenantId, recipientId (User relation), type (NotificationType), status (NotificationStatus, default PENDING)
- batchKey (String?), sendAfter (DateTime, default now()) — for NOTF-06 batching
- payload (Json) — template variables
- retryCount (Int, default 0), lastError (String?), processedAt (DateTime?)
- createdAt, updatedAt
- Indexes: [tenantId], [status, sendAfter], [batchKey, status]

**3. EmailLog model:**

- id (UUID), tenantId, recipientEmail, recipientName?, subject, templateName
- sesMessageId?, status (String), notificationIds (String[])
- sentAt (DateTime, default now())
- Indexes: [tenantId], [recipientEmail], [sentAt]

**4. NotificationPreference model:**

- id (UUID), userId (unique), tenantId
- emailEnabled (Boolean, default true), digestPreference (String, default "immediate")
- createdAt, updatedAt
- Index: [tenantId]

**5. BoardReport model:**

- id (UUID), tenantId, year (Int), quarter (Quarter enum — reuse if exists, or add)
- title (String), executiveCommentary (String? @db.Text), s3Key (String?), fileSize (Int?)
- generatedById (String @db.Uuid), generatedAt (DateTime)
- metricsSnapshot (Json?)
- Indexes: [tenantId], [tenantId, year, quarter]

**6. Add Quarter enum if not exists:**

```prisma
enum Quarter {
  Q1
  Q2
  Q3
  Q4
}
```

**7. Add relations** on User and Tenant for new models.
</action>
<verify>Run `pnpm prisma validate` and `pnpm prisma generate` to confirm schema is valid.</verify>
<done>Prisma schema has NotificationQueue, EmailLog, NotificationPreference, BoardReport models with all enums and indexes.</done>
</task>

<task type="auto">
  <name>Task 2: Create migration SQL for RLS and audit triggers</name>
  <files>prisma/migrations/add_notification_tables.sql</files>
  <action>
Create migration SQL:

- RLS enable + force on NotificationQueue, EmailLog, NotificationPreference, BoardReport
- Tenant isolation policies (USING tenantId = current_setting)
- GRANT permissions to aegis_app role
- Attach audit_trigger_function to all 4 new tables
- Processing index: `(status, sendAfter)` on NotificationQueue
- Batch index: `(batchKey, status)` on NotificationQueue
  </action>
  <verify>SQL file has valid syntax. All 4 tables have RLS policies and audit triggers.</verify>
  <done>Migration SQL with RLS policies, audit triggers, and processing indexes for all notification tables.</done>
  </task>

<task type="auto">
  <name>Task 3: Create SES client and pg-boss singleton</name>
  <files>src/lib/ses-client.ts, src/lib/job-queue.ts, src/instrumentation.ts</files>
  <action>
**1. ses-client.ts:**

```typescript
import "server-only";
import { SESv2Client, SendEmailCommand } from "@aws-sdk/client-sesv2";
```

- Singleton SESv2Client for ap-south-1 region
- `sendEmail(to, subject, htmlBody, textBody?)` function
- Sender: `process.env.SES_FROM_EMAIL` (default: `noreply@aegis.in`)
- Returns SES message ID on success, error on failure
- Handles SES errors gracefully (throttle, bounce, etc.)

**2. job-queue.ts:**

```typescript
import "server-only";
import PgBoss from "pg-boss";
```

- Singleton pg-boss instance using `process.env.DATABASE_URL`
- `getJobQueue()` function returns initialized pg-boss instance
- Lazy initialization (create on first call)
- `startWorkers()` function to register all job handlers
- `stopWorkers()` for graceful shutdown

**3. instrumentation.ts:**

Next.js instrumentation hook (runs once on server start):

```typescript
export async function register() {
  if (process.env.NEXT_RUNTIME === "nodejs") {
    const { startWorkers } = await import("./lib/job-queue");
    await startWorkers();
  }
}
```

Only starts in Node.js runtime (not Edge).
</action>
<verify>Run `pnpm build` to confirm TypeScript compilation. Verify ses-client.ts and job-queue.ts import `server-only`. Verify instrumentation.ts checks for nodejs runtime.</verify>
<done>SES client singleton configured for Mumbai. pg-boss singleton using same DATABASE_URL. Instrumentation hook starts workers on server boot.</done>
</task>

<task type="auto">
  <name>Task 4: Create notification data access layer</name>
  <files>src/data-access/notifications.ts</files>
  <action>
Create `src/data-access/notifications.ts` with `import "server-only"`:

**1. createNotification(tenantId, recipientId, type, payload, batchKey?):**

- Creates NotificationQueue record
- If batchKey provided, sets sendAfter = now + 5 minutes (batching window)
- Returns created notification

**2. getNotificationPreferences(userId):**

- Fetch or create default preferences for user
- Returns NotificationPreference

**3. updateNotificationPreferences(userId, prefs):**

- Update emailEnabled and digestPreference
- Validate: CAE/CCO cannot disable weekly digest (regulatory)

**4. getPendingNotifications(limit = 100):**

- Query NotificationQueue where status = PENDING and sendAfter <= now
- Order by createdAt ASC
- Used by notification processor job

**5. markNotificationSent(id, sesMessageId):**

- Update status to SENT, set processedAt
- Create EmailLog record

**6. markNotificationFailed(id, error):**

- Update status to FAILED, increment retryCount, set lastError
- If retryCount < 3: set sendAfter to exponential backoff and reset status to PENDING
  </action>
  <verify>Run `pnpm build` to confirm TypeScript compilation. Verify all 6 DAL functions exist. Verify createNotification supports batchKey for batching.</verify>
  <done>Notification DAL provides queue management, preference handling, and processing lifecycle functions.</done>
  </task>

</tasks>

<verification>
1. `pnpm prisma validate` passes
2. `pnpm prisma generate` succeeds
3. `pnpm build` succeeds
4. NotificationQueue has batching support (batchKey, sendAfter)
5. pg-boss starts on server boot via instrumentation.ts
6. SES client configured for ap-south-1
7. All new tables have RLS policies and audit triggers
8. Notification DAL supports create, process, batch, retry lifecycle
</verification>

<success_criteria>

- pg-boss job queue operational using same PostgreSQL (no Redis)
- SES client ready for email sending in Mumbai region
- NotificationQueue supports batching for bulk operations (NOTF-06)
- All new tables tenant-isolated via RLS
- Notification DAL provides complete queue lifecycle
- Instrumentation hook starts workers on server boot
  </success_criteria>

<output>
After completion, create `.planning/phases/08-notifications-reports/08-01-SUMMARY.md`
</output>
