---
phase: 07-auditee-portal-evidence
plan: 03
type: execute
wave: 1
depends_on: [07-01]
files_modified:
  - src/data-access/auditee.ts
  - src/actions/auditee.ts
autonomous: true

must_haves:
  truths:
    - "getObservationsForAuditee returns branch-scoped observations with cursor-based pagination (AUD-01)"
    - "getObservationDetail returns observation with timeline, evidence, and auditee responses"
    - "submitAuditeeResponse creates immutable AuditeeResponse record + ObservationTimeline entry (AUD-02, AUD-04)"
    - "requestEvidenceUpload validates file type via magic bytes and returns presigned PUT URL (AUD-03, EVID-03)"
    - "confirmEvidenceUpload verifies S3 upload via HeadObject and creates Evidence record in transaction (EVID-01)"
    - "getEvidenceDownloadUrl returns presigned GET URL with authorization check (EVID-05)"
    - "All actions derive userId and tenantId from session — never from client input"
    - "Evidence count per observation capped at 20 with atomic check in transaction"
  artifacts:
    - path: src/data-access/auditee.ts
      provides: DAL functions for auditee-scoped observation queries with branch filtering
      min_lines: 60
      contains: "getObservationsForAuditee"
    - path: src/actions/auditee.ts
      provides: Server actions for auditee response submission and evidence upload
      min_lines: 120
      contains: "submitAuditeeResponse"
  key_links:
    - from: auditee.ts (DAL)
      to: UserBranchAssignment
      via: Query user's branches then filter observations
      pattern: "UserBranchAssignment"
    - from: auditee.ts (actions)
      to: src/lib/s3.ts
      via: Presigned URL generation and upload verification
      pattern: "generateUploadUrl"
    - from: auditee.ts (actions)
      to: ObservationTimeline
      via: Creates timeline entries for responses and evidence uploads
      pattern: "ObservationTimeline"
---

<objective>
Create server actions and data access layer for the auditee portal: branch-scoped observation queries, auditee response submission, evidence upload flow, and evidence download.

Purpose: These are the core server-side functions that power the auditee portal. All functions enforce branch-scoped access (auditees only see observations for their assigned branches), response immutability (no edit/delete), and evidence security (magic byte validation, presigned URLs, atomic count checks).

Output: `src/data-access/auditee.ts` (DAL) and `src/actions/auditee.ts` (server actions).
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-auditee-portal-evidence/07-PLAN.md
@.planning/phases/07-auditee-portal-evidence/07-01-PLAN.md
@.planning/phases/07-auditee-portal-evidence/07-02-PLAN.md
@src/data-access/session.ts
@src/lib/s3.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auditee data access layer</name>
  <files>src/data-access/auditee.ts</files>
  <action>
Create `src/data-access/auditee.ts` with `import "server-only"`:

**1. getUserBranches(session):**

- Query `UserBranchAssignment` for session user's branchIds
- Returns `string[]` of branchIds
- Uses `prismaForTenant()` with session's tenantId

**2. getObservationsForAuditee(session, cursor?, limit = 50):**

- Get user's branchIds via `getUserBranches()`
- Query Observation where `branchId IN [branchIds]` and status IN [ISSUED, RESPONSE, COMPLIANCE, CLOSED]
- Include: branch (name), assignedTo (name), severity, status, dueDate, responseDueDate
- Cursor-based pagination: `cursor` is last observation ID, use `skip: 1, cursor: { id }` pattern
- Order by: dueDate ASC (urgent items first), then createdAt DESC
- Returns `{ observations, nextCursor }`

**3. getObservationDetailForAuditee(session, observationId):**

- Fetch observation by ID with includes: branch, auditArea, assignedTo, timeline (ordered by createdAt ASC), evidence (where deletedAt is null), auditeeResponses (ordered by createdAt ASC), rbiCirculars
- Verify observation's branchId is in user's assigned branches — return null if not authorized
- Returns full observation or null

**All functions:** Use `getRequiredSession()` pattern, `prismaForTenant()`, and belt-and-suspenders WHERE tenantId clause.
</action>
<verify>Run `pnpm build` to confirm TypeScript compilation. Verify file imports `server-only`. Verify all 3 DAL functions exist.</verify>
<done>Auditee DAL provides branch-scoped observation queries with cursor pagination, detail fetch with authorization check.</done>
</task>

<task type="auto">
  <name>Task 2: Create auditee server actions</name>
  <files>src/actions/auditee.ts</files>
  <action>
Create `src/actions/auditee.ts` with `"use server"`:

**1. submitAuditeeResponse(formData):**

- Zod validation: observationId (uuid), content (min 10 chars), responseType (ResponseType enum)
- Verify session has AUDITEE role
- Verify observation is in ISSUED or RESPONSE status
- Verify observation's branchId is in user's assigned branches
- Inside Prisma transaction:
  - Create AuditeeResponse record (immutable — createdAt only)
  - Create ObservationTimeline entry: event = "auditee_response", newValue = responseType
  - Update Observation status to RESPONSE if currently ISSUED (first response triggers transition)
  - Log to AuditLog
- `revalidatePath("/auditee")`

**2. requestEvidenceUpload(formData):**

- Zod validation: observationId (uuid), fileHeader (base64 string), fileName (string), fileSize (number, max 10MB)
- Verify session has AUDITEE role
- Verify observation branch authorization
- Validate file type via `validateFileType(fileHeader)` from s3.ts
- Pre-check evidence count < 20 for this observation
- Generate S3 key via `generateS3Key()`
- Generate presigned PUT URL via `generateUploadUrl()`
- Return `{ presignedUrl, s3Key, contentType }`

**3. confirmEvidenceUpload(formData):**

- Zod validation: s3Key, observationId, filename, fileSize, contentType
- Verify session has AUDITEE role
- Verify S3 file exists via `verifyUpload(s3Key)`
- Inside Prisma transaction:
  - Count existing evidence for observation — reject if >= 20 (atomic race condition prevention)
  - Create Evidence record
  - Create ObservationTimeline entry: event = "evidence_uploaded"
  - Log to AuditLog
- `revalidatePath("/auditee")`

**4. getEvidenceDownloadUrl(evidenceId):**

- Verify session (any authenticated role — not just AUDITEE)
- Fetch evidence record, verify tenant matches
- If user is AUDITEE, also verify branch authorization
- Generate presigned GET URL via `generateDownloadUrl()`
- Return `{ downloadUrl }`

**All actions:** Return `{ success, data?, error? }` pattern. Never throw — return error objects. Derive userId/tenantId from session ONLY.
</action>
<verify>Run `pnpm build` to confirm TypeScript compilation. Verify all 4 server actions exist. Verify no action accepts userId as parameter.</verify>
<done>Auditee server actions handle response submission, evidence upload flow (request → confirm), and evidence download with branch-scoped authorization.</done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds
2. DAL functions use `prismaForTenant()` and belt-and-suspenders WHERE tenantId
3. All actions verify AUDITEE role from session
4. All actions verify branch authorization via UserBranchAssignment
5. submitAuditeeResponse creates immutable record (no updatedAt)
6. Evidence count check is inside transaction (atomic)
7. No action accepts userId or tenantId as client input
8. Timeline events use stable event values: "auditee_response", "evidence_uploaded"
</verification>

<success_criteria>

- Branch-scoped access enforced at every query (AUD-01)
- Auditee responses are immutable (AUD-04)
- Evidence upload flow: validate → presign → upload → confirm (EVID-01)
- Magic byte validation prevents disguised file types (EVID-03)
- Evidence count capped at 20 per observation with atomic check
- All operations logged to AuditLog
- Timeline entries use Phase 8 contract event values
  </success_criteria>

<output>
After completion, create `.planning/phases/07-auditee-portal-evidence/07-03-SUMMARY.md`
</output>
