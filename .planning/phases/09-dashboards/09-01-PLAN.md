---
phase: 09-dashboards
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/fiscal-year.ts
  - src/lib/dashboard-config.ts
  - src/components/dashboard/dashboard-skeleton.tsx
  - src/components/dashboard/empty-state-card.tsx
  - src/components/dashboard/fiscal-year-selector.tsx
  - src/providers/query-provider.tsx
  - src/app/(dashboard)/layout.tsx
  - prisma/migrations/YYYYMMDD_dashboard_views.sql
  - package.json
autonomous: true

must_haves:
  truths:
    - "Indian fiscal year utilities: getCurrentFiscalYear(), getCurrentQuarter(), getFiscalYearDateRange()"
    - "Dashboard config maps roles to widget sets with multi-role deduplication via WIDGET_PRIORITY"
    - "@tanstack/react-query installed and QueryClientProvider wraps dashboard layout"
    - "PostgreSQL views: v_compliance_summary, v_observation_aging, v_observation_severity, v_audit_coverage_branch, v_auditor_workload"
    - "fn_extract_fiscal_year(DATE) and fn_dashboard_health_score(UUID) PostgreSQL functions created"
    - "Dashboard skeleton components for card, chart, and table loading states"
    - "Empty state card with configurable message and action link"
    - "FY quarter selector component for date-based widget filtering"
  artifacts:
    - path: src/lib/fiscal-year.ts
      provides: Indian fiscal year utility functions (Apr-Mar)
      min_lines: 30
      contains: "getCurrentFiscalYear"
    - path: src/lib/dashboard-config.ts
      provides: Role-to-widget mapping with priority ordering for multi-role dedup
      min_lines: 60
      contains: "WIDGET_PRIORITY"
    - path: src/providers/query-provider.tsx
      provides: React Query QueryClientProvider wrapper for dashboard
      min_lines: 10
      contains: "QueryClientProvider"
    - path: prisma/migrations/YYYYMMDD_dashboard_views.sql
      provides: PostgreSQL views and functions for dashboard aggregation
      min_lines: 80
      contains: "fn_dashboard_health_score"
    - path: src/components/dashboard/dashboard-skeleton.tsx
      provides: Loading skeleton components for dashboard widgets
      min_lines: 30
      contains: "DashboardSkeleton"
    - path: src/components/dashboard/empty-state-card.tsx
      provides: Empty/zero state card with guidance
      min_lines: 20
      contains: "EmptyStateCard"
  key_links:
    - from: dashboard-config.ts
      to: src/lib/permissions.ts
      via: Maps Role enum values to widget configurations
      pattern: "ROLE_WIDGETS"
    - from: query-provider.tsx
      to: src/app/(dashboard)/layout.tsx
      via: Wraps dashboard pages with QueryClientProvider
      pattern: "QueryProvider"
    - from: fiscal-year.ts
      to: prisma/migrations SQL
      via: Same FY logic in both TypeScript and PostgreSQL
      pattern: "fn_extract_fiscal_year"
---

<objective>
Create dashboard infrastructure: Indian fiscal year utilities, role-to-widget configuration, React Query provider, PostgreSQL views/functions for aggregation, and shared UI primitives (skeletons, empty states, FY selector).

Purpose: This plan builds the foundation layer that all dashboard widgets and the dashboard page depend on. PostgreSQL views pre-aggregate data for fast queries. The widget config system determines which widgets each role (including multi-role users) sees.

Output: 1 fiscal year utility, 1 dashboard config, 1 React Query provider, 1 SQL migration with 5 views + 2 functions, 3 shared UI components.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-dashboards/09-PLAN.md
@src/lib/permissions.ts
@src/app/(dashboard)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install React Query and create provider + fiscal year utilities</name>
  <files>package.json, src/providers/query-provider.tsx, src/app/(dashboard)/layout.tsx, src/lib/fiscal-year.ts</files>
  <action>
**1. Install @tanstack/react-query:**

`pnpm add @tanstack/react-query`

**2. query-provider.tsx:**

Client component wrapping `QueryClientProvider`:

- Create QueryClient with defaults: `staleTime: 30_000`, `gcTime: 5 * 60_000`
- Export `QueryProvider` component wrapping children
- Used only in dashboard layout (not auth pages)

**3. layout.tsx update:**

Wrap dashboard content with `<QueryProvider>`:

```typescript
<QueryProvider>
  {/* existing SidebarProvider + content */}
</QueryProvider>
```

**4. fiscal-year.ts:**

Indian fiscal year utility functions (Apr-Mar):

- `getCurrentFiscalYear()`: Returns `{ year: number; label: string }` — Feb 2026 → `{ year: 2025, label: "2025-26" }`
- `getCurrentQuarter()`: Returns Quarter enum value — Feb 2026 → `Q4_JAN_MAR`
- `getFiscalYearDateRange(startYear)`: Returns `{ start: Date; end: Date }` — 2025 → Apr 1 2025 to Mar 31 2026
- `getQuarterLabel(quarter)`: Returns display string — `Q4_JAN_MAR` → "Q4 (Jan-Mar)"
- `getQuarterDateRange(year, quarter)`: Returns date range for specific quarter
- Use Month >= 4 (April) as FY start boundary

  </action>
  <verify>Run `pnpm build`. Verify @tanstack/react-query in package.json. Verify QueryProvider wraps dashboard layout. Verify fiscal year functions handle all 4 quarters correctly.</verify>
  <done>React Query installed and wired into dashboard layout. Indian fiscal year utilities with all 5 functions.</done>
</task>

<task type="auto">
  <name>Task 2: Create dashboard configuration and shared UI components</name>
  <files>src/lib/dashboard-config.ts, src/components/dashboard/dashboard-skeleton.tsx, src/components/dashboard/empty-state-card.tsx, src/components/dashboard/fiscal-year-selector.tsx</files>
  <action>
**1. dashboard-config.ts:**

Role-to-widget mapping with multi-role deduplication:

- `ROLE_WIDGETS` object: maps each role (AUDITOR, AUDIT_MANAGER, CAE, CCO, CEO) to array of widget IDs
- `WIDGET_PRIORITY` array: ordered list defining render priority when merging multi-role widgets (health-score first, then compliance, coverage, risk, role-specific, quick-actions)
- `WidgetConfig` interface: `{ id: string; size: 'full' | 'half' | 'third'; dataKey: string; pollingInterval: number; component: string }`
- `WIDGET_METADATA` map: widget ID → WidgetConfig with size, polling interval, data key
- `getDashboardConfig(roles: string[])`: Takes user's roles, merges widget sets, deduplicates by widget ID, sorts by WIDGET_PRIORITY, returns ordered WidgetConfig[]

**2. dashboard-skeleton.tsx:**

Loading skeleton components matching widget dimensions:

- `CardSkeleton`: Shimmer card (for KPI cards)
- `ChartSkeleton`: Shimmer area matching chart dimensions (half width)
- `TableSkeleton`: Shimmer rows (full width)
- `DashboardSkeleton`: Renders appropriate skeleton per widget size

**3. empty-state-card.tsx:**

Zero-data state component:

- Props: `title: string`, `message: string`, `actionLabel?: string`, `actionHref?: string`, `icon?: ReactNode`
- Displays helpful guidance with optional CTA button
- Uses existing shadcn Card component

**4. fiscal-year-selector.tsx:**

FY quarter picker (client component):

- Dropdown with current FY + previous FY
- Quarter tabs: Q1, Q2, Q3, Q4 with date ranges
- `onChange` callback with `{ year: number; quarter: Quarter | null }` (null = full year)
- Default: current FY, current quarter selected
  </action>
  <verify>Run `pnpm build`. Verify dashboard-config handles multi-role dedup. Verify skeleton and empty state components render. Verify FY selector defaults to current period.</verify>
  <done>Dashboard config with role-widget mapping and multi-role dedup. Skeleton, empty state, and fiscal year selector UI components.</done>
  </task>

<task type="auto">
  <name>Task 3: Create PostgreSQL views and functions for dashboard aggregation</name>
  <files>prisma/migrations/YYYYMMDD_dashboard_views.sql</files>
  <action>
**Create SQL migration with views and functions:**

**1. fn_extract_fiscal_year(DATE):**

Indian FY extraction: month >= 4 → current year, else previous year. Mark as IMMUTABLE.

**2. v_compliance_summary:**

Per-tenant compliance status counts: total, compliant, partial, non_compliant, pending, compliance_percentage.

**3. v_observation_aging:**

Per-tenant observation aging buckets: total_open, current_count (not yet due), bucket_0_30, bucket_31_60, bucket_61_90, bucket_90_plus.

**4. v_observation_severity:**

Per-tenant severity distribution: total, total_open, critical_open, high_open, medium_open, low_open, closed.

**5. v_audit_coverage_branch:**

Per-branch audit coverage for current FY only (uses fn_extract_fiscal_year). Columns: tenant_id, branch_id, branch_name, completed_engagements, total_engagements, is_covered.

**6. v_auditor_workload:**

Per-auditor observation counts: tenant_id, assigned_to_id, auditor_name, total_assigned, open_count, high_critical_open.

**7. fn_dashboard_health_score(UUID):**

Weighted health score function using 3 component views:

- Compliance Score (40%): from v_compliance_summary
- Finding Resolution Score (35%): 100 minus penalties (Critical: -15, High: -8, Medium: -3, Low: -1, cap at 0)
- Audit Coverage Score (25%): from v_audit_coverage_branch (covered/total branches)
- Returns NUMERIC rounded to 0 decimal places
- Mark as STABLE

All views use `CREATE OR REPLACE VIEW`. Functions use `CREATE OR REPLACE FUNCTION`.
</action>
<verify>Run `pnpm build`. Verify SQL file has all 5 views and 2 functions. Verify fn_dashboard_health_score uses correct weights (0.40, 0.35, 0.25). Verify v_audit_coverage_branch filters by current fiscal year.</verify>
<done>PostgreSQL views for compliance, aging, severity, coverage, workload. Health score function with weighted formula. Fiscal year extraction function.</done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds
2. @tanstack/react-query installed and QueryProvider wraps dashboard layout
3. Fiscal year utilities handle Indian FY (Apr-Mar) correctly
4. Dashboard config handles multi-role users (CAE+CCO merge, deduplicate, prioritize)
5. 5 PostgreSQL views created for dashboard aggregation
6. Health score function implements correct formula (40/35/25 weights)
7. fn_extract_fiscal_year handles Jan-Mar → previous year correctly
8. Skeleton and empty state components render appropriately
9. FY quarter selector defaults to current period
</verification>

<success_criteria>

- Indian fiscal year utilities correctly identify FY 2025-26 for Feb 2026
- Dashboard config merges multi-role widget sets with dedup (DASH-06)
- React Query provider wraps dashboard pages only
- PostgreSQL views provide fast aggregation for all dashboard data needs
- Health score formula: (Compliance×0.40) + (FindingResolution×0.35) + (AuditCoverage×0.25)
- Shared UI primitives (skeleton, empty state, FY selector) ready for widget use
  </success_criteria>

<output>
After completion, create `.planning/phases/09-dashboards/09-01-SUMMARY.md`
</output>
