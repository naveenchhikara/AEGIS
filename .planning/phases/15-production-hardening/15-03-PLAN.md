---
phase: 15-production-hardening
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/current-user.ts
  - src/components/layout/top-bar.tsx
autonomous: true

must_haves:
  truths:
    - "top-bar.tsx uses Better Auth session instead of hardcoded currentUser"
    - "src/lib/current-user.ts is deleted (no file on disk)"
    - "Sign-out button calls Better Auth signOut and redirects to /login"
  artifacts:
    - path: "src/components/layout/top-bar.tsx"
      provides: "TopBar using Better Auth session for user identity and sign-out"
      contains: "useSession"
  key_links:
    - from: "src/components/layout/top-bar.tsx"
      to: "src/lib/auth-client.ts"
      via: "authClient.useSession() and signOut()"
      pattern: "useSession|signOut"
---

<objective>
Replace hardcoded currentUser with Better Auth session in top-bar.tsx and delete the legacy current-user.ts module.

Purpose: Eliminate hardcoded demo user identity from runtime code. The TopBar must show the real authenticated user's name and initials, and sign-out must actually terminate the auth session.
Output: top-bar.tsx using Better Auth session, current-user.ts deleted.
</objective>

<execution_context>
@/Users/admin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/admin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-production-hardening/15-RESEARCH.md
@src/lib/current-user.ts
@src/components/layout/top-bar.tsx
@src/lib/auth-client.ts

NOTE: This plan assumes Better Auth infrastructure from Phase 5/11 exists (auth-client.ts with useSession, signOut exports).
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace currentUser with Better Auth session in top-bar.tsx and delete current-user.ts</name>
  <files>
    src/components/layout/top-bar.tsx
    src/lib/current-user.ts
  </files>
  <action>
    1. Update `src/components/layout/top-bar.tsx`:
       - Remove imports: `import { currentUser } from "@/lib/current-user"` and `import { bankProfile } from "@/data"`
       - Remove: `const bank = bankProfile as unknown as BankProfile` and `import type { BankProfile } from "@/types"`
       - Add import: `import { authClient } from "@/lib/auth-client"`
       - Inside TopBar component, add: `const { data: session } = authClient.useSession();`
       - Replace `currentUser.initials` with computed initials from session:
         ```typescript
         const userInitials = session?.user?.name
           ? session.user.name.split(" ").map((n: string) => n[0]).join("")
           : "?";
         ```
       - Replace `currentUser.name` with `session?.user?.name ?? "User"`
       - Replace `currentUser.role` with `session?.user?.role ?? ""`
       - For the bank name in the header breadcrumb: the bank name should come from session context (tenant name). Since the session may not include tenant name directly, use a fallback approach:
         - If session.user has a tenantName or organization field, use it
         - Otherwise, remove the hardcoded bank name display (it was only demo data)
         - The breadcrumb should show current page name only (bank name can be added later when tenant context is available in session)
       - Replace the sign-out link (`<Link href="/login">`) with an actual sign-out button:
         ```typescript
         import { signOut } from "@/lib/auth-client";
         // ...
         onClick={async () => { await signOut(); window.location.href = "/login"; }}
         ```
         NOTE: `signOut` is exported directly from auth-client.ts as a standalone function (destructured from authClient). Call it as `await signOut()` — do NOT use `authClient.signOut({ fetchOptions: ... })` which is not the correct API.
       - Keep the "use client" directive (already present), locale switcher, and notification bell as-is

    2. Delete `src/lib/current-user.ts` entirely.
       - Verify no other files import from it first: only top-bar.tsx imports it (confirmed by grep)

    IMPORTANT: The top-bar.tsx is a "use client" component. authClient.useSession() works in client components.
    Do NOT import server-side auth — use the client auth module at src/lib/auth-client.ts.

  </action>
  <verify>
    - `pnpm tsc --noEmit` passes
    - `! test -f src/lib/current-user.ts` — file is deleted
    - `grep "currentUser" src/components/layout/top-bar.tsx` returns NO matches
    - `grep "authClient\|useSession\|signOut" src/components/layout/top-bar.tsx` returns matches
    - `pnpm build` succeeds — app compiles without current-user.ts
  </verify>
  <done>
    top-bar.tsx uses Better Auth session for user identity and signOut() for logout. currentUser.ts is deleted. No hardcoded demo user in the application.
  </done>
</task>

</tasks>

<verification>
1. `pnpm tsc --noEmit` — no type errors
2. `pnpm build` — succeeds
3. `! test -f src/lib/current-user.ts` — currentUser.ts deleted
4. `grep "currentUser" src/components/layout/top-bar.tsx` — no matches
5. `grep "useSession" src/components/layout/top-bar.tsx` — has matches
6. `grep "signOut" src/components/layout/top-bar.tsx` — has matches
</verification>

<success_criteria>

- currentUser.ts is deleted, top-bar.tsx uses Better Auth session
- Sign-out calls signOut() and redirects to /login
- No type errors, build succeeds
  </success_criteria>

<output>
After completion, create `.planning/phases/15-production-hardening/15-03-SUMMARY.md`
</output>
